(function(ce,oe){typeof exports=="object"&&typeof module<"u"?oe(exports):typeof define=="function"&&define.amd?define(["exports"],oe):(ce=typeof globalThis<"u"?globalThis:ce||self,oe(ce.UnicornStudio={}))})(this,function(ce){"use strict";var Hs=Object.defineProperty;var Gs=(ce,oe,z)=>oe in ce?Hs(ce,oe,{enumerable:!0,configurable:!0,writable:!0,value:z}):ce[oe]=z;var fe=(ce,oe,z)=>(Gs(ce,typeof oe!="symbol"?oe+"":oe,z),z);let oe=0;function z(){if(!(oe>100)){if(oe===100)console.warn("Curtains: too many warnings thrown, stop logging.");else{const f=Array.prototype.slice.call(arguments);console.warn.apply(console,f)}oe++}}function ne(){const f=Array.prototype.slice.call(arguments);console.error.apply(console,f)}function ot(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,f=>{let e=Math.random()*16|0;return(f==="x"?e:e&3|8).toString(16).toUpperCase()})}function be(f){return(f&f-1)===0}function li(f,e,t){return(1-t)*f+t*e}let oi=class{constructor(e){if(this.type="Scene",!e||e.type!=="Renderer")ne(this.type+": Renderer not passed as first argument",e);else if(!e.gl){ne(this.type+": Renderer WebGL context is undefined",e);return}this.renderer=e,this.gl=e.gl,this.initStacks()}initStacks(){this.stacks={pingPong:[],renderTargets:[],opaque:[],transparent:[],renderPasses:[],scenePasses:[]}}resetPlaneStacks(){this.stacks.pingPong=[],this.stacks.renderTargets=[],this.stacks.opaque=[],this.stacks.transparent=[];for(let e=0;e<this.renderer.planes.length;e++)this.addPlane(this.renderer.planes[e])}resetShaderPassStacks(){this.stacks.scenePasses=[],this.stacks.renderPasses=[];for(let e=0;e<this.renderer.shaderPasses.length;e++)this.renderer.shaderPasses[e].index=e,this.renderer.shaderPasses[e]._isScenePass?this.stacks.scenePasses.push(this.renderer.shaderPasses[e]):this.stacks.renderPasses.push(this.renderer.shaderPasses[e]);this.stacks.scenePasses.length===0&&(this.renderer.state.scenePassIndex=null)}addToRenderTargetsStack(e){const t=this.renderer.planes.filter(s=>s.type!=="PingPongPlane"&&s.target&&s.uuid!==e.uuid);let i=-1;if(e.target._depth){for(let s=t.length-1;s>=0;s--)if(t[s].target.uuid===e.target.uuid){i=s+1;break}}else i=t.findIndex(s=>s.target.uuid===e.target.uuid);i=Math.max(0,i),t.splice(i,0,e),e.target._depth?(t.sort((s,a)=>s.index-a.index),t.sort((s,a)=>a.renderOrder-s.renderOrder)):(t.sort((s,a)=>a.index-s.index),t.sort((s,a)=>s.renderOrder-a.renderOrder)),t.sort((s,a)=>s.target.index-a.target.index),this.stacks.renderTargets=t}addToRegularPlaneStack(e){const t=this.renderer.planes.filter(s=>s.type!=="PingPongPlane"&&!s.target&&s._transparent===e._transparent&&s.uuid!==e.uuid);let i=-1;for(let s=t.length-1;s>=0;s--)if(t[s]._geometry.definition.id===e._geometry.definition.id){i=s+1;break}return i=Math.max(0,i),t.splice(i,0,e),t.sort((s,a)=>s.index-a.index),t}addPlane(e){if(e.type==="PingPongPlane")this.stacks.pingPong.push(e);else if(e.target)this.addToRenderTargetsStack(e);else if(e._transparent){const t=this.addToRegularPlaneStack(e);t.sort((i,s)=>s.relativeTranslation.z-i.relativeTranslation.z),t.sort((i,s)=>s.renderOrder-i.renderOrder),this.stacks.transparent=t}else{const t=this.addToRegularPlaneStack(e);t.sort((i,s)=>s.renderOrder-i.renderOrder),this.stacks.opaque=t}}removePlane(e){e.type==="PingPongPlane"?this.stacks.pingPong=this.stacks.pingPong.filter(t=>t.uuid!==e.uuid):e.target?this.stacks.renderTargets=this.stacks.renderTargets.filter(t=>t.uuid!==e.uuid):e._transparent?this.stacks.transparent=this.stacks.transparent.filter(t=>t.uuid!==e.uuid):this.stacks.opaque=this.stacks.opaque.filter(t=>t.uuid!==e.uuid)}setPlaneRenderOrder(e){if(e.type==="ShaderPass")this.sortShaderPassStack(e._isScenePass?this.stacks.scenePasses:this.stacks.renderPasses);else if(e.type==="PingPongPlane")return;if(e.target)e.target._depth?(this.stacks.renderTargets.sort((t,i)=>t.index-i.index),this.stacks.renderTargets.sort((t,i)=>i.renderOrder-t.renderOrder)):(this.stacks.renderTargets.sort((t,i)=>i.index-t.index),this.stacks.renderTargets.sort((t,i)=>t.renderOrder-i.renderOrder)),this.stacks.renderTargets.sort((t,i)=>t.target.index-i.target.index);else{const t=e._transparent?this.stacks.transparent:this.stacks.opaque,i=this.stacks.scenePasses.find((s,a)=>s._isScenePass&&!s._depth&&a===0);!this.renderer.depth||i?(t.sort((s,a)=>a.index-s.index),e._transparent&&t.sort((s,a)=>s.relativeTranslation.z-a.relativeTranslation.z),t.sort((s,a)=>s.renderOrder-a.renderOrder)):(t.sort((s,a)=>s.index-a.index),e._transparent&&t.sort((s,a)=>a.relativeTranslation.z-s.relativeTranslation.z),t.sort((s,a)=>a.renderOrder-s.renderOrder))}}addShaderPass(e){e._isScenePass?(this.stacks.scenePasses.push(e),this.sortShaderPassStack(this.stacks.scenePasses)):(this.stacks.renderPasses.push(e),this.sortShaderPassStack(this.stacks.renderPasses))}removeShaderPass(e){this.resetShaderPassStacks()}sortShaderPassStack(e){e.sort((t,i)=>t.index-i.index),e.sort((t,i)=>t.renderOrder-i.renderOrder)}enableShaderPass(){this.stacks.scenePasses.length&&this.stacks.renderPasses.length===0&&this.renderer.planes.length&&(this.renderer.state.scenePassIndex=0,this.renderer.bindFrameBuffer(this.stacks.scenePasses[0].target))}drawRenderPasses(){this.stacks.scenePasses.length&&this.stacks.renderPasses.length&&this.renderer.planes.length&&(this.renderer.state.scenePassIndex=0,this.renderer.bindFrameBuffer(this.stacks.scenePasses[0].target));for(let e=0;e<this.stacks.renderPasses.length;e++)this.stacks.renderPasses[e]._startDrawing(),this.renderer.clearDepth()}drawScenePasses(){for(let e=0;e<this.stacks.scenePasses.length;e++)this.stacks.scenePasses[e]._startDrawing()}drawPingPongStack(){for(let e=0;e<this.stacks.pingPong.length;e++){const t=this.stacks.pingPong[e];t&&t._startDrawing()}}drawStack(e){for(let t=0;t<this.stacks[e].length;t++){const i=this.stacks[e][t];i&&i._startDrawing()}}draw(){this.drawPingPongStack(),this.enableShaderPass(),this.drawStack("renderTargets"),this.drawRenderPasses(),this.renderer.setBlending(!1),this.drawStack("opaque"),this.stacks.transparent.length&&(this.renderer.setBlending(!0),this.drawStack("transparent")),this.drawScenePasses()}};class di{constructor(){this.geometries=[],this.clear()}clear(){this.textures=[],this.programs=[]}getGeometryFromID(e){return this.geometries.find(t=>t.id===e)}addGeometry(e,t,i){this.geometries.push({id:e,vertices:t,uvs:i})}isSameShader(e,t){return e.localeCompare(t)===0}getProgramFromShaders(e,t){return this.programs.find(i=>this.isSameShader(i.vsCode,e)&&this.isSameShader(i.fsCode,t))}addProgram(e){this.programs.push(e)}getTextureFromSource(e){const t=typeof e=="string"?e:e.src;return this.textures.find(i=>i.source&&i.source.src===t)}addTexture(e){this.getTextureFromSource(e.source)||this.textures.push(e)}removeTexture(e){this.textures=this.textures.filter(t=>t.uuid!==e.uuid)}}class ci{constructor(){this.clear()}clear(){this.queue=[]}add(e,t=!1){const i={callback:e,keep:t,timeout:null};return i.timeout=setTimeout(()=>{this.queue.push(i)},0),i}execute(){this.queue.map(e=>{e.callback&&e.callback(),clearTimeout(this.queue.timeout)}),this.queue=this.queue.filter(e=>e.keep)}}class ui{constructor({alpha:e,antialias:t,premultipliedAlpha:i,depth:s,failIfMajorPerformanceCaveat:a,preserveDrawingBuffer:l,stencil:u,container:p,pixelRatio:m,renderingScale:x,production:w,onError:E,onSuccess:T,onContextLost:F,onContextRestored:L,onDisposed:V,onSceneChange:U}){this.type="Renderer",this.alpha=e,this.antialias=t,this.premultipliedAlpha=i,this.depth=s,this.failIfMajorPerformanceCaveat=a,this.preserveDrawingBuffer=l,this.stencil=u,this.container=p,this.pixelRatio=m,this._renderingScale=x,this.production=w,this.onError=E,this.onSuccess=T,this.onContextLost=F,this.onContextRestored=L,this.onDisposed=V,this.onSceneChange=U,this.initState(),this.canvas=document.createElement("canvas");const O={alpha:this.alpha,premultipliedAlpha:this.premultipliedAlpha,antialias:this.antialias,depth:this.depth,failIfMajorPerformanceCaveat:this.failIfMajorPerformanceCaveat,preserveDrawingBuffer:this.preserveDrawingBuffer,stencil:this.stencil};if(this.gl=this.canvas.getContext("webgl2",O),this._isWebGL2=!!this.gl,this.gl||(this.gl=this.canvas.getContext("webgl",O)||this.canvas.getContext("experimental-webgl",O)),this.gl)this.onSuccess&&this.onSuccess();else{this.production||z(this.type+": WebGL context could not be created"),this.state.isActive=!1,this.onError&&this.onError();return}this.initRenderer()}initState(){this.state={isActive:!0,isContextLost:!0,drawingEnabled:!0,forceRender:!1,currentProgramID:null,currentGeometryID:null,forceBufferUpdate:!1,depthTest:null,blending:null,cullFace:null,frameBufferID:null,scenePassIndex:null,activeTexture:null,unpackAlignment:null,flipY:null,premultiplyAlpha:null}}initCallbackQueueManager(){this.nextRender=new ci}initRenderer(){this.planes=[],this.renderTargets=[],this.shaderPasses=[],this.state.isContextLost=!1,this.state.maxTextureSize=this.gl.getParameter(this.gl.MAX_TEXTURE_SIZE),this.initCallbackQueueManager(),this.setBlendFunc(),this.setDepthFunc(),this.setDepthTest(!0),this.cache=new di,this.scene=new oi(this),this.getExtensions(),this._contextLostHandler=this.contextLost.bind(this),this.canvas.addEventListener("webglcontextlost",this._contextLostHandler,!1),this._contextRestoredHandler=this.contextRestored.bind(this),this.canvas.addEventListener("webglcontextrestored",this._contextRestoredHandler,!1)}getExtensions(){this.extensions=[],this._isWebGL2?(this.extensions.EXT_color_buffer_float=this.gl.getExtension("EXT_color_buffer_float"),this.extensions.OES_texture_float_linear=this.gl.getExtension("OES_texture_float_linear"),this.extensions.EXT_texture_filter_anisotropic=this.gl.getExtension("EXT_texture_filter_anisotropic"),this.extensions.WEBGL_lose_context=this.gl.getExtension("WEBGL_lose_context")):(this.extensions.OES_vertex_array_object=this.gl.getExtension("OES_vertex_array_object"),this.extensions.OES_texture_float=this.gl.getExtension("OES_texture_float"),this.extensions.OES_texture_float_linear=this.gl.getExtension("OES_texture_float_linear"),this.extensions.OES_texture_half_float=this.gl.getExtension("OES_texture_half_float"),this.extensions.OES_texture_half_float_linear=this.gl.getExtension("OES_texture_half_float_linear"),this.extensions.EXT_texture_filter_anisotropic=this.gl.getExtension("EXT_texture_filter_anisotropic"),this.extensions.OES_element_index_uint=this.gl.getExtension("OES_element_index_uint"),this.extensions.OES_standard_derivatives=this.gl.getExtension("OES_standard_derivatives"),this.extensions.EXT_sRGB=this.gl.getExtension("EXT_sRGB"),this.extensions.WEBGL_depth_texture=this.gl.getExtension("WEBGL_depth_texture"),this.extensions.WEBGL_draw_buffers=this.gl.getExtension("WEBGL_draw_buffers"),this.extensions.WEBGL_lose_context=this.gl.getExtension("WEBGL_lose_context"))}contextLost(e){this.state.isContextLost=!0,this.state.isActive&&(e.preventDefault(),this.nextRender.add(()=>this.onContextLost&&this.onContextLost()))}restoreContext(){this.state.isActive&&(this.initState(),this.gl&&this.extensions.WEBGL_lose_context?this.extensions.WEBGL_lose_context.restoreContext():(!this.gl&&!this.production?z(this.type+": Could not restore the context because the context is not defined"):!this.extensions.WEBGL_lose_context&&!this.production&&z(this.type+": Could not restore the context because the restore context extension is not defined"),this.onError&&this.onError()))}isContextexFullyRestored(){let e=!0;for(let t=0;t<this.renderTargets.length;t++){this.renderTargets[t].textures[0]._canDraw||(e=!1);break}if(e)for(let t=0;t<this.planes.length;t++)if(this.planes[t]._canDraw){for(let i=0;i<this.planes[t].textures.length;i++)if(!this.planes[t].textures[i]._canDraw){e=!1;break}}else{e=!1;break}if(e)for(let t=0;t<this.shaderPasses.length;t++)if(this.shaderPasses[t]._canDraw){for(let i=0;i<this.shaderPasses[t].textures.length;i++)if(!this.shaderPasses[t].textures[i]._canDraw){e=!1;break}}else{e=!1;break}return e}contextRestored(){this.getExtensions(),this.setBlendFunc(),this.setDepthFunc(),this.setDepthTest(!0),this.cache.clear(),this.scene.initStacks();for(let t=0;t<this.renderTargets.length;t++)this.renderTargets[t]._restoreContext();for(let t=0;t<this.planes.length;t++)this.planes[t]._restoreContext();for(let t=0;t<this.shaderPasses.length;t++)this.shaderPasses[t]._restoreContext();const e=this.nextRender.add(()=>{this.isContextexFullyRestored()&&(e.keep=!1,this.state.isContextLost=!1,this.onContextRestored&&this.onContextRestored(),this.onSceneChange(),this.needRender())},!0)}setPixelRatio(e){this.pixelRatio=e}setSize(){if(!this.gl)return;const e=this.container.getBoundingClientRect();this._boundingRect={width:e.width*this.pixelRatio,height:e.height*this.pixelRatio,top:e.top*this.pixelRatio,left:e.left*this.pixelRatio},this.canvas.style.width=Math.floor(this._boundingRect.width/this.pixelRatio)+"px",this.canvas.style.height=Math.floor(this._boundingRect.height/this.pixelRatio)+"px",this.canvas.width=Math.floor(this._boundingRect.width*this._renderingScale),this.canvas.height=Math.floor(this._boundingRect.height*this._renderingScale),this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight)}resize(){for(let e=0;e<this.planes.length;e++)this.planes[e]._canDraw&&this.planes[e].resize();for(let e=0;e<this.shaderPasses.length;e++)this.shaderPasses[e]._canDraw&&this.shaderPasses[e].resize();for(let e=0;e<this.renderTargets.length;e++)this.renderTargets[e].resize();this.needRender()}clear(){this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)}clearDepth(){this.gl.clear(this.gl.DEPTH_BUFFER_BIT)}clearColor(){this.gl.clear(this.gl.COLOR_BUFFER_BIT)}bindFrameBuffer(e,t){let i=null;e?(i=e.index,i!==this.state.frameBufferID&&(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,e._frameBuffer),this.gl.viewport(0,0,e._size.width,e._size.height),e._shouldClear&&!t&&this.clear())):this.state.frameBufferID!==null&&(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight)),this.state.frameBufferID=i}setDepthTest(e){e&&!this.state.depthTest?(this.state.depthTest=e,this.gl.enable(this.gl.DEPTH_TEST)):!e&&this.state.depthTest&&(this.state.depthTest=e,this.gl.disable(this.gl.DEPTH_TEST))}setDepthFunc(){this.gl.depthFunc(this.gl.LEQUAL)}setBlending(e=!1){e&&!this.state.blending?(this.state.blending=e,this.gl.enable(this.gl.BLEND)):!e&&this.state.blending&&(this.state.blending=e,this.gl.disable(this.gl.BLEND))}setBlendFunc(){this.gl.enable(this.gl.BLEND),this.premultipliedAlpha?this.gl.blendFuncSeparate(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA,this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA):this.gl.blendFuncSeparate(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA,this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA)}setFaceCulling(e){if(this.state.cullFace!==e)if(this.state.cullFace=e,e==="none")this.gl.disable(this.gl.CULL_FACE);else{const t=e==="front"?this.gl.FRONT:this.gl.BACK;this.gl.enable(this.gl.CULL_FACE),this.gl.cullFace(t)}}useProgram(e){(this.state.currentProgramID===null||this.state.currentProgramID!==e.id)&&(this.gl.useProgram(e.program),this.state.currentProgramID=e.id)}removePlane(e){this.gl&&(this.planes=this.planes.filter(t=>t.uuid!==e.uuid),this.scene.removePlane(e),e=null,this.gl&&this.clear(),this.onSceneChange())}removeRenderTarget(e){if(!this.gl)return;let t=this.planes.find(i=>i.type!=="PingPongPlane"&&i.target&&i.target.uuid===e.uuid);for(let i=0;i<this.planes.length;i++)this.planes[i].target&&this.planes[i].target.uuid===e.uuid&&(this.planes[i].target=null);this.renderTargets=this.renderTargets.filter(i=>i.uuid!==e.uuid);for(let i=0;i<this.renderTargets.length;i++)this.renderTargets[i].index=i;e=null,this.gl&&this.clear(),t&&this.scene.resetPlaneStacks(),this.onSceneChange()}removeShaderPass(e){this.gl&&(this.shaderPasses=this.shaderPasses.filter(t=>t.uuid!==e.uuid),this.scene.removeShaderPass(e),e=null,this.gl&&this.clear(),this.onSceneChange())}enableDrawing(){this.state.drawingEnabled=!0}disableDrawing(){this.state.drawingEnabled=!1}needRender(){this.state.forceRender=!0}render(){this.gl&&(this.clear(),this.state.currentGeometryID=null,this.scene.draw())}deletePrograms(){for(let e=0;e<this.cache.programs.length;e++){const t=this.cache.programs[e];this.gl.deleteProgram(t.program)}}dispose(){if(!this.gl)return;for(this.state.isActive=!1;this.planes.length>0;)this.removePlane(this.planes[0]);for(;this.shaderPasses.length>0;)this.removeShaderPass(this.shaderPasses[0]);for(;this.renderTargets.length>0;)this.removeRenderTarget(this.renderTargets[0]);let e=this.nextRender.add(()=>{this.planes.length===0&&this.shaderPasses.length===0&&this.renderTargets.length===0&&(e.keep=!1,this.deletePrograms(),this.clear(),this.canvas.removeEventListener("webgllost",this._contextLostHandler,!1),this.canvas.removeEventListener("webglrestored",this._contextRestoredHandler,!1),this.gl&&this.extensions.WEBGL_lose_context&&this.extensions.WEBGL_lose_context.loseContext(),this.canvas.width=this.canvas.width,this.gl=null,this.container.removeChild(this.canvas),this.container=null,this.canvas=null,this.onDisposed&&this.onDisposed())},!0)}}class fi{constructor({xOffset:e=0,yOffset:t=0,lastXDelta:i=0,lastYDelta:s=0,shouldWatch:a=!0,onScroll:l=()=>{}}={}){this.xOffset=e,this.yOffset=t,this.lastXDelta=i,this.lastYDelta=s,this.shouldWatch=a,this.onScroll=l,this.handler=this.scroll.bind(this,!0),this.shouldWatch&&window.addEventListener("scroll",this.handler,{passive:!0})}scroll(){this.updateScrollValues(window.pageXOffset,window.pageYOffset)}updateScrollValues(e,t){const i=this.xOffset;this.xOffset=e,this.lastXDelta=i-this.xOffset;const s=this.yOffset;this.yOffset=t,this.lastYDelta=s-this.yOffset,this.onScroll&&this.onScroll(this.lastXDelta,this.lastYDelta)}dispose(){this.shouldWatch&&window.removeEventListener("scroll",this.handler,{passive:!0})}}class gi{constructor({container:e,alpha:t=!0,premultipliedAlpha:i=!1,antialias:s=!0,depth:a=!0,failIfMajorPerformanceCaveat:l=!0,preserveDrawingBuffer:u=!1,stencil:p=!1,autoResize:m=!0,autoRender:x=!0,watchScroll:w=!0,pixelRatio:E=window.devicePixelRatio||1,renderingScale:T=1,production:F=!1}={}){this.type="Curtains",this._autoResize=m,this._autoRender=x,this._watchScroll=w,this.pixelRatio=E,T=isNaN(T)?1:parseFloat(T),this._renderingScale=Math.max(.25,Math.min(1,T)),this.premultipliedAlpha=i,this.alpha=t,this.antialias=s,this.depth=a,this.failIfMajorPerformanceCaveat=l,this.preserveDrawingBuffer=u,this.stencil=p,this.production=F,this.errors=!1,e?this.setContainer(e):this.production||z(this.type+": no container provided in the initial parameters. Use setContainer() method to set one later and initialize the WebGL context")}setContainer(e){if(e)if(typeof e=="string")if(e=document.getElementById(e),e)this.container=e;else{let t=document.createElement("div");t.setAttribute("id","curtains-canvas"),document.body.appendChild(t),this.container=t,this.production||z('Curtains: no valid container HTML element or ID provided, created a div with "curtains-canvas" ID instead')}else e instanceof Element&&(this.container=e);else{let t=document.createElement("div");t.setAttribute("id","curtains-canvas"),document.body.appendChild(t),this.container=t,this.production||z('Curtains: no valid container HTML element or ID provided, created a div with "curtains-canvas" ID instead')}this._initCurtains()}_initCurtains(){this.planes=[],this.renderTargets=[],this.shaderPasses=[],this._initRenderer(),this.gl&&(this._initScroll(),this._setSize(),this._addListeners(),this.container.appendChild(this.canvas),this._animationFrameID=null,this._autoRender&&this._animate())}_initRenderer(){this.renderer=new ui({alpha:this.alpha,antialias:this.antialias,premultipliedAlpha:this.premultipliedAlpha,depth:this.depth,failIfMajorPerformanceCaveat:this.failIfMajorPerformanceCaveat,preserveDrawingBuffer:this.preserveDrawingBuffer,stencil:this.stencil,container:this.container,pixelRatio:this.pixelRatio,renderingScale:this._renderingScale,production:this.production,onError:()=>this._onRendererError(),onSuccess:()=>this._onRendererSuccess(),onContextLost:()=>this._onRendererContextLost(),onContextRestored:()=>this._onRendererContextRestored(),onDisposed:()=>this._onRendererDisposed(),onSceneChange:()=>this._keepSync()}),this.gl=this.renderer.gl,this.canvas=this.renderer.canvas}restoreContext(){this.renderer.restoreContext()}_animate(){this.render(),this._animationFrameID=window.requestAnimationFrame(this._animate.bind(this))}enableDrawing(){this.renderer.enableDrawing()}disableDrawing(){this.renderer.disableDrawing()}needRender(){this.renderer.needRender()}nextRender(e,t=!1){return this.renderer.nextRender.add(e,t)}clear(){this.renderer&&this.renderer.clear()}clearDepth(){this.renderer&&this.renderer.clearDepth()}clearColor(){this.renderer&&this.renderer.clearColor()}isWebGL2(){return this.gl?this.renderer._isWebGL2:!1}render(){this.renderer.nextRender.execute(),!(!this.renderer.state.drawingEnabled&&!this.renderer.state.forceRender)&&(this.renderer.state.forceRender&&(this.renderer.state.forceRender=!1),this._onRenderCallback&&this._onRenderCallback(),this.renderer.render())}_addListeners(){this._resizeHandler=null,this._autoResize&&(this._resizeHandler=this.resize.bind(this,!0),window.addEventListener("resize",this._resizeHandler,!1))}setPixelRatio(e,t){this.pixelRatio=parseFloat(Math.max(e,1))||1,this.renderer.setPixelRatio(e),this.resize(t)}_setSize(){this.renderer.setSize(),this._scrollManager.shouldWatch&&(this._scrollManager.xOffset=window.pageXOffset,this._scrollManager.yOffset=window.pageYOffset)}getBoundingRect(){return this.renderer._boundingRect}resize(e){this.gl&&(this._setSize(),this.renderer.resize(),this.nextRender(()=>{this._onAfterResizeCallback&&e&&this._onAfterResizeCallback()}))}_initScroll(){this._scrollManager=new fi({xOffset:window.pageXOffset,yOffset:0,lastXDelta:0,lastYDelta:0,shouldWatch:this._watchScroll,onScroll:(e,t)=>this._updateScroll(e,t)})}_updateScroll(e,t){for(let i=0;i<this.planes.length;i++)this.planes[i].watchScroll&&this.planes[i].updateScrollPosition(e,t);this.renderer.needRender(),this._onScrollCallback&&this._onScrollCallback()}updateScrollValues(e,t){this._scrollManager.updateScrollValues(e,t)}getScrollDeltas(){return{x:this._scrollManager.lastXDelta,y:this._scrollManager.lastYDelta}}getScrollValues(){return{x:this._scrollManager.xOffset,y:this._scrollManager.yOffset}}_keepSync(){this.planes=this.renderer.planes,this.shaderPasses=this.renderer.shaderPasses,this.renderTargets=this.renderer.renderTargets}lerp(e,t,i){return li(e,t,i)}onAfterResize(e){return e&&(this._onAfterResizeCallback=e),this}onError(e){return e&&(this._onErrorCallback=e),this}_onRendererError(){setTimeout(()=>{this._onErrorCallback&&!this.errors&&this._onErrorCallback(),this.errors=!0},0)}onSuccess(e){return e&&(this._onSuccessCallback=e),this}_onRendererSuccess(){setTimeout(()=>{this._onSuccessCallback&&this._onSuccessCallback()},0)}onContextLost(e){return e&&(this._onContextLostCallback=e),this}_onRendererContextLost(){this._onContextLostCallback&&this._onContextLostCallback()}onContextRestored(e){return e&&(this._onContextRestoredCallback=e),this}_onRendererContextRestored(){this._onContextRestoredCallback&&this._onContextRestoredCallback()}onRender(e){return e&&(this._onRenderCallback=e),this}onScroll(e){return e&&(this._onScrollCallback=e),this}dispose(){this.renderer.dispose()}_onRendererDisposed(){this._animationFrameID&&window.cancelAnimationFrame(this._animationFrameID),this._resizeHandler&&window.removeEventListener("resize",this._resizeHandler,!1),this._scrollManager&&this._scrollManager.dispose()}}class pi{constructor(e,t,i){if(this.type="Uniforms",!e||e.type!=="Renderer")ne(this.type+": Renderer not passed as first argument",e);else if(!e.gl){ne(this.type+": Renderer WebGL context is undefined",e);return}if(this.renderer=e,this.gl=e.gl,this.program=t,this.uniforms={},i)for(const s in i){const a=i[s];this.uniforms[s]={name:a.name,type:a.type,value:a.value.clone&&typeof a.value.clone=="function"?a.value.clone():a.value,update:null}}}handleUniformSetting(e){switch(e.type){case"1i":e.update=this.setUniform1i.bind(this);break;case"1iv":e.update=this.setUniform1iv.bind(this);break;case"1f":e.update=this.setUniform1f.bind(this);break;case"1fv":e.update=this.setUniform1fv.bind(this);break;case"2i":e.update=this.setUniform2i.bind(this);break;case"2iv":e.update=this.setUniform2iv.bind(this);break;case"2f":e.update=this.setUniform2f.bind(this);break;case"2fv":e.update=this.setUniform2fv.bind(this);break;case"3i":e.update=this.setUniform3i.bind(this);break;case"3iv":e.update=this.setUniform3iv.bind(this);break;case"3f":e.update=this.setUniform3f.bind(this);break;case"3fv":e.update=this.setUniform3fv.bind(this);break;case"4i":e.update=this.setUniform4i.bind(this);break;case"4iv":e.update=this.setUniform4iv.bind(this);break;case"4f":e.update=this.setUniform4f.bind(this);break;case"4fv":e.update=this.setUniform4fv.bind(this);break;case"mat2":e.update=this.setUniformMatrix2fv.bind(this);break;case"mat3":e.update=this.setUniformMatrix3fv.bind(this);break;case"mat4":e.update=this.setUniformMatrix4fv.bind(this);break;default:this.renderer.production||z(this.type+": This uniform type is not handled : ",e.type)}}setInternalFormat(e){e.value.type==="Vec2"?(e._internalFormat="Vec2",e.lastValue=e.value.clone()):e.value.type==="Vec3"?(e._internalFormat="Vec3",e.lastValue=e.value.clone()):e.value.type==="Mat4"?(e._internalFormat="Mat4",e.lastValue=e.value.clone()):e.value.type==="Quat"?(e._internalFormat="Quat",e.lastValue=e.value.clone()):Array.isArray(e.value)?(e._internalFormat="array",e.lastValue=Array.from(e.value)):e.value.constructor===Float32Array?(e._internalFormat="mat",e.lastValue=e.value):(e._internalFormat="float",e.lastValue=e.value)}setUniforms(){if(this.uniforms)for(const e in this.uniforms){let t=this.uniforms[e];t.location=this.gl.getUniformLocation(this.program,t.name),t._internalFormat||this.setInternalFormat(t),t.type||(t._internalFormat==="Vec2"?t.type="2f":t._internalFormat==="Vec3"?t.type="3f":t._internalFormat==="Mat4"?t.type="mat4":t._internalFormat==="array"?t.value.length===4?(t.type="4f",this.renderer.production||z(this.type+": No uniform type declared for "+t.name+", applied a 4f (array of 4 floats) uniform type")):t.value.length===3?(t.type="3f",this.renderer.production||z(this.type+": No uniform type declared for "+t.name+", applied a 3f (array of 3 floats) uniform type")):t.value.length===2&&(t.type="2f",this.renderer.production||z(this.type+": No uniform type declared for "+t.name+", applied a 2f (array of 2 floats) uniform type")):t._internalFormat==="mat"?t.value.length===16?(t.type="mat4",this.renderer.production||z(this.type+": No uniform type declared for "+t.name+", applied a mat4 (4x4 matrix array) uniform type")):t.value.length===9?(t.type="mat3",this.renderer.production||z(this.type+": No uniform type declared for "+t.name+", applied a mat3 (3x3 matrix array) uniform type")):t.value.length===4&&(t.type="mat2",this.renderer.production||z(this.type+": No uniform type declared for "+t.name+", applied a mat2 (2x2 matrix array) uniform type")):(t.type="1f",this.renderer.production||z(this.type+": No uniform type declared for "+t.name+", applied a 1f (float) uniform type"))),this.handleUniformSetting(t),t.update&&t.update(t)}}updateUniforms(){if(this.uniforms)for(const e in this.uniforms){const t=this.uniforms[e];let i=!1;t._internalFormat==="Vec2"||t._internalFormat==="Vec3"||t._internalFormat==="Quat"?t.value.equals(t.lastValue)||(i=!0,t.lastValue.copy(t.value)):t.value.length?JSON.stringify(t.value)!==JSON.stringify(t.lastValue)&&(i=!0,t.lastValue=Array.from(t.value)):t.value!==t.lastValue&&(i=!0,t.lastValue=t.value),i&&t.update&&t.update(t)}}setUniform1i(e){this.gl.uniform1i(e.location,e.value)}setUniform1iv(e){this.gl.uniform1iv(e.location,e.value)}setUniform1f(e){this.gl.uniform1f(e.location,e.value)}setUniform1fv(e){this.gl.uniform1fv(e.location,e.value)}setUniform2i(e){e._internalFormat==="Vec2"?this.gl.uniform2i(e.location,e.value.x,e.value.y):this.gl.uniform2i(e.location,e.value[0],e.value[1])}setUniform2iv(e){e._internalFormat==="Vec2"?this.gl.uniform2iv(e.location,[e.value.x,e.value.y]):this.gl.uniform2iv(e.location,e.value)}setUniform2f(e){e._internalFormat==="Vec2"?this.gl.uniform2f(e.location,e.value.x,e.value.y):this.gl.uniform2f(e.location,e.value[0],e.value[1])}setUniform2fv(e){e._internalFormat==="Vec2"?this.gl.uniform2fv(e.location,[e.value.x,e.value.y]):this.gl.uniform2fv(e.location,e.value)}setUniform3i(e){e._internalFormat==="Vec3"?this.gl.uniform3i(e.location,e.value.x,e.value.y,e.value.z):this.gl.uniform3i(e.location,e.value[0],e.value[1],e.value[2])}setUniform3iv(e){e._internalFormat==="Vec3"?this.gl.uniform3iv(e.location,[e.value.x,e.value.y,e.value.z]):this.gl.uniform3iv(e.location,e.value)}setUniform3f(e){e._internalFormat==="Vec3"?this.gl.uniform3f(e.location,e.value.x,e.value.y,e.value.z):this.gl.uniform3f(e.location,e.value[0],e.value[1],e.value[2])}setUniform3fv(e){e._internalFormat==="Vec3"?this.gl.uniform3fv(e.location,[e.value.x,e.value.y,e.value.z]):this.gl.uniform3fv(e.location,e.value)}setUniform4i(e){e._internalFormat==="Quat"?this.gl.uniform4i(e.location,e.value.elements[0],e.value.elements[1],e.value.elements[2],e.value[3]):this.gl.uniform4i(e.location,e.value[0],e.value[1],e.value[2],e.value[3])}setUniform4iv(e){e._internalFormat==="Quat"?this.gl.uniform4iv(e.location,[e.value.elements[0],e.value.elements[1],e.value.elements[2],e.value[3]]):this.gl.uniform4iv(e.location,e.value)}setUniform4f(e){e._internalFormat==="Quat"?this.gl.uniform4f(e.location,e.value.elements[0],e.value.elements[1],e.value.elements[2],e.value[3]):this.gl.uniform4f(e.location,e.value[0],e.value[1],e.value[2],e.value[3])}setUniform4fv(e){e._internalFormat==="Quat"?this.gl.uniform4fv(e.location,[e.value.elements[0],e.value.elements[1],e.value.elements[2],e.value[3]]):this.gl.uniform4fv(e.location,e.value)}setUniformMatrix2fv(e){this.gl.uniformMatrix2fv(e.location,!1,e.value)}setUniformMatrix3fv(e){this.gl.uniformMatrix3fv(e.location,!1,e.value)}setUniformMatrix4fv(e){e._internalFormat==="Mat4"?this.gl.uniformMatrix4fv(e.location,!1,e.value.elements):this.gl.uniformMatrix4fv(e.location,!1,e.value)}}const Ye=`
precision mediump float;
`.replace(/\n/g,""),Et=`
attribute vec3 aVertexPosition;
attribute vec2 aTextureCoord;
`.replace(/\n/g,""),qe=`
varying vec3 vVertexPosition;
varying vec2 vTextureCoord;
`.replace(/\n/g,""),mi=(Ye+Et+qe+`
uniform mat4 uMVMatrix;
uniform mat4 uPMatrix;

void main() {
    vTextureCoord = aTextureCoord;
    vVertexPosition = aVertexPosition;
    
    gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
}
`).replace(/\n/g,""),xi=(Ye+qe+`
void main() {
    gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
}
`).replace(/\n/g,""),_i=(Ye+Et+qe+`
void main() {
    vTextureCoord = aTextureCoord;
    vVertexPosition = aVertexPosition;
    
    gl_Position = vec4(aVertexPosition, 1.0);
}
`).replace(/\n/g,""),vi=(Ye+qe+`
uniform sampler2D uRenderTexture;

void main() {
    gl_FragColor = texture2D(uRenderTexture, vTextureCoord);
}
`).replace(/\n/g,"");let At=0;class Ct{constructor(e,{parent:t,vertexShader:i,fragmentShader:s}={}){if(this.type="Program",!e||e.type!=="Renderer")ne(this.type+": Renderer not passed as first argument",e);else if(!e.gl){ne(this.type+": Renderer WebGL context is undefined",e);return}this.renderer=e,this.gl=this.renderer.gl,this.parent=t,this.defaultVsCode=this.parent.type==="Plane"?mi:_i,this.defaultFsCode=this.parent.type==="Plane"?xi:vi,i?this.vsCode=i:(!this.renderer.production&&this.parent.type==="Plane"&&z(this.parent.type+": No vertex shader provided, will use a default one"),this.vsCode=this.defaultVsCode),s?this.fsCode=s:(this.renderer.production||z(this.parent.type+": No fragment shader provided, will use a default one"),this.fsCode=this.defaultFsCode),this.compiled=!0,this.setupProgram()}createShader(e,t){const i=this.gl.createShader(t);if(this.gl.shaderSource(i,e),this.gl.compileShader(i),!this.renderer.production&&!this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS)){const s=t===this.gl.VERTEX_SHADER?"vertex shader":"fragment shader";let l=this.gl.getShaderSource(i).split(`
`);for(let u=0;u<l.length;u++)l[u]=u+1+": "+l[u];return l=l.join(`
`),z(this.type+": Errors occurred while compiling the",s,`:
`,this.gl.getShaderInfoLog(i)),ne(l),z(this.type+": Will use a default",s),this.createShader(t===this.gl.VERTEX_SHADER?this.defaultVsCode:this.defaultFsCode,t)}return i}useNewShaders(){this.vertexShader=this.createShader(this.vsCode,this.gl.VERTEX_SHADER),this.fragmentShader=this.createShader(this.fsCode,this.gl.FRAGMENT_SHADER),(!this.vertexShader||!this.fragmentShader)&&(this.renderer.production||z(this.type+": Unable to find or compile the vertex or fragment shader"))}setupProgram(){let e=this.renderer.cache.getProgramFromShaders(this.vsCode,this.fsCode);e?(this.vertexShader=e.vertexShader,this.fragmentShader=e.fragmentShader,this.activeUniforms=e.activeUniforms,this.activeAttributes=e.activeAttributes,this.createProgram()):(this.useNewShaders(),this.compiled&&(this.createProgram(),this.renderer.cache.addProgram(this)))}createProgram(){if(At++,this.id=At,this.program=this.gl.createProgram(),this.gl.attachShader(this.program,this.vertexShader),this.gl.attachShader(this.program,this.fragmentShader),this.gl.linkProgram(this.program),!this.renderer.production&&!this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS)){z(this.type+": Unable to initialize the shader program: "+this.gl.getProgramInfoLog(this.program)),z(this.type+": Will use default vertex and fragment shaders"),this.vertexShader=this.createShader(this.defaultVsCode,this.gl.VERTEX_SHADER),this.fragmentShader=this.createShader(this.defaultFsCode,this.gl.FRAGMENT_SHADER),this.createProgram();return}if(this.gl.deleteShader(this.vertexShader),this.gl.deleteShader(this.fragmentShader),!this.activeUniforms||!this.activeAttributes){this.activeUniforms={textures:[],textureMatrices:[]};const e=this.gl.getProgramParameter(this.program,this.gl.ACTIVE_UNIFORMS);for(let i=0;i<e;i++){const s=this.gl.getActiveUniform(this.program,i);s.type===this.gl.SAMPLER_2D&&this.activeUniforms.textures.push(s.name),s.type===this.gl.FLOAT_MAT4&&s.name!=="uMVMatrix"&&s.name!=="uPMatrix"&&this.activeUniforms.textureMatrices.push(s.name)}this.activeAttributes=[];const t=this.gl.getProgramParameter(this.program,this.gl.ACTIVE_ATTRIBUTES);for(let i=0;i<t;i++){const s=this.gl.getActiveAttrib(this.program,i);this.activeAttributes.push(s.name)}}}createUniforms(e){this.uniformsManager=new pi(this.renderer,this.program,e),this.setUniforms()}setUniforms(){this.renderer.useProgram(this),this.uniformsManager.setUniforms()}updateUniforms(){this.renderer.useProgram(this),this.uniformsManager.updateUniforms()}}var yi=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},dt={},bi={get exports(){return dt},set exports(f){dt=f}};(function(f,e){(function(t,i){i(e)})(yi,function(t){var i={exports:{}};i.exports=s,i.exports.default=s;function s(r,n,h){h=h||2;var d=n&&n.length,o=d?n[0]*h:r.length,c=a(r,0,o,h,!0),g=[];if(!c||c.next===c.prev)return g;var _,v,R,y,M,S,b;if(d&&(c=E(r,n,c,h)),r.length>80*h){_=R=r[0],v=y=r[1];for(var P=h;P<o;P+=h)M=r[P],S=r[P+1],M<_&&(_=M),S<v&&(v=S),M>R&&(R=M),S>y&&(y=S);b=Math.max(R-_,y-v),b=b!==0?1/b:0}return u(c,g,h,_,v,b),g}function a(r,n,h,d,o){var c,g;if(o===Ve(r,n,h,d)>0)for(c=n;c<h;c+=d)g=te(c,r[c],r[c+1],g);else for(c=h-d;c>=n;c-=d)g=te(c,r[c],r[c+1],g);return g&&Q(g,g.next)&&(Se(g),g=g.next),g}function l(r,n){if(!r)return r;n||(n=r);var h=r,d;do if(d=!1,!h.steiner&&(Q(h,h.next)||C(h.prev,h,h.next)===0)){if(Se(h),h=n=h.prev,h===h.next)break;d=!0}else h=h.next;while(d||h!==n);return n}function u(r,n,h,d,o,c,g){if(r){!g&&c&&U(r,d,o,c);for(var _=r,v,R;r.prev!==r.next;){if(v=r.prev,R=r.next,c?m(r,d,o,c):p(r)){n.push(v.i/h),n.push(r.i/h),n.push(R.i/h),Se(r),r=R.next,_=R.next;continue}if(r=R,r===_){g?g===1?(r=x(l(r),n,h),u(r,n,h,d,o,c,2)):g===2&&w(r,n,h,d,o,c):u(l(r),n,h,d,o,c,1);break}}}}function p(r){var n=r.prev,h=r,d=r.next;if(C(n,h,d)>=0)return!1;for(var o=r.next.next;o!==r.prev;){if(B(n.x,n.y,h.x,h.y,d.x,d.y,o.x,o.y)&&C(o.prev,o,o.next)>=0)return!1;o=o.next}return!0}function m(r,n,h,d){var o=r.prev,c=r,g=r.next;if(C(o,c,g)>=0)return!1;for(var _=o.x<c.x?o.x<g.x?o.x:g.x:c.x<g.x?c.x:g.x,v=o.y<c.y?o.y<g.y?o.y:g.y:c.y<g.y?c.y:g.y,R=o.x>c.x?o.x>g.x?o.x:g.x:c.x>g.x?c.x:g.x,y=o.y>c.y?o.y>g.y?o.y:g.y:c.y>g.y?c.y:g.y,M=D(_,v,n,h,d),S=D(R,y,n,h,d),b=r.prevZ,P=r.nextZ;b&&b.z>=M&&P&&P.z<=S;){if(b!==r.prev&&b!==r.next&&B(o.x,o.y,c.x,c.y,g.x,g.y,b.x,b.y)&&C(b.prev,b,b.next)>=0||(b=b.prevZ,P!==r.prev&&P!==r.next&&B(o.x,o.y,c.x,c.y,g.x,g.y,P.x,P.y)&&C(P.prev,P,P.next)>=0))return!1;P=P.nextZ}for(;b&&b.z>=M;){if(b!==r.prev&&b!==r.next&&B(o.x,o.y,c.x,c.y,g.x,g.y,b.x,b.y)&&C(b.prev,b,b.next)>=0)return!1;b=b.prevZ}for(;P&&P.z<=S;){if(P!==r.prev&&P!==r.next&&B(o.x,o.y,c.x,c.y,g.x,g.y,P.x,P.y)&&C(P.prev,P,P.next)>=0)return!1;P=P.nextZ}return!0}function x(r,n,h){var d=r;do{var o=d.prev,c=d.next.next;!Q(o,c)&&J(o,d,d.next,c)&&he(o,c)&&he(c,o)&&(n.push(o.i/h),n.push(d.i/h),n.push(c.i/h),Se(d),Se(d.next),d=r=c),d=d.next}while(d!==r);return l(d)}function w(r,n,h,d,o,c){var g=r;do{for(var _=g.next.next;_!==g.prev;){if(g.i!==_.i&&W(g,_)){var v=ve(g,_);g=l(g,g.next),v=l(v,v.next),u(g,n,h,d,o,c),u(v,n,h,d,o,c);return}_=_.next}g=g.next}while(g!==r)}function E(r,n,h,d){var o=[],c,g,_,v,R;for(c=0,g=n.length;c<g;c++)_=n[c]*d,v=c<g-1?n[c+1]*d:r.length,R=a(r,_,v,d,!1),R===R.next&&(R.steiner=!0),o.push(N(R));for(o.sort(T),c=0;c<o.length;c++)h=F(o[c],h),h=l(h,h.next);return h}function T(r,n){return r.x-n.x}function F(r,n){var h=L(r,n);if(!h)return n;var d=ve(h,r),o=l(h,h.next);return l(d,d.next),n===h?o:n}function L(r,n){var h=n,d=r.x,o=r.y,c=-1/0,g;do{if(o<=h.y&&o>=h.next.y&&h.next.y!==h.y){var _=h.x+(o-h.y)*(h.next.x-h.x)/(h.next.y-h.y);if(_<=d&&_>c){if(c=_,_===d){if(o===h.y)return h;if(o===h.next.y)return h.next}g=h.x<h.next.x?h:h.next}}h=h.next}while(h!==n);if(!g)return null;if(d===c)return g;var v=g,R=g.x,y=g.y,M=1/0,S;h=g;do d>=h.x&&h.x>=R&&d!==h.x&&B(o<y?d:c,o,R,y,o<y?c:d,o,h.x,h.y)&&(S=Math.abs(o-h.y)/(d-h.x),he(h,r)&&(S<M||S===M&&(h.x>g.x||h.x===g.x&&V(g,h)))&&(g=h,M=S)),h=h.next;while(h!==v);return g}function V(r,n){return C(r.prev,r,n.prev)<0&&C(n.next,r,r.next)<0}function U(r,n,h,d){var o=r;do o.z===null&&(o.z=D(o.x,o.y,n,h,d)),o.prevZ=o.prev,o.nextZ=o.next,o=o.next;while(o!==r);o.prevZ.nextZ=null,o.prevZ=null,O(o)}function O(r){var n,h,d,o,c,g,_,v,R=1;do{for(h=r,r=null,c=null,g=0;h;){for(g++,d=h,_=0,n=0;n<R&&(_++,d=d.nextZ,!!d);n++);for(v=R;_>0||v>0&&d;)_!==0&&(v===0||!d||h.z<=d.z)?(o=h,h=h.nextZ,_--):(o=d,d=d.nextZ,v--),c?c.nextZ=o:r=o,o.prevZ=c,c=o;h=d}c.nextZ=null,R*=2}while(g>1);return r}function D(r,n,h,d,o){return r=32767*(r-h)*o,n=32767*(n-d)*o,r=(r|r<<8)&16711935,r=(r|r<<4)&252645135,r=(r|r<<2)&858993459,r=(r|r<<1)&1431655765,n=(n|n<<8)&16711935,n=(n|n<<4)&252645135,n=(n|n<<2)&858993459,n=(n|n<<1)&1431655765,r|n<<1}function N(r){var n=r,h=r;do(n.x<h.x||n.x===h.x&&n.y<h.y)&&(h=n),n=n.next;while(n!==r);return h}function B(r,n,h,d,o,c,g,_){return(o-g)*(n-_)-(r-g)*(c-_)>=0&&(r-g)*(d-_)-(h-g)*(n-_)>=0&&(h-g)*(c-_)-(o-g)*(d-_)>=0}function W(r,n){return r.next.i!==n.i&&r.prev.i!==n.i&&!ie(r,n)&&(he(r,n)&&he(n,r)&&Te(r,n)&&(C(r.prev,r,n.prev)||C(r,n.prev,n))||Q(r,n)&&C(r.prev,r,r.next)>0&&C(n.prev,n,n.next)>0)}function C(r,n,h){return(n.y-r.y)*(h.x-n.x)-(n.x-r.x)*(h.y-n.y)}function Q(r,n){return r.x===n.x&&r.y===n.y}function J(r,n,h,d){var o=G(C(r,n,h)),c=G(C(r,n,d)),g=G(C(h,d,r)),_=G(C(h,d,n));return!!(o!==c&&g!==_||o===0&&X(r,h,n)||c===0&&X(r,d,n)||g===0&&X(h,r,d)||_===0&&X(h,n,d))}function X(r,n,h){return n.x<=Math.max(r.x,h.x)&&n.x>=Math.min(r.x,h.x)&&n.y<=Math.max(r.y,h.y)&&n.y>=Math.min(r.y,h.y)}function G(r){return r>0?1:r<0?-1:0}function ie(r,n){var h=r;do{if(h.i!==r.i&&h.next.i!==r.i&&h.i!==n.i&&h.next.i!==n.i&&J(h,h.next,r,n))return!0;h=h.next}while(h!==r);return!1}function he(r,n){return C(r.prev,r,r.next)<0?C(r,n,r.next)>=0&&C(r,r.prev,n)>=0:C(r,n,r.prev)<0||C(r,r.next,n)<0}function Te(r,n){var h=r,d=!1,o=(r.x+n.x)/2,c=(r.y+n.y)/2;do h.y>c!=h.next.y>c&&h.next.y!==h.y&&o<(h.next.x-h.x)*(c-h.y)/(h.next.y-h.y)+h.x&&(d=!d),h=h.next;while(h!==r);return d}function ve(r,n){var h=new Ue(r.i,r.x,r.y),d=new Ue(n.i,n.x,n.y),o=r.next,c=n.prev;return r.next=n,n.prev=r,h.next=o,o.prev=h,d.next=h,h.prev=d,c.next=d,d.prev=c,d}function te(r,n,h,d){var o=new Ue(r,n,h);return d?(o.next=d.next,o.prev=d,d.next.prev=o,d.next=o):(o.prev=o,o.next=o),o}function Se(r){r.next.prev=r.prev,r.prev.next=r.next,r.prevZ&&(r.prevZ.nextZ=r.nextZ),r.nextZ&&(r.nextZ.prevZ=r.prevZ)}function Ue(r,n,h){this.i=r,this.x=n,this.y=h,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}s.deviation=function(r,n,h,d){var o=n&&n.length,c=o?n[0]*h:r.length,g=Math.abs(Ve(r,0,c,h));if(o)for(var _=0,v=n.length;_<v;_++){var R=n[_]*h,y=_<v-1?n[_+1]*h:r.length;g-=Math.abs(Ve(r,R,y,h))}var M=0;for(_=0;_<d.length;_+=3){var S=d[_]*h,b=d[_+1]*h,P=d[_+2]*h;M+=Math.abs((r[S]-r[P])*(r[b+1]-r[S+1])-(r[S]-r[b])*(r[P+1]-r[S+1]))}return g===0&&M===0?0:Math.abs((M-g)/g)};function Ve(r,n,h,d){for(var o=0,c=n,g=h-d;c<h;c+=d)o+=(r[g]-r[c])*(r[c+1]+r[g+1]),g=c;return o}s.flatten=function(r){for(var n=r[0][0].length,h={vertices:[],holes:[],dimensions:n},d=0,o=0;o<r.length;o++){for(var c=0;c<r[o].length;c++)for(var g=0;g<n;g++)h.vertices.push(r[o][c][g]);o>0&&(d+=r[o-1].length,h.holes.push(d))}return h};var Be=i.exports;function _s(r,n){var h=r[0]-n[0],d=r[1]-n[1];return h*h+d*d}function vs(r,n,h){var d=n[0],o=n[1],c=h[0]-d,g=h[1]-o;if(c!==0||g!==0){var _=((r[0]-d)*c+(r[1]-o)*g)/(c*c+g*g);_>1?(d=h[0],o=h[1]):_>0&&(d+=c*_,o+=g*_)}return c=r[0]-d,g=r[1]-o,c*c+g*g}function ys(r,n){for(var h=r[0],d=[h],o,c=1,g=r.length;c<g;c++)o=r[c],_s(o,h)>n&&(d.push(o),h=o);return h!==o&&d.push(o),d}function xt(r,n,h,d,o){for(var c=d,g,_=n+1;_<h;_++){var v=vs(r[_],r[n],r[h]);v>c&&(g=_,c=v)}c>d&&(g-n>1&&xt(r,n,g,d,o),o.push(r[g]),h-g>1&&xt(r,g,h,d,o))}function bs(r,n){var h=r.length-1,d=[r[0]];return xt(r,0,h,n,d),d.push(r[h]),d}function Ht(r,n,h){if(r.length<=2)return r;var d=n!==void 0?n*n:1;return r=h?r:ys(r,d),r=bs(r,d),r}function ws(r,n){return r[0]*n[0]+r[1]*n[1]+r[2]*n[2]}function Gt(r,n){return r[0]*n[0]+r[1]*n[1]}function Ps(r,n){var h=n[0],d=n[1],o=n[2],c=Math.sqrt(h*h+d*d+o*o);return r[0]=h/c,r[1]=d/c,r[2]=o/c,r}function Ie(r,n){var h=n[0],d=n[1],o=Math.sqrt(h*h+d*d);return r[0]=h/o,r[1]=d/o,r}function Ts(r,n,h){return r[0]=n[0]*h,r[1]=n[1]*h,r[2]=n[2]*h,r}function jt(r,n,h,d){return r[0]=n[0]+h[0]*d,r[1]=n[1]+h[1]*d,r[2]=n[2]+h[2]*d,r}function Rs(r,n,h){return r[0]=n[0]+h[0],r[1]=n[1]+h[1],r}function Xt(r,n,h){return r[0]=n[0]-h[0],r[1]=n[1]-h[1],r[2]=n[2]-h[2],r}function Ms(r,n){var h=n[0],d=n[1],o=n[2],c=Math.sqrt(h*h+d*d+o*o);return r[0]=h/c,r[1]=d/c,r[2]=o/c,r}function Ss(r,n,h){var d=n[0],o=n[1],c=n[2],g=h[0],_=h[1],v=h[2];return r[0]=o*v-c*_,r[1]=c*g-d*v,r[2]=d*_-o*g,r}var Je=[];function Yt(r,n,h,d){var o=ws(n,h),c=Math.acos(o)*d;return jt(Je,h,n,-o),Ps(Je,Je),Ts(r,n,Math.cos(c)),jt(r,r,Je,Math.sin(c)),r}function Es(r,n,h,d,o,c,g,_,v,R){var y=h-r,M=g-o,S=d-n,b=_-c,P=b*y-M*S,A=n-c,I=r-o,H=(M*A-b*I)/P;return v&&(R=R||0,v[R]=r+H*(h-r),v[R+1]=n+H*(d-n)),H}function _t(r,n,h){var d=h-n;if(d<3)return 0;for(var o=0,c=(h-1)*2,g=n*2;g<h*2;){var _=r[c],v=r[c+1],R=r[g],y=r[g+1];c=g,g+=2,o+=_*y-R*v}return o}function qt(r,n){var h=arguments.length>2&&arguments[2]!==void 0?arguments[2]:2;return Be(r,n,h)}function As(r){return Be.flatten(r)}var Fe=[],Ee=[],$=[];function Ke(r,n,h,d,o,c,g,_,v){var R=g!=null,y=o,M=null;R&&(M=new Uint32Array(d-h));for(var S,b,P,A=[],I=h;I<d;I++){var H=I===d-1?h:I+1,j=I===h?d-1:I-1,Y=r[j*2],se=r[j*2+1],k=r[I*2],Z=r[I*2+1],K=r[H*2],re=r[H*2+1];Fe[0]=k-Y,Fe[1]=Z-se,Ee[0]=K-k,Ee[1]=re-Z,Ie(Fe,Fe),Ie(Ee,Ee),R&&(M[I]=y);var Re=!1,ee=void 0,ue=void 0;if(!_&&I===h)$[0]=Ee[1],$[1]=-Ee[0],Ie($,$),S=n[y*2]=k+$[0]*c,b=n[y*2+1]=Z+$[1]*c,P=y,y++;else if(!_&&I===d-1)$[0]=Fe[1],$[1]=-Fe[0],Ie($,$),ee=k+$[0]*c,ue=Z+$[1]*c,Re=!0;else{Rs($,Ee,Fe);var Ae=$[1];$[1]=-$[0],$[0]=Ae,Ie($,$);var ye=Gt($,Ee),le=Math.sqrt(1-ye*ye),me=c*Math.min(10,1/le),xe=c*ye<0;if(R&&1/le>g&&xe){var _e=k+$[0]*c,ze=Z+$[1]*c,it=Math.acos(le)/2,Le=Math.tan(it)*Math.abs(c);n[y*2]=_e+$[1]*Le,n[y*2+1]=ze-$[0]*Le,y++,n[y*2]=_e-$[1]*Le,n[y*2+1]=ze+$[0]*Le,y++}else ee=k+$[0]*me,ue=Z+$[1]*me,Re=!0;if(Re){if(v&&S!=null){var Xe=Es(Y,se,S,b,k,Z,ee,ue,A,0);Xe>=-.01&&Xe<=1+.01&&(n[P*2]=ee=A[0],n[P*2+1]=ue=A[1])}S=n[y*2]=ee,b=n[y*2+1]=ue,P=y,y++}}}return M}function vt(r,n,h,d,o){var c=d!=null?[]:new Float32Array(r.length),g=n&&n.length?n[0]:r.length/2;if(Ke(r,c,0,g,0,h,d,o,!0),n)for(var _=0;_<n.length;_++){var v=n[_],R=n[_+1]||r.length/2;Ke(r,c,v,R,d!=null?c.length/2:v,h,d,o,!1)}return c}function et(r,n,h,d){for(var o=0;o<Math.floor((d-h)/2);o++)for(var c=0;c<n;c++){var g=(o+h)*n+c,_=(d-o-1)*n+c,v=r[g];r[g]=r[_],r[_]=v}return r}function Cs(r,n){var h=r.length/2,d=0,o=n&&n.length?n[0]:h;_t(r,d,o)>0&&et(r,2,d,o);for(var c=1;c<(n?n.length:0)+1;c++)d=n[c-1],o=n[c]||h,_t(r,d,o)<0&&et(r,2,d,o)}function Zt(r){r.depth=r.depth||1,r.bevelSize=r.bevelSize||0,r.bevelSegments=r.bevelSegments==null?2:r.bevelSegments,r.smoothBevel=r.smoothBevel||!1,r.simplify=r.simplify||0,r.smoothSide==null&&(r.smoothSide="auto"),r.smoothSideThreshold==null&&(r.smoothSideThreshold=.9),typeof r.depth=="number"&&(r.bevelSize=Math.min(r.bevelSegments>0?r.bevelSize:0,r.depth/2)),r.bevelSize>0||(r.bevelSegments=0),r.bevelSegments=Math.round(r.bevelSegments);var n=r.boundingRect;if(r.translate=r.translate||[0,0],r.scale=r.scale||[1,1],r.fitRect){var h=r.fitRect.x==null?n.x||0:r.fitRect.x,d=r.fitRect.y==null?n.y||0:r.fitRect.y,o=r.fitRect.width,c=r.fitRect.height;o==null?c!=null?o=c/n.height*n.width:(o=n.width,c=n.height):c==null&&(c=o/n.width*n.height),r.scale=[o/n.width,c/n.height],r.translate=[(h-n.x)*r.scale[0],(d-n.y)*r.scale[1]]}}function Is(r,n){function h(H,j,Y,se){H[0]=j,H[1]=Y,H[2]=se}for(var d=[],o=[],c=[],g=[],_=[],v=[],R=r.length,y=new Float32Array(n.length),M=0;M<R;){var S=r[M++]*3,b=r[M++]*3,P=r[M++]*3;h(d,n[S],n[S+1],n[S+2]),h(o,n[b],n[b+1],n[b+2]),h(c,n[P],n[P+1],n[P+2]),Xt(g,d,o),Xt(_,o,c),Ss(v,g,_);for(var A=0;A<3;A++)y[S+A]=y[S+A]+v[A],y[b+A]=y[b+A]+v[A],y[P+A]=y[P+A]+v[A]}for(var I=0;I<y.length;)h(v,y[I],y[I+1],y[I+2]),Ms(v,v),y[I++]=v[0],y[I++]=v[1],y[I++]=v[2];return y}var tt=[[0,0],[1,0],[1,1],[0,0],[1,1],[0,1]];function Qt(r,n,h,d,o,c){var g=n.vertices,_=n.topVertices,v=n.splittedMap,R=n.depth,y=n.rect,M=d-h,S=c.smoothBevel?1:2,b=Math.min(R/2,c.bevelSize),P=c.bevelSegments,A=o.vertex,I=Math.max(y.width,y.height,R),H=v?function(St){var Ws=(St+1)%M;return v[St+h]===v[Ws+h]}:function(St){return!1};if(b>0)for(var j=[0,0,1],Y=[],se=[0,0,-1],k=[],Z=0,K=new Float32Array(M),re=0;re<2;re++)for(var Re=re===0?R-b:b,ee=0;ee<=P*S;ee++){for(var ue=0,Ae=void 0,ye=void 0,le=0;le<M;le++){var me=(le%M+h)*2,xe=v?v[me/2]*2:me;Y[0]=g[me]-_[xe],Y[1]=g[me+1]-_[xe+1],Y[2]=0;var _e=Math.sqrt(Y[0]*Y[0]+Y[1]*Y[1]);Y[0]/=_e,Y[1]/=_e;var ze=(Math.floor(ee/S)+ee%S)/P;re===0?Yt(k,j,Y,ze):Yt(k,Y,se,ze);var it=re===0?ze:1-ze,Le=b*Math.sin(it*Math.PI/2),Xe=_e*Math.cos(it*Math.PI/2),yt=b*_e/Math.sqrt(Le*Le+Xe*Xe),We=k[0]*yt+_[xe],He=k[1]*yt+_[xe+1],bt=k[2]*yt+Re;if(r.position[o.vertex*3]=We,r.position[o.vertex*3+1]=He,r.position[o.vertex*3+2]=bt,le>0&&(ue+=Math.sqrt((Ae-We)*(Ae-We)+(ye-He)*(ye-He))),ee>0||re>0){var wt=(o.vertex-M)*3,ti=r.position[wt],ii=r.position[wt+1],si=r.position[wt+2];K[le]+=Math.sqrt((ti-We)*(ti-We)+(ii-He)*(ii-He)+(si-bt)*(si-bt))}if(r.uv[o.vertex*2]=ue/I,r.uv[o.vertex*2+1]=K[le]/I,Ae=We,ye=He,o.vertex++,!H(le)&&(S>1&&ee%S||S===1&&ee>=1))for(var st=0;st<6;st++){var ks=(tt[st][0]+le)%M,Us=tt[st][1]+Z;r.indices[o.index++]=(Us-1)*M+ks+A}}Z++}else for(var Pt=0;Pt<2;Pt++)for(var ri=Pt===0?R:0,ai=0,Tt=void 0,Rt=void 0,rt=0;rt<M;rt++){var ni=(rt+h)*2,at=g[ni],nt=g[ni+1],Mt=o.vertex*3,hi=o.vertex*2;r.position[Mt]=at,r.position[Mt+1]=nt,r.position[Mt+2]=ri,rt>0&&(ai+=Math.sqrt((Tt-at)*(Tt-at)+(Rt-nt)*(Rt-nt))),r.uv[hi]=ai/I,r.uv[hi+1]=ri/I,Tt=at,Rt=nt,o.vertex++}for(var Vs=b>0?P*S+1:1,ht=0;ht<M;ht++)if(!H(ht))for(var lt=0;lt<6;lt++){var Bs=(tt[lt][0]+ht)%M,Ns=tt[lt][1]+Vs;r.indices[o.index++]=(Ns-1)*M+Bs+A}}function Fs(r,n,h,d){var o=r.indices,c=r.topVertices,g=r.rect,_=r.depth;if(!(c.length<=4)){for(var v=h.vertex,R=o.length,y=0;y<R;y++)n.indices[h.index++]=v+o[y];for(var M=Math.max(g.width,g.height),S=0;S<(d.excludeBottom?1:2);S++)for(var b=0;b<c.length;b+=2){var P=c[b],A=c[b+1],I=h.vertex*3,H=h.vertex*2;n.position[I]=P,n.position[I+1]=A,n.position[I+2]=(1-S)*_,n.uv[H]=(P-g.x)/M,n.uv[H+1]=(A-g.y)/M,h.vertex++}if(!d.excludeBottom)for(var j=c.length/2,Y=0;Y<R;Y+=3)for(var se=0;se<3;se++)n.indices[h.index++]=v+j+o[Y+2-se]}}function $t(r,n,h,d){var o=h==null||h==="auto";if(h===!0)return{vertices:r,holes:n};for(var c=[],g=n&&[],_=r.length/2,v=[],R=[],y=[],M=0,S=0,b=(n?n.length:0)+1,P=0;P<b;P++){P===0?S=n&&n.length?n[0]:_:(M=n[P-1],S=n[P]||_);for(var A=M;A<S;A++){var I=r[A*2],H=r[A*2+1],j=A===S-1?M:A+1,Y=r[j*2],se=r[j*2+1];if(o){var k=A===M?S-1:A-1,Z=r[k*2],K=r[k*2+1];v[0]=Z-I,v[1]=K-H,R[0]=Y-I,R[1]=se-H,Ie(v,v),Ie(R,R);var re=Gt(v,R)*.5+.5;1-re>d?(c.push(I,H),y.push(A)):(c.push(I,H,I,H),y.push(A,A))}else c.push(I,H,I,H),y.push(A,A)}P<b-1&&g&&g.push(c.length/2)}return{vertices:new Float32Array(c),splittedMap:y,holes:g}}function Jt(r,n){for(var h=0,d=0,o=0;o<r.length;o++){var c=r[o],g=c.indices,_=c.vertices,v=c.splittedMap,R=c.topVertices,y=c.holes,M=c.depth,S=Math.min(M/2,n.bevelSize),b=S>0?n.bevelSegments:0;y=y||[],h+=g.length*(n.excludeBottom?1:2),d+=R.length/2*(n.excludeBottom?1:2);for(var P=2+b*2,A=0,I=0,H=0;H<y.length+1;H++){H===0?I=y.length?y[0]:_.length/2:(A=y[H-1],I=y[H]||_.length/2);var j=v?v[I-1]+1:I,Y=v?v[A]:A;h+=(j-Y)*6*(P-1);var se=I-A;d+=se*P+(n.smoothBevel?0:b*se*2)}}for(var k={position:new Float32Array(d*3),indices:new(d>65535?Uint32Array:Uint16Array)(h),uv:new Float32Array(d*2)},Z={vertex:0,index:0},K=0;K<r.length;K++)Fs(r[K],k,Z,n);for(var re=0;re<r.length;re++){var Re=r[re],ee=Re.holes,ue=Re.vertices,Ae=ue.length/2,ye=0,le=ee&&ee.length?ee[0]:Ae;if(Qt(k,r[re],ye,le,Z,n),ee)for(var me=0;me<ee.length;me++)ye=ee[me],le=ee[me+1]||Ae,Qt(k,r[re],ye,le,Z,n)}for(var xe=0;xe<k.uv.length;xe++){var _e=k.uv[xe];_e>0&&Math.round(_e)===_e?k.uv[xe]=1:k.uv[xe]=_e%1}return k.normal=Is(k.indices,k.position),k.boundingRect=r[0]&&r[0].rect,k}function zs(r,n,h){for(var d=h.lineWidth,o=r.length,c=new Float32Array(o*2),g=h.translate||[0,0],_=h.scale||[1,1],v=0,R=0;v<o;v++)c[R++]=r[v][0]*_[0]+g[0],c[R++]=r[v][1]*_[1]+g[1];_t(c,0,o)<0&&et(c,2,0,o);var y=[],M=[],S=h.miterLimit,b=Ke(c,M,0,o,0,-d/2,S,!1,!0);et(c,2,0,o);for(var P=Ke(c,y,0,o,0,-d/2,S,!1,!0),A=(y.length+M.length)/2,I=new Float32Array(A*2),H=0,j=M.length/2,Y=0;Y<M.length;Y++)I[H++]=M[Y];for(var se=0;se<y.length;se++)I[H++]=y[se];for(var k=new(A>65535?Uint32Array:Uint16Array)(((o-1)*2+(A-o*2))*3),Z=0,K=0;K<o-1;K++){var re=K+1;k[Z++]=j-1-b[K],k[Z++]=j-1-b[K]-1,k[Z++]=P[K]+1+j,k[Z++]=j-1-b[K],k[Z++]=P[K]+1+j,k[Z++]=P[K]+j,P[re]-P[K]===2?(k[Z++]=P[K]+2+j,k[Z++]=P[K]+1+j,k[Z++]=j-b[re]-1):b[re]-b[K]===2&&(k[Z++]=P[re]+j,k[Z++]=j-1-(b[K]+1),k[Z++]=j-1-(b[K]+2))}var Re=h.bevelSize>0?vt(I,[],h.bevelSize,null,!0):I,ee=h.boundingRect,ue=$t(I,null,h.smoothSide,h.smoothSideThreshold);return{vertices:ue.vertices,rawVertices:vertices,splittedMap:ue.splittedMap,indices:k,topVertices:Re,rect:{x:ee.x*_[0]+g[0],y:ee.y*_[1]+g[1],width:ee.width*_[0],height:ee.height*_[1]},depth:typeof h.depth=="function"?h.depth(n):h.depth,holes:[]}}function Ls(r,n){for(var h=[],d=0;d<r.length;d++){for(var o=r[d],c=[],g=o.length,_=o[g-1][0],v=o[g-1][1],R=0,y=0;y<g;y++){var M=o[y][0],S=o[y][1],b=M-_,P=S-v;R+=Math.sqrt(b*b+P*P),R>n&&(c.push(o[y]),R=0),_=M,v=S}c.length>=3&&h.push(c)}return h.length>0?h:null}function Os(r,n){for(var h=[],d=0;d<r.length;d++){var o=r[d];o=Ht(o,n,!0),o.length>=3&&h.push(o)}return h.length>0?h:null}function Kt(r,n){n=Object.assign({},n);for(var h=[1/0,1/0],d=[-1/0,-1/0],o=0;o<r.length;o++)Ne(r[o][0],h,d);n.boundingRect=n.boundingRect||{x:h[0],y:h[1],width:d[0]-h[0],height:d[1]-h[1]},Zt(n);for(var c=[],g=n.translate||[0,0],_=n.scale||[1,1],v=n.boundingRect,R={x:v.x*_[0]+g[0],y:v.y*_[1]+g[1],width:v.width*_[0],height:v.height*_[1]},y=Math.min(v.width,v.height)/1e5,M=0;M<r.length;M++){var S=Ls(r[M],y);if(S){var b=n.simplify/Math.max(_[0],_[1]);if(b>0&&(S=Os(S,b)),!!S){for(var P=Be.flatten(S),A=P.vertices,I=P.holes,H=P.dimensions,j=0;j<A.length;)A[j]=A[j++]*_[0]+g[0],A[j]=A[j++]*_[1]+g[1];if(Cs(A,I),H!==2)throw new Error("Only 2D polygon points are supported");var Y=n.bevelSize>0?vt(A,I,n.bevelSize,null,!0):A,se=qt(Y,I,H),k=$t(A,I,n.smoothSide,n.smoothSideThreshold);c.push({indices:se,vertices:k.vertices,rawVertices:A,topVertices:Y,holes:k.holes,splittedMap:k.splittedMap,rect:R,depth:typeof n.depth=="function"?n.depth(M):n.depth})}}}return Jt(c,n)}function ei(r,n){n=Object.assign({},n);for(var h=[1/0,1/0],d=[-1/0,-1/0],o=0;o<r.length;o++)Ne(r[o],h,d);n.boundingRect=n.boundingRect||{x:h[0],y:h[1],width:d[0]-h[0],height:d[1]-h[1]},Zt(n);var c=n.scale||[1,1];n.lineWidth==null&&(n.lineWidth=1),n.miterLimit==null&&(n.miterLimit=2);for(var g=[],_=0;_<r.length;_++){var v=r[_],R=n.simplify/Math.max(c[0],c[1]);R>0&&(v=Ht(v,R,!0)),g.push(zs(v,_,n))}return Jt(g,n)}function Ne(r,n,h){for(var d=0;d<r.length;d++)n[0]=Math.min(r[d][0],n[0]),n[1]=Math.min(r[d][1],n[1]),h[0]=Math.max(r[d][0],h[0]),h[1]=Math.max(r[d][1],h[1])}function Ds(r,n){n=Object.assign({},n);var h=[],d=[],o=[],c=[],g=[1/0,1/0],_=[-1/0,-1/0];(r.type==="LineString"||r.type==="MultiLineString"||r.type==="Polygon"||r.type==="MultiPolygon")&&(r={features:[{geometry:r}]});for(var v=0;v<r.features.length;v++){var R=r.features[v],y=R.geometry;if(y&&y.coordinates)switch(y.type){case"LineString":h.push(y.coordinates),o.push(v),Ne(y.coordinates,g,_);break;case"MultiLineString":for(var M=0;M<y.coordinates.length;M++)h.push(y.coordinates[M]),o.push(v),Ne(y.coordinates[M],g,_);break;case"Polygon":d.push(y.coordinates),c.push(v),Ne(y.coordinates[0],g,_);break;case"MultiPolygon":for(var S=0;S<y.coordinates.length;S++)d.push(y.coordinates[S]),c.push(v),Ne(y.coordinates[S][0],g,_);break}}n.boundingRect=n.boundingRect||{x:g[0],y:g[1],width:_[0]-g[0],height:_[1]-g[1]};var b=n.depth;return{polyline:ei(h,Object.assign(n,{depth:function(A){return typeof b=="function"?b(r.features[o[A]]):b}})),polygon:Kt(d,Object.assign(n,{depth:function(A){return typeof b=="function"?b(r.features[c[A]]):b}}))}}t.extrudeGeoJSON=Ds,t.extrudePolygon=Kt,t.extrudePolyline=ei,t.flatten=As,t.offsetPolygon=vt,t.triangulate=qt,Object.defineProperty(t,"__esModule",{value:!0})})})(bi,dt);class wi{constructor(e,{program:t=null,width:i=1,height:s=1}={}){if(this.type="Geometry",!e||e.type!=="Renderer")ne(this.type+": Renderer not passed as first argument",e);else if(!e.gl){ne(this.type+": Renderer WebGL context is undefined",e);return}this.renderer=e,this.gl=this.renderer.gl,this.definition={id:i*s+i,width:i,height:s},this.setDefaultAttributes(),this.setVerticesUVs()}restoreContext(e){this.program=null,this.setDefaultAttributes(),this.setVerticesUVs(),this.setProgram(e)}setDefaultAttributes(){this.attributes={vertexPosition:{name:"aVertexPosition",size:3,isActive:!1},textureCoord:{name:"aTextureCoord",size:3,isActive:!1}}}setVerticesUVs(){const e=this.renderer.cache.getGeometryFromID(this.definition.id);e?(this.attributes.vertexPosition.array=e.vertices,this.attributes.textureCoord.array=e.uvs):(this.computeVerticesUVs(),this.renderer.cache.addGeometry(this.definition.id,this.attributes.vertexPosition.array,this.attributes.textureCoord.array))}setProgram(e){this.program=e,this.initAttributes(),this.renderer._isWebGL2?(this._vao=this.gl.createVertexArray(),this.gl.bindVertexArray(this._vao)):this.renderer.extensions.OES_vertex_array_object&&(this._vao=this.renderer.extensions.OES_vertex_array_object.createVertexArrayOES(),this.renderer.extensions.OES_vertex_array_object.bindVertexArrayOES(this._vao)),this.initializeBuffers()}initAttributes(){for(const e in this.attributes){if(this.attributes[e].isActive=this.program.activeAttributes.includes(this.attributes[e].name),!this.attributes[e].isActive)return;this.attributes[e].location=this.gl.getAttribLocation(this.program.program,this.attributes[e].name),this.attributes[e].buffer=this.gl.createBuffer(),this.attributes[e].numberOfItems=this.definition.width*this.definition.height*this.attributes[e].size*2}}computeVerticesUVs(){this.attributes.vertexPosition.array=[],this.attributes.textureCoord.array=[];const e=this.attributes.vertexPosition.array,t=this.attributes.textureCoord.array;for(let i=0;i<this.definition.height;i++){const s=i/this.definition.height;for(let a=0;a<this.definition.width;a++){const l=a/this.definition.width;t.push(l),t.push(s),t.push(0),e.push((l-.5)*2),e.push((s-.5)*2),e.push(0),t.push(l+1/this.definition.width),t.push(s),t.push(0),e.push((l+1/this.definition.width-.5)*2),e.push((s-.5)*2),e.push(0),t.push(l),t.push(s+1/this.definition.height),t.push(0),e.push((l-.5)*2),e.push((s+1/this.definition.height-.5)*2),e.push(0),t.push(l),t.push(s+1/this.definition.height),t.push(0),e.push((l-.5)*2),e.push((s+1/this.definition.height-.5)*2),e.push(0),t.push(l+1/this.definition.width),t.push(s),t.push(0),e.push((l+1/this.definition.width-.5)*2),e.push((s-.5)*2),e.push(0),t.push(l+1/this.definition.width),t.push(s+1/this.definition.height),t.push(0),e.push((l+1/this.definition.width-.5)*2),e.push((s+1/this.definition.height-.5)*2),e.push(0)}}}initializeBuffers(){if(this.attributes){for(const e in this.attributes){if(!this.attributes[e].isActive)return;this.gl.enableVertexAttribArray(this.attributes[e].location),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.attributes[e].buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(this.attributes[e].array),this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.attributes[e].location,this.attributes[e].size,this.gl.FLOAT,!1,0,0)}this.renderer.state.currentGeometryID=this.definition.id}}bindBuffers(){if(this._vao)this.renderer._isWebGL2?this.gl.bindVertexArray(this._vao):this.renderer.extensions.OES_vertex_array_object.bindVertexArrayOES(this._vao);else for(const e in this.attributes){if(!this.attributes[e].isActive)return;this.gl.enableVertexAttribArray(this.attributes[e].location),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.attributes[e].buffer),this.gl.vertexAttribPointer(this.attributes[e].location,this.attributes[e].size,this.gl.FLOAT,!1,0,0)}this.renderer.state.currentGeometryID=this.definition.id}draw(){this.gl.drawArrays(this.gl.TRIANGLES,0,this.attributes.vertexPosition.numberOfItems)}dispose(){this._vao&&(this.renderer._isWebGL2?this.gl.deleteVertexArray(this._vao):this.renderer.extensions.OES_vertex_array_object.deleteVertexArrayOES(this._vao));for(const e in this.attributes){if(!this.attributes[e].isActive)return;this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.attributes[e].buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,1,this.gl.STATIC_DRAW),this.gl.deleteBuffer(this.attributes[e].buffer)}this.attributes=null,this.renderer.state.currentGeometryID=null}}class we{constructor(e=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])){this.type="Mat4",this.elements=e}setFromArray(e){for(let t=0;t<this.elements.length;t++)this.elements[t]=e[t];return this}copy(e){const t=e.elements;return this.elements[0]=t[0],this.elements[1]=t[1],this.elements[2]=t[2],this.elements[3]=t[3],this.elements[4]=t[4],this.elements[5]=t[5],this.elements[6]=t[6],this.elements[7]=t[7],this.elements[8]=t[8],this.elements[9]=t[9],this.elements[10]=t[10],this.elements[11]=t[11],this.elements[12]=t[12],this.elements[13]=t[13],this.elements[14]=t[14],this.elements[15]=t[15],this}clone(){return new we().copy(this)}multiply(e){const t=this.elements,i=e.elements;let s=new we;return s.elements[0]=i[0]*t[0]+i[1]*t[4]+i[2]*t[8]+i[3]*t[12],s.elements[1]=i[0]*t[1]+i[1]*t[5]+i[2]*t[9]+i[3]*t[13],s.elements[2]=i[0]*t[2]+i[1]*t[6]+i[2]*t[10]+i[3]*t[14],s.elements[3]=i[0]*t[3]+i[1]*t[7]+i[2]*t[11]+i[3]*t[15],s.elements[4]=i[4]*t[0]+i[5]*t[4]+i[6]*t[8]+i[7]*t[12],s.elements[5]=i[4]*t[1]+i[5]*t[5]+i[6]*t[9]+i[7]*t[13],s.elements[6]=i[4]*t[2]+i[5]*t[6]+i[6]*t[10]+i[7]*t[14],s.elements[7]=i[4]*t[3]+i[5]*t[7]+i[6]*t[11]+i[7]*t[15],s.elements[8]=i[8]*t[0]+i[9]*t[4]+i[10]*t[8]+i[11]*t[12],s.elements[9]=i[8]*t[1]+i[9]*t[5]+i[10]*t[9]+i[11]*t[13],s.elements[10]=i[8]*t[2]+i[9]*t[6]+i[10]*t[10]+i[11]*t[14],s.elements[11]=i[8]*t[3]+i[9]*t[7]+i[10]*t[11]+i[11]*t[15],s.elements[12]=i[12]*t[0]+i[13]*t[4]+i[14]*t[8]+i[15]*t[12],s.elements[13]=i[12]*t[1]+i[13]*t[5]+i[14]*t[9]+i[15]*t[13],s.elements[14]=i[12]*t[2]+i[13]*t[6]+i[14]*t[10]+i[15]*t[14],s.elements[15]=i[12]*t[3]+i[13]*t[7]+i[14]*t[11]+i[15]*t[15],s}getInverse(){const e=this.elements,t=new we,i=t.elements;let s=e[0],a=e[1],l=e[2],u=e[3],p=e[4],m=e[5],x=e[6],w=e[7],E=e[8],T=e[9],F=e[10],L=e[11],V=e[12],U=e[13],O=e[14],D=e[15],N=s*m-a*p,B=s*x-l*p,W=s*w-u*p,C=a*x-l*m,Q=a*w-u*m,J=l*w-u*x,X=E*U-T*V,G=E*O-F*V,ie=E*D-L*V,he=T*O-F*U,Te=T*D-L*U,ve=F*D-L*O,te=N*ve-B*Te+W*he+C*ie-Q*G+J*X;return te?(te=1/te,i[0]=(m*ve-x*Te+w*he)*te,i[1]=(l*Te-a*ve-u*he)*te,i[2]=(U*J-O*Q+D*C)*te,i[3]=(F*Q-T*J-L*C)*te,i[4]=(x*ie-p*ve-w*G)*te,i[5]=(s*ve-l*ie+u*G)*te,i[6]=(O*W-V*J-D*B)*te,i[7]=(E*J-F*W+L*B)*te,i[8]=(p*Te-m*ie+w*X)*te,i[9]=(a*ie-s*Te-u*X)*te,i[10]=(V*Q-U*W+D*N)*te,i[11]=(T*W-E*Q-L*N)*te,i[12]=(m*G-p*he-x*X)*te,i[13]=(s*he-a*G+l*X)*te,i[14]=(U*B-V*C-O*N)*te,i[15]=(E*C-T*B+F*N)*te,t):null}scale(e){let t=this.elements;return t[0]*=e.x,t[1]*=e.x,t[2]*=e.x,t[3]*=e.x,t[4]*=e.y,t[5]*=e.y,t[6]*=e.y,t[7]*=e.y,t[8]*=e.z,t[9]*=e.z,t[10]*=e.z,t[11]*=e.z,this}compose(e,t,i){let s=this.elements;const a=t.elements[0],l=t.elements[1],u=t.elements[2],p=t.elements[3],m=a+a,x=l+l,w=u+u,E=a*m,T=a*x,F=a*w,L=l*x,V=l*w,U=u*w,O=p*m,D=p*x,N=p*w,B=i.x,W=i.y,C=i.z;return s[0]=(1-(L+U))*B,s[1]=(T+N)*B,s[2]=(F-D)*B,s[3]=0,s[4]=(T-N)*W,s[5]=(1-(E+U))*W,s[6]=(V+O)*W,s[7]=0,s[8]=(F+D)*C,s[9]=(V-O)*C,s[10]=(1-(E+L))*C,s[11]=0,s[12]=e.x,s[13]=e.y,s[14]=e.z,s[15]=1,this}composeFromOrigin(e,t,i,s){let a=this.elements;const l=t.elements[0],u=t.elements[1],p=t.elements[2],m=t.elements[3],x=l+l,w=u+u,E=p+p,T=l*x,F=l*w,L=l*E,V=u*w,U=u*E,O=p*E,D=m*x,N=m*w,B=m*E,W=i.x,C=i.y,Q=i.z,J=s.x,X=s.y,G=s.z,ie=(1-(V+O))*W,he=(F+B)*W,Te=(L-N)*W,ve=(F-B)*C,te=(1-(T+O))*C,Se=(U+D)*C,Ue=(L+N)*Q,Ve=(U-D)*Q,Be=(1-(T+V))*Q;return a[0]=ie,a[1]=he,a[2]=Te,a[3]=0,a[4]=ve,a[5]=te,a[6]=Se,a[7]=0,a[8]=Ue,a[9]=Ve,a[10]=Be,a[11]=0,a[12]=e.x+J-(ie*J+ve*X+Ue*G),a[13]=e.y+X-(he*J+te*X+Ve*G),a[14]=e.z+G-(Te*J+Se*X+Be*G),a[15]=1,this}}class ae{constructor(e=0,t=e){this.type="Vec2",this._x=e,this._y=t}get x(){return this._x}get y(){return this._y}set x(e){const t=e!==this._x;this._x=e,t&&this._onChangeCallback&&this._onChangeCallback()}set y(e){const t=e!==this._y;this._y=e,t&&this._onChangeCallback&&this._onChangeCallback()}onChange(e){return e&&(this._onChangeCallback=e),this}set(e,t){return this._x=e,this._y=t,this}add(e){return this._x+=e.x,this._y+=e.y,this}addScalar(e){return this._x+=e,this._y+=e,this}sub(e){return this._x-=e.x,this._y-=e.y,this}subScalar(e){return this._x-=e,this._y-=e,this}multiply(e){return this._x*=e.x,this._y*=e.y,this}multiplyScalar(e){return this._x*=e,this._y*=e,this}copy(e){return this._x=e.x,this._y=e.y,this}clone(){return new ae(this._x,this._y)}sanitizeNaNValuesWith(e){return this._x=isNaN(this._x)?e.x:parseFloat(this._x),this._y=isNaN(this._y)?e.y:parseFloat(this._y),this}max(e){return this._x=Math.max(this._x,e.x),this._y=Math.max(this._y,e.y),this}min(e){return this._x=Math.min(this._x,e.x),this._y=Math.min(this._y,e.y),this}equals(e){return this._x===e.x&&this._y===e.y}normalize(){let e=this._x*this._x+this._y*this._y;return e>0&&(e=1/Math.sqrt(e)),this._x*=e,this._y*=e,this}dot(e){return this._x*e.x+this._y*e.y}}class q{constructor(e=0,t=e,i=e){this.type="Vec3",this._x=e,this._y=t,this._z=i}get x(){return this._x}get y(){return this._y}get z(){return this._z}set x(e){const t=e!==this._x;this._x=e,t&&this._onChangeCallback&&this._onChangeCallback()}set y(e){const t=e!==this._y;this._y=e,t&&this._onChangeCallback&&this._onChangeCallback()}set z(e){const t=e!==this._z;this._z=e,t&&this._onChangeCallback&&this._onChangeCallback()}onChange(e){return e&&(this._onChangeCallback=e),this}set(e,t,i){return this._x=e,this._y=t,this._z=i,this}add(e){return this._x+=e.x,this._y+=e.y,this._z+=e.z,this}addScalar(e){return this._x+=e,this._y+=e,this._z+=e,this}sub(e){return this._x-=e.x,this._y-=e.y,this._z-=e.z,this}subScalar(e){return this._x-=e,this._y-=e,this._z-=e,this}multiply(e){return this._x*=e.x,this._y*=e.y,this._z*=e.z,this}multiplyScalar(e){return this._x*=e,this._y*=e,this._z*=e,this}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this}clone(){return new q(this._x,this._y,this._z)}sanitizeNaNValuesWith(e){return this._x=isNaN(this._x)?e.x:parseFloat(this._x),this._y=isNaN(this._y)?e.y:parseFloat(this._y),this._z=isNaN(this._z)?e.z:parseFloat(this._z),this}max(e){return this._x=Math.max(this._x,e.x),this._y=Math.max(this._y,e.y),this._z=Math.max(this._z,e.z),this}min(e){return this._x=Math.min(this._x,e.x),this._y=Math.min(this._y,e.y),this._z=Math.min(this._z,e.z),this}equals(e){return this._x===e.x&&this._y===e.y&&this._z===e.z}normalize(){let e=this._x*this._x+this._y*this._y+this._z*this._z;return e>0&&(e=1/Math.sqrt(e)),this._x*=e,this._y*=e,this._z*=e,this}dot(e){return this._x*e.x+this._y*e.y+this._z*e.z}applyMat4(e){const t=this._x,i=this._y,s=this._z,a=e.elements;let l=a[3]*t+a[7]*i+a[11]*s+a[15];return l=l||1,this._x=(a[0]*t+a[4]*i+a[8]*s+a[12])/l,this._y=(a[1]*t+a[5]*i+a[9]*s+a[13])/l,this._z=(a[2]*t+a[6]*i+a[10]*s+a[14])/l,this}applyQuat(e){const t=this._x,i=this._y,s=this._z,a=e.elements[0],l=e.elements[1],u=e.elements[2],p=e.elements[3],m=p*t+l*s-u*i,x=p*i+u*t-a*s,w=p*s+a*i-l*t,E=-a*t-l*i-u*s;return this._x=m*p+E*-a+x*-u-w*-l,this._y=x*p+E*-l+w*-a-m*-u,this._z=w*p+E*-u+m*-l-x*-a,this}project(e){return this.applyMat4(e.viewMatrix).applyMat4(e.projectionMatrix),this}unproject(e){return this.applyMat4(e.projectionMatrix.getInverse()).applyMat4(e.worldMatrix),this}}const ct=new ae,Pi=new q,Ti=new we;class Oe{constructor(e,{isFBOTexture:t=!1,fromTexture:i=!1,loader:s,sampler:a,floatingPoint:l="none",premultiplyAlpha:u=!1,anisotropy:p=1,generateMipmap:m=null,wrapS:x,wrapT:w,minFilter:E,magFilter:T}={}){if(this.type="Texture",e=e&&e.renderer||e,!e||e.type!=="Renderer")ne(this.type+": Renderer not passed as first argument",e);else if(!e.gl){e.production||ne(this.type+": Unable to create a "+this.type+" because the Renderer WebGL context is not defined");return}if(this.renderer=e,this.gl=this.renderer.gl,this.uuid=ot(),this._globalParameters={unpackAlignment:4,flipY:!t,premultiplyAlpha:!1,shouldPremultiplyAlpha:u,floatingPoint:l,type:this.gl.UNSIGNED_BYTE,internalFormat:this.gl.RGBA,format:this.gl.RGBA},this.parameters={anisotropy:p,generateMipmap:m,wrapS:x||this.gl.CLAMP_TO_EDGE,wrapT:w||this.gl.CLAMP_TO_EDGE,minFilter:E||this.gl.LINEAR,magFilter:T||this.gl.LINEAR,_shouldUpdate:!0},this._initState(),this.sourceType=t?"fbo":"empty",this._useCache=!0,this._samplerName=a,this._sampler={isActive:!1,isTextureBound:!1,texture:this.gl.createTexture()},this._textureMatrix={matrix:new we,isActive:!1},this._size={width:1,height:1},this.scale=new ae(1),this.scale.onChange(()=>this.resize()),this.offset=new ae,this.offset.onChange(()=>this.resize()),this._loader=s,this._sourceLoaded=!1,this._uploaded=!1,this._willUpdate=!1,this.shouldUpdate=!1,this._forceUpdate=!1,this.userData={},this._canDraw=!1,i){this._copyOnInit=!0,this._copiedFrom=i;return}this._copyOnInit=!1,this._initTexture()}_initState(){this._state={anisotropy:1,generateMipmap:!1,wrapS:null,wrapT:null,minFilter:null,magFilter:this.gl.LINEAR}}_initTexture(){this.gl.bindTexture(this.gl.TEXTURE_2D,this._sampler.texture),this.sourceType==="empty"&&(this._globalParameters.flipY=!1,this._updateGlobalTexParameters(),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,1,1,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,new Uint8Array([0,0,0,255])),this._canDraw=!0)}_restoreFromTexture(){this._copyOnInit||this._initTexture(),this._parent&&(this._setTextureUniforms(),this._setSize()),this.copy(this._copiedFrom),this._canDraw=!0}_restoreContext(){if(this._canDraw=!1,this._sampler.texture=this.gl.createTexture(),this._sampler.isActive=!1,this._sampler.isTextureBound=!1,this._textureMatrix.isActive=!1,this._initState(),this._state.generateMipmap=!1,this.parameters._shouldUpdate=!0,!this._copiedFrom)this._initTexture(),this._parent&&this._setParent(),this.source&&(this.setSource(this.source),this.sourceType==="image"?this.renderer.cache.addTexture(this):this.needUpdate()),this._canDraw=!0;else{const e=this.renderer.nextRender.add(()=>{this._copiedFrom._canDraw&&(this._restoreFromTexture(),e.keep=!1)},!0)}}addParent(e){if(!e||e.type!=="Plane"&&e.type!=="PingPongPlane"&&e.type!=="ShaderPass"&&e.type!=="RenderTarget"){this.renderer.production||z(this.type+": cannot add texture as a child of ",e," because it is not a valid parent");return}this._parent=e,this.index=this._parent.textures.length,this._parent.textures.push(this),this._setParent()}_setParent(){if(this._sampler.name=this._samplerName||"uSampler"+this.index,this._textureMatrix.name=this._samplerName?this._samplerName+"Matrix":"uTextureMatrix"+this.index,this._parent._program){if(!this._parent._program.compiled){this.renderer.production||z(this.type+": Unable to create the texture because the program is not valid");return}if(this._setTextureUniforms(),this._copyOnInit){const e=this.renderer.nextRender.add(()=>{this._copiedFrom._canDraw&&this._copiedFrom._uploaded&&(this.copy(this._copiedFrom),e.keep=!1)},!0);return}this.source?this._parent.loader&&this._parent.loader._addSourceToParent(this.source,this.sourceType):this._size={width:this._parent._boundingRect.document.width,height:this._parent._boundingRect.document.height},this._setSize()}else this._parent.type==="RenderTarget"&&(this._size={width:this._parent._size&&this._parent._size.width||this.renderer._boundingRect.width,height:this._parent._size&&this._parent._size.height||this.renderer._boundingRect.height},this._upload(),this._updateTexParameters(),this._canDraw=!0)}hasParent(){return!!this._parent}_setTextureUniforms(){const e=this._parent._program.activeUniforms;for(let t=0;t<e.textures.length;t++)e.textures[t]===this._sampler.name&&(this._sampler.isActive=!0,this.renderer.useProgram(this._parent._program),this._sampler.location=this.gl.getUniformLocation(this._parent._program.program,this._sampler.name),e.textureMatrices.find(s=>s===this._textureMatrix.name)&&(this._textureMatrix.isActive=!0,this._textureMatrix.location=this.gl.getUniformLocation(this._parent._program.program,this._textureMatrix.name)),this.gl.uniform1i(this._sampler.location,this.index))}copy(e){if(!e||e.type!=="Texture"){this.renderer.production||z(this.type+": Unable to set the texture from texture:",e);return}this._globalParameters=Object.assign({},e._globalParameters),this._state=Object.assign({},e._state),this.parameters.generateMipmap=e.parameters.generateMipmap,this._state.generateMipmap=null,this._size=e._size,!this._sourceLoaded&&e._sourceLoaded&&this._onSourceLoadedCallback&&this._onSourceLoadedCallback(),this._sourceLoaded=e._sourceLoaded,!this._uploaded&&e._uploaded&&this._onSourceUploadedCallback&&this._onSourceUploadedCallback(),this._uploaded=e._uploaded,this.sourceType=e.sourceType,this.source=e.source,this._videoFrameCallbackID=e._videoFrameCallbackID,this._sampler.texture=e._sampler.texture,this._copiedFrom=e,this._parent&&this._parent._program&&(!this._canDraw||!this._textureMatrix.matrix)&&(this._setSize(),this._canDraw=!0),this._updateTexParameters(),this.renderer.needRender()}setSource(e){this._sourceLoaded||this.renderer.nextRender.add(()=>this._onSourceLoadedCallback&&this._onSourceLoadedCallback());const t=e.tagName.toUpperCase()==="IMG"?"image":e.tagName.toLowerCase();if((t==="video"||t==="canvas")&&(this._useCache=!1),this._useCache){const i=this.renderer.cache.getTextureFromSource(e);if(i&&i.uuid!==this.uuid){this._uploaded||(this.renderer.nextRender.add(()=>this._onSourceUploadedCallback&&this._onSourceUploadedCallback()),this._uploaded=!0),this.copy(i),this.resize();return}}if(this.sourceType==="empty"||this.sourceType!==t)if(t==="video")this._willUpdate=!1,this.shouldUpdate=!0;else if(t==="canvas")this._willUpdate=!0,this.shouldUpdate=!0;else if(t==="image")this._willUpdate=!1,this.shouldUpdate=!1;else{this.renderer.production||z(this.type+": this HTML tag could not be converted into a texture:",e.tagName);return}this.source=e,this.sourceType=t,this._size={width:this.source.naturalWidth||this.source.width||this.source.videoWidth,height:this.source.naturalHeight||this.source.height||this.source.videoHeight},this._sourceLoaded=!0,this.gl.bindTexture(this.gl.TEXTURE_2D,this._sampler.texture),this.resize(),this._globalParameters.flipY=!0,this._globalParameters.premultiplyAlpha=this._globalParameters.shouldPremultiplyAlpha,this.sourceType==="image"&&(this.parameters.generateMipmap=this.parameters.generateMipmap||this.parameters.generateMipmap===null,this.parameters._shouldUpdate=this.parameters.generateMipmap,this._state.generateMipmap=!1,this._upload()),this.renderer.needRender()}_updateGlobalTexParameters(){this.renderer.state.unpackAlignment!==this._globalParameters.unpackAlignment&&(this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,this._globalParameters.unpackAlignment),this.renderer.state.unpackAlignment=this._globalParameters.unpackAlignment),this.renderer.state.flipY!==this._globalParameters.flipY&&(this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,this._globalParameters.flipY),this.renderer.state.flipY=this._globalParameters.flipY),this.renderer.state.premultiplyAlpha!==this._globalParameters.premultiplyAlpha&&(this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this._globalParameters.premultiplyAlpha),this.renderer.state.premultiplyAlpha=this._globalParameters.premultiplyAlpha),this._globalParameters.floatingPoint==="half-float"?this.renderer._isWebGL2&&this.renderer.extensions.EXT_color_buffer_float?(this._globalParameters.internalFormat=this.gl.RGBA16F,this._globalParameters.type=this.gl.HALF_FLOAT):this.renderer.extensions.OES_texture_half_float?this._globalParameters.type=this.renderer.extensions.OES_texture_half_float.HALF_FLOAT_OES:this.renderer.production||z(this.type+": could not use half-float textures because the extension is not available"):this._globalParameters.floatingPoint==="float"&&(this.renderer._isWebGL2&&this.renderer.extensions.EXT_color_buffer_float?(this._globalParameters.internalFormat=this.gl.RGBA16F,this._globalParameters.type=this.gl.FLOAT):this.renderer.extensions.OES_texture_float?this._globalParameters.type=this.renderer.extensions.OES_texture_half_float.FLOAT:this.renderer.production||z(this.type+": could not use float textures because the extension is not available"))}_updateTexParameters(){this.index&&this.renderer.state.activeTexture!==this.index&&this._bindTexture(),this.parameters.wrapS!==this._state.wrapS&&(!this.renderer._isWebGL2&&(!be(this._size.width)||!be(this._size.height))&&(this.parameters.wrapS=this.gl.CLAMP_TO_EDGE),this.parameters.wrapS!==this.gl.REPEAT&&this.parameters.wrapS!==this.gl.CLAMP_TO_EDGE&&this.parameters.wrapS!==this.gl.MIRRORED_REPEAT&&(this.renderer.production||z(this.type+": Wrong wrapS value",this.parameters.wrapS,"for this texture:",this,`
gl.CLAMP_TO_EDGE wrapping will be used instead`),this.parameters.wrapS=this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.parameters.wrapS),this._state.wrapS=this.parameters.wrapS),this.parameters.wrapT!==this._state.wrapT&&(!this.renderer._isWebGL2&&(!be(this._size.width)||!be(this._size.height))&&(this.parameters.wrapT=this.gl.CLAMP_TO_EDGE),this.parameters.wrapT!==this.gl.REPEAT&&this.parameters.wrapT!==this.gl.CLAMP_TO_EDGE&&this.parameters.wrapT!==this.gl.MIRRORED_REPEAT&&(this.renderer.production||z(this.type+": Wrong wrapT value",this.parameters.wrapT,"for this texture:",this,`
gl.CLAMP_TO_EDGE wrapping will be used instead`),this.parameters.wrapT=this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.parameters.wrapT),this._state.wrapT=this.parameters.wrapT),this.parameters.generateMipmap&&!this._state.generateMipmap&&this.source&&(!this.renderer._isWebGL2&&(!be(this._size.width)||!be(this._size.height))?this.parameters.generateMipmap=!1:this.gl.generateMipmap(this.gl.TEXTURE_2D),this._state.generateMipmap=this.parameters.generateMipmap),this.parameters.minFilter!==this._state.minFilter&&(!this.renderer._isWebGL2&&(!be(this._size.width)||!be(this._size.height))&&(this.parameters.minFilter=this.gl.LINEAR),!this.parameters.generateMipmap&&this.parameters.generateMipmap!==null&&(this.parameters.minFilter=this.gl.LINEAR),this.parameters.minFilter!==this.gl.LINEAR&&this.parameters.minFilter!==this.gl.NEAREST&&this.parameters.minFilter!==this.gl.NEAREST_MIPMAP_NEAREST&&this.parameters.minFilter!==this.gl.LINEAR_MIPMAP_NEAREST&&this.parameters.minFilter!==this.gl.NEAREST_MIPMAP_LINEAR&&this.parameters.minFilter!==this.gl.LINEAR_MIPMAP_LINEAR&&(this.renderer.production||z(this.type+": Wrong minFilter value",this.parameters.minFilter,"for this texture:",this,`
gl.LINEAR filtering will be used instead`),this.parameters.minFilter=this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.parameters.minFilter),this._state.minFilter=this.parameters.minFilter),this.parameters.magFilter!==this._state.magFilter&&(!this.renderer._isWebGL2&&(!be(this._size.width)||!be(this._size.height))&&(this.parameters.magFilter=this.gl.LINEAR),this.parameters.magFilter!==this.gl.LINEAR&&this.parameters.magFilter!==this.gl.NEAREST&&(this.renderer.production||z(this.type+": Wrong magFilter value",this.parameters.magFilter,"for this texture:",this,`
gl.LINEAR filtering will be used instead`),this.parameters.magFilter=this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.parameters.magFilter),this._state.magFilter=this.parameters.magFilter);const e=this.renderer.extensions.EXT_texture_filter_anisotropic;if(e&&this.parameters.anisotropy!==this._state.anisotropy){const t=this.gl.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT);this.parameters.anisotropy=Math.max(1,Math.min(this.parameters.anisotropy,t)),this.gl.texParameterf(this.gl.TEXTURE_2D,e.TEXTURE_MAX_ANISOTROPY_EXT,this.parameters.anisotropy),this._state.anisotropy=this.parameters.anisotropy}}setWrapS(e){this.parameters.wrapS!==e&&(this.parameters.wrapS=e,this.parameters._shouldUpdate=!0)}setWrapT(e){this.parameters.wrapT!==e&&(this.parameters.wrapT=e,this.parameters._shouldUpdate=!0)}setMinFilter(e){this.parameters.minFilter!==e&&(this.parameters.minFilter=e,this.parameters._shouldUpdate=!0)}setMagFilter(e){this.parameters.magFilter!==e&&(this.parameters.magFilter=e,this.parameters._shouldUpdate=!0)}setAnisotropy(e){e=isNaN(e)?this.parameters.anisotropy:e,this.parameters.anisotropy!==e&&(this.parameters.anisotropy=e,this.parameters._shouldUpdate=!0)}needUpdate(){this._forceUpdate=!0}_videoFrameCallback(){if(this._willUpdate=!0,this.source)this.source.requestVideoFrameCallback(()=>this._videoFrameCallback());else{const e=this.renderer.nextRender.add(()=>{this.source&&(e.keep=!1,this.source.requestVideoFrameCallback(()=>this._videoFrameCallback()))},!0)}}_upload(){this._updateGlobalTexParameters(),this.source?this.gl.texImage2D(this.gl.TEXTURE_2D,0,this._globalParameters.internalFormat,this._globalParameters.format,this._globalParameters.type,this.source):this.sourceType==="fbo"&&this.gl.texImage2D(this.gl.TEXTURE_2D,0,this._globalParameters.internalFormat,this._size.width,this._size.height,0,this._globalParameters.format,this._globalParameters.type,this.source||null),this._uploaded||(this.renderer.nextRender.add(()=>this._onSourceUploadedCallback&&this._onSourceUploadedCallback()),this._uploaded=!0)}_getSizes(){if(this.sourceType==="fbo")return{parentWidth:this._parent._boundingRect.document.width,parentHeight:this._parent._boundingRect.document.height,sourceWidth:this._parent._boundingRect.document.width,sourceHeight:this._parent._boundingRect.document.height,xOffset:0,yOffset:0};const e=this._parent.scale?ct.set(this._parent.scale.x,this._parent.scale.y):ct.set(1,1),t=this._parent._boundingRect.document.width*e.x,i=this._parent._boundingRect.document.height*e.y,s=this._size.width,a=this._size.height,l=s/a,u=t/i;let p=0,m=0;return u>l?m=Math.min(0,i-t*(1/l)):u<l&&(p=Math.min(0,t-i*l)),{parentWidth:t,parentHeight:i,sourceWidth:s,sourceHeight:a,xOffset:p,yOffset:m}}setScale(e){if(!e.type||e.type!=="Vec2"){this.renderer.production||z(this.type+": Cannot set scale because the parameter passed is not of Vec2 type:",e);return}e.sanitizeNaNValuesWith(this.scale).max(ct.set(.001,.001)),e.equals(this.scale)||(this.scale.copy(e),this.resize())}setOffset(e){if(!e.type||e.type!=="Vec2"){this.renderer.production||z(this.type+": Cannot set offset because the parameter passed is not of Vec2 type:",scale);return}e.sanitizeNaNValuesWith(this.offset),e.equals(this.offset)||(this.offset.copy(e),this.resize())}_setSize(){if(this._parent&&this._parent._program){const e=this._getSizes();this._updateTextureMatrix(e)}}resize(){this.sourceType==="fbo"?(this._size={width:this._parent._size&&this._parent._size.width||this._parent._boundingRect.document.width,height:this._parent._size&&this._parent._size.height||this._parent._boundingRect.document.height},this._copiedFrom||(this.gl.bindTexture(this.gl.TEXTURE_2D,this._sampler.texture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this._globalParameters.internalFormat,this._size.width,this._size.height,0,this._globalParameters.format,this._globalParameters.type,null))):this.source&&(this._size={width:this.source.naturalWidth||this.source.width||this.source.videoWidth,height:this.source.naturalHeight||this.source.height||this.source.videoHeight}),this._setSize()}_updateTextureMatrix(e){const t=Pi.set(e.parentWidth/(e.parentWidth-e.xOffset),e.parentHeight/(e.parentHeight-e.yOffset),1);t.x/=this.scale.x,t.y/=this.scale.y,this._textureMatrix.matrix=Ti.setFromArray([t.x,0,0,0,0,t.y,0,0,0,0,1,0,(1-t.x)/2+this.offset.x,(1-t.y)/2+this.offset.y,0,1]),this._updateMatrixUniform()}_updateMatrixUniform(){this._textureMatrix.isActive&&(this.renderer.useProgram(this._parent._program),this.gl.uniformMatrix4fv(this._textureMatrix.location,!1,this._textureMatrix.matrix.elements))}_onSourceLoaded(e){this.setSource(e),this.sourceType==="image"&&this.renderer.cache.addTexture(this)}_bindTexture(){this._canDraw&&(this.renderer.state.activeTexture!==this.index&&(this.gl.activeTexture(this.gl.TEXTURE0+this.index),this.renderer.state.activeTexture=this.index),this.gl.bindTexture(this.gl.TEXTURE_2D,this._sampler.texture),this._sampler.isTextureBound||(this._sampler.isTextureBound=!!this.gl.getParameter(this.gl.TEXTURE_BINDING_2D),this._sampler.isTextureBound&&this.renderer.needRender()))}_draw(){this._sampler.isActive&&(this._bindTexture(),this.sourceType==="video"&&this.source&&!this._videoFrameCallbackID&&this.source.readyState>=this.source.HAVE_CURRENT_DATA&&!this.source.paused&&(this._willUpdate=!0),(this._forceUpdate||this._willUpdate&&this.shouldUpdate)&&(this._state.generateMipmap=!1,this._upload()),this.sourceType==="video"&&(this._willUpdate=!1),this._forceUpdate=!1),this.parameters._shouldUpdate&&(this._updateTexParameters(),this.parameters._shouldUpdate=!1)}onSourceLoaded(e){return e&&(this._onSourceLoadedCallback=e),this}onSourceUploaded(e){return e&&(this._onSourceUploadedCallback=e),this}_dispose(e=!1){var i;this.sourceType==="video"||this.sourceType==="image"&&!this.renderer.state.isActive?(this._loader&&this._loader._removeSource(this),this.source=null):this.sourceType==="canvas"&&this.source&&(this.source.width=(i=this.source)==null?void 0:i.width,this.source=null),this._parent=null,this.gl&&!this._copiedFrom&&(e||this.sourceType!=="image"||!this.renderer.state.isActive)&&(this._canDraw=!1,this.renderer.cache.removeTexture(this),this.gl.activeTexture(this.gl.TEXTURE0+this.index),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.deleteTexture(this._sampler.texture))}}class It{constructor(e,t="anonymous"){if(this.type="TextureLoader",e=e&&e.renderer||e,!e||e.type!=="Renderer")ne(this.type+": Renderer not passed as first argument",e);else if(!e.gl){ne(this.type+": Renderer WebGL context is undefined",e);return}this.renderer=e,this.gl=this.renderer.gl,this.crossOrigin=t,this.elements=[]}_addElement(e,t,i,s){const a={source:e,texture:t,load:this._sourceLoaded.bind(this,e,t,i),error:this._sourceLoadError.bind(this,e,s)};return this.elements.push(a),a}_sourceLoadError(e,t,i){t&&t(e,i)}_sourceLoaded(e,t,i){t._sourceLoaded||(t._onSourceLoaded(e),this._parent&&(this._increment&&this._increment(),this.renderer.nextRender.add(()=>this._parent._onLoadingCallback&&this._parent._onLoadingCallback(t))),i&&i(t))}_getSourceType(e){let t;return typeof e=="string"?e.match(/\.(jpeg|jpg|jfif|pjpeg|pjp|gif|bmp|png|webp|svg|avif|apng)$/)!==null?t="image":e.match(/\.(webm|mp4|mpg|mpeg|avi|ogg|ogm|ogv|mov|av1)$/)!==null&&(t="video"):e.tagName.toUpperCase()==="IMG"?t="image":e.tagName.toUpperCase()==="VIDEO"?t="video":e.tagName.toUpperCase()==="CANVAS"&&(t="canvas"),t}_createImage(e){if(typeof e=="string"||!e.hasAttribute("crossOrigin")){const t=new Image;return t.crossOrigin=this.crossOrigin,typeof e=="string"?t.src=e:(t.src=e.src,e.hasAttribute("data-sampler")&&t.setAttribute("data-sampler",e.getAttribute("data-sampler"))),t}else return e}_createVideo(e){if(typeof e=="string"||e.getAttribute("crossOrigin")===null){const t=document.createElement("video");return t.crossOrigin=this.crossOrigin,typeof e=="string"?t.src=e:(t.src=e.src,e.hasAttribute("data-sampler")&&t.setAttribute("data-sampler",e.getAttribute("data-sampler"))),t}else return e}loadSource(e,t,i,s){switch(this._getSourceType(e)){case"image":this.loadImage(e,t,i,s);break;case"video":this.loadVideo(e,t,i,s);break;case"canvas":this.loadCanvas(e,t,i);break;default:this._sourceLoadError(e,s,"this source could not be converted into a texture: "+e);break}}loadSources(e,t,i,s){for(let a=0;a<e.length;a++)this.loadSource(e[a],t,i,s)}loadImage(e,t={},i,s){const a=this.renderer.cache.getTextureFromSource(e);let l=Object.assign({},t);if(this._parent&&(l=Object.assign(l,this._parent._texturesOptions)),l.loader=this,a){l.sampler=typeof e!="string"&&e.hasAttribute("data-sampler")?e.getAttribute("data-sampler"):l.sampler,l.fromTexture=a;const x=new Oe(this.renderer,l);this._sourceLoaded(a.source,x,i),this._parent&&this._addToParent(x,a.source,"image");return}const u=this._createImage(e);l.sampler=u.hasAttribute("data-sampler")?u.getAttribute("data-sampler"):l.sampler;const p=new Oe(this.renderer,l),m=this._addElement(u,p,i,s);u.complete?this._sourceLoaded(u,p,i):u.decode?u.decode().then(this._sourceLoaded.bind(this,u,p,i)).catch(()=>{u.addEventListener("load",m.load,!1),u.addEventListener("error",m.error,!1)}):(u.addEventListener("load",m.load,!1),u.addEventListener("error",m.error,!1)),this._parent&&this._addToParent(p,u,"image")}loadImages(e,t,i,s){for(let a=0;a<e.length;a++)this.loadImage(e[a],t,i,s)}loadVideo(e,t={},i,s){const a=this._createVideo(e);a.preload=!0,a.muted=!0,a.loop=!0,a.setAttribute("playsinline",""),a.crossOrigin=this.crossOrigin;let l=Object.assign({},t);this._parent&&(l=Object.assign(t,this._parent._texturesOptions)),l.loader=this,l.sampler=a.hasAttribute("data-sampler")?a.getAttribute("data-sampler"):l.sampler;const u=new Oe(this.renderer,l),p=this._addElement(a,u,i,s);a.addEventListener("canplaythrough",p.load,!1),a.addEventListener("error",p.error,!1),a.readyState>=a.HAVE_FUTURE_DATA&&i&&this._sourceLoaded(a,u,i),a.load(),this._addToParent&&this._addToParent(u,a,"video"),"requestVideoFrameCallback"in HTMLVideoElement.prototype&&(p.videoFrameCallback=u._videoFrameCallback.bind(u),u._videoFrameCallbackID=a.requestVideoFrameCallback(p.videoFrameCallback))}loadVideos(e,t,i,s){for(let a=0;a<e.length;a++)this.loadVideo(e[a],t,i,s)}loadCanvas(e,t={},i){let s=Object.assign({},t);this._parent&&(s=Object.assign(t,this._parent._texturesOptions)),s.loader=this,s.sampler=e.hasAttribute("data-sampler")?e.getAttribute("data-sampler"):s.sampler;const a=new Oe(this.renderer,s);this._addElement(e,a,i,null),this._sourceLoaded(e,a,i),this._parent&&this._addToParent(a,e,"canvas")}loadCanvases(e,t,i){for(let s=0;s<e.length;s++)this.loadCanvas(e[s],t,i)}_removeSource(e){const t=this.elements.find(i=>i.texture.uuid===e.uuid);t&&(e.sourceType==="image"?t.source.removeEventListener("load",t.load,!1):e.sourceType==="video"&&(t.videoFrameCallback&&e._videoFrameCallbackID&&t.source.cancelVideoFrameCallback(e._videoFrameCallbackID),t.source.removeEventListener("canplaythrough",t.load,!1),t.source.pause(),t.source.removeAttribute("src"),t.source.load()),t.source.removeEventListener("error",t.error,!1))}}class Ri extends It{constructor(e,t,{sourcesLoaded:i=0,sourcesToLoad:s=0,complete:a=!1,onComplete:l=()=>{}}={}){super(e,t.crossOrigin),this.type="PlaneTextureLoader",this._parent=t,this._parent.type!=="Plane"&&this._parent.type!=="PingPongPlane"&&this._parent.type!=="ShaderPass"&&(z(this.type+": Wrong parent type assigned to this loader"),this._parent=null),this.sourcesLoaded=i,this.sourcesToLoad=s,this.complete=a,this.onComplete=l}_setLoaderSize(e){this.sourcesToLoad=e,this.sourcesToLoad===0&&(this.complete=!0,this.renderer.nextRender.add(()=>this.onComplete&&this.onComplete()))}_increment(){this.sourcesLoaded++,this.sourcesLoaded>=this.sourcesToLoad&&!this.complete&&(this.complete=!0,this.renderer.nextRender.add(()=>this.onComplete&&this.onComplete()))}_addSourceToParent(e,t){if(t==="image"){const i=this._parent.images;!i.find(a=>a.src===e.src)&&i.push(e)}else if(t==="video"){const i=this._parent.videos;!i.find(a=>a.src===e.src)&&i.push(e)}else if(t==="canvas"){const i=this._parent.canvases;!i.find(a=>a.isSameNode(e))&&i.push(e)}}_addToParent(e,t,i){this._addSourceToParent(t,i),this._parent&&e.addParent(this._parent)}}class Mi{constructor(e,t="Mesh",{vertexShaderID:i,fragmentShaderID:s,vertexShader:a,fragmentShader:l,uniforms:u={},widthSegments:p=1,heightSegments:m=1,renderOrder:x=0,depthTest:w=!0,cullFace:E="back",texturesOptions:T={},crossOrigin:F="anonymous"}={}){if(this.type=t,e=e&&e.renderer||e,(!e||e.type!=="Renderer")&&(ne(this.type+": Curtains not passed as first argument or Curtains Renderer is missing",e),setTimeout(()=>{this._onErrorCallback&&this._onErrorCallback()},0)),this.renderer=e,this.gl=this.renderer.gl,!this.gl){this.renderer.production||ne(this.type+": Unable to create a "+this.type+" because the Renderer WebGL context is not defined"),setTimeout(()=>{this._onErrorCallback&&this._onErrorCallback()},0);return}this._canDraw=!1,this.renderOrder=x,this._depthTest=w,this.cullFace=E,this.cullFace!=="back"&&this.cullFace!=="front"&&this.cullFace!=="none"&&(this.cullFace="back"),this.textures=[],this._texturesOptions=Object.assign({premultiplyAlpha:!1,anisotropy:1,floatingPoint:"none",wrapS:this.gl.CLAMP_TO_EDGE,wrapT:this.gl.CLAMP_TO_EDGE,minFilter:this.gl.LINEAR,magFilter:this.gl.LINEAR},T),this.crossOrigin=F,!a&&i&&document.getElementById(i)&&(a=document.getElementById(i).innerHTML),!l&&s&&document.getElementById(s)&&(l=document.getElementById(s).innerHTML),this._initMesh(),p=parseInt(p),m=parseInt(m),this._geometry=new wi(this.renderer,{width:p,height:m}),this._program=new Ct(this.renderer,{parent:this,vertexShader:a,fragmentShader:l}),this._program.compiled?(this._program.createUniforms(u),this.uniforms=this._program.uniformsManager.uniforms,this._geometry.setProgram(this._program),this.renderer.onSceneChange()):this.renderer.nextRender.add(()=>this._onErrorCallback&&this._onErrorCallback())}_initMesh(){this.uuid=ot(),this.loader=new Ri(this.renderer,this,{sourcesLoaded:0,initSourcesToLoad:0,complete:!1,onComplete:()=>{this._onReadyCallback&&this._onReadyCallback(),this.renderer.needRender()}}),this.images=[],this.videos=[],this.canvases=[],this.userData={},this._canDraw=!0}_restoreContext(){this._canDraw=!1,this._matrices&&(this._matrices=null),this._program=new Ct(this.renderer,{parent:this,vertexShader:this._program.vsCode,fragmentShader:this._program.fsCode}),this._program.compiled&&(this._geometry.restoreContext(this._program),this._program.createUniforms(this.uniforms),this.uniforms=this._program.uniformsManager.uniforms,this._programRestored())}setRenderTarget(e){if(!e||e.type!=="RenderTarget"){this.renderer.production||z(this.type+": Could not set the render target because the argument passed is not a RenderTarget class object",e);return}this.type==="Plane"&&this.renderer.scene.removePlane(this),this.target=e,this.type==="Plane"&&this.renderer.scene.addPlane(this)}setRenderOrder(e=0){e=isNaN(e)?this.renderOrder:parseInt(e),e!==this.renderOrder&&(this.renderOrder=e,this.renderer.scene.setPlaneRenderOrder(this))}createTexture(e={}){const t=new Oe(this.renderer,Object.assign(e,this._texturesOptions));return t.addParent(this),t}addTexture(e){if(!e||e.type!=="Texture"){this.renderer.production||z(this.type+": cannot add ",e," to this "+this.type+" because it is not a valid texture");return}e.addParent(this)}loadSources(e,t={},i,s){for(let a=0;a<e.length;a++)this.loadSource(e[a],t,i,s)}loadSource(e,t={},i,s){this.loader.loadSource(e,Object.assign(t,this._texturesOptions),a=>{i&&i(a)},(a,l)=>{this.renderer.production||z(this.type+": this HTML tag could not be converted into a texture:",a.tagName),s&&s(a,l)})}loadImage(e,t={},i,s){this.loader.loadImage(e,Object.assign(t,this._texturesOptions),a=>{i&&i(a)},(a,l)=>{this.renderer.production||z(this.type+`: There has been an error:
`,l,`
while loading this image:
`,a),s&&s(a,l)})}loadVideo(e,t={},i,s){this.loader.loadVideo(e,Object.assign(t,this._texturesOptions),a=>{i&&i(a)},(a,l)=>{this.renderer.production||z(this.type+`: There has been an error:
`,l,`
while loading this video:
`,a),s&&s(a,l)})}loadCanvas(e,t={},i){this.loader.loadCanvas(e,Object.assign(t,this._texturesOptions),s=>{i&&i(s)})}loadImages(e,t={},i,s){for(let a=0;a<e.length;a++)this.loadImage(e[a],t,i,s)}loadVideos(e,t={},i,s){for(let a=0;a<e.length;a++)this.loadVideo(e[a],t,i,s)}loadCanvases(e,t={},i){for(let s=0;s<e.length;s++)this.loadCanvas(e[s],t,i)}playVideos(){for(let e=0;e<this.textures.length;e++){const t=this.textures[e];if(t.sourceType==="video"){const i=t.source.play();i!==void 0&&i.catch(s=>{this.renderer.production||z(this.type+": Could not play the video : ",s)})}}}_draw(){this.renderer.setDepthTest(this._depthTest),this.renderer.setFaceCulling(this.cullFace),this._program.updateUniforms(),this._geometry.bindBuffers(),this.renderer.state.forceBufferUpdate=!1;for(let e=0;e<this.textures.length;e++)if(this.textures[e]._draw(),this.textures[e]._sampler.isActive&&!this.textures[e]._sampler.isTextureBound)return;this._geometry.draw(),this.renderer.state.activeTexture=null,this._onAfterRenderCallback&&this._onAfterRenderCallback()}onError(e){return e&&(this._onErrorCallback=e),this}onLoading(e){return e&&(this._onLoadingCallback=e),this}onReady(e){return e&&(this._onReadyCallback=e),this}onRender(e){return e&&(this._onRenderCallback=e),this}onAfterRender(e){return e&&(this._onAfterRenderCallback=e),this}remove(){this._canDraw=!1,this.target&&this.renderer.bindFrameBuffer(null),this._dispose(),this.type==="Plane"?this.renderer.removePlane(this):this.type==="ShaderPass"&&(this.target&&(this.target._shaderPass=null,this.target.remove(),this.target=null),this.renderer.removeShaderPass(this))}_dispose(){if(this.gl){this._geometry&&this._geometry.dispose(),this.target&&this.type==="ShaderPass"&&(this.renderer.removeRenderTarget(this.target),this.textures.shift());for(let e=0;e<this.textures.length;e++)this.textures[e]._dispose();this.textures=[]}}}const Ft=new ae,Si=new ae;class Ei extends Mi{constructor(e,t,i="DOMMesh",{widthSegments:s,heightSegments:a,renderOrder:l,depthTest:u,cullFace:p,uniforms:m,vertexShaderID:x,fragmentShaderID:w,vertexShader:E,fragmentShader:T,texturesOptions:F,crossOrigin:L}={}){x=x||t&&t.getAttribute("data-vs-id"),w=w||t&&t.getAttribute("data-fs-id"),super(e,i,{widthSegments:s,heightSegments:a,renderOrder:l,depthTest:u,cullFace:p,uniforms:m,vertexShaderID:x,fragmentShaderID:w,vertexShader:E,fragmentShader:T,texturesOptions:F,crossOrigin:L}),this.gl&&(this.htmlElement=t,(!this.htmlElement||this.htmlElement.length===0)&&(this.renderer.production||z(this.type+": The HTML element you specified does not currently exists in the DOM")),this._setDocumentSizes())}_setDocumentSizes(){let e=this.htmlElement.getBoundingClientRect();this._boundingRect||(this._boundingRect={}),this._boundingRect.document={width:e.width*this.renderer.pixelRatio,height:e.height*this.renderer.pixelRatio,top:e.top*this.renderer.pixelRatio,left:e.left*this.renderer.pixelRatio}}getBoundingRect(){return{width:this._boundingRect.document.width,height:this._boundingRect.document.height,top:this._boundingRect.document.top,left:this._boundingRect.document.left,right:this._boundingRect.document.left+this._boundingRect.document.width,bottom:this._boundingRect.document.top+this._boundingRect.document.height}}resize(){this._setDocumentSizes(),this.type==="Plane"&&(this.setPerspective(this.camera.fov,this.camera.near,this.camera.far),this._setWorldSizes(),this._applyWorldPositions());for(let e=0;e<this.textures.length;e++)this.textures[e].resize();this.renderer.nextRender.add(()=>this._onAfterResizeCallback&&this._onAfterResizeCallback())}mouseToPlaneCoords(e){const t=this.scale?this.scale:Si.set(1,1),i=Ft.set((this._boundingRect.document.width-this._boundingRect.document.width*t.x)/2,(this._boundingRect.document.height-this._boundingRect.document.height*t.y)/2),s={width:this._boundingRect.document.width*t.x/this.renderer.pixelRatio,height:this._boundingRect.document.height*t.y/this.renderer.pixelRatio,top:(this._boundingRect.document.top+i.y)/this.renderer.pixelRatio,left:(this._boundingRect.document.left+i.x)/this.renderer.pixelRatio};return Ft.set((e.x-s.left)/s.width*2-1,1-(e.y-s.top)/s.height*2)}onAfterResize(e){return e&&(this._onAfterResizeCallback=e),this}}class Ai{constructor({fov:e=50,near:t=.1,far:i=150,width:s,height:a,pixelRatio:l=1}={}){this.position=new q,this.projectionMatrix=new we,this.worldMatrix=new we,this.viewMatrix=new we,this._shouldUpdate=!1,this.setSize(),this.setPerspective(e,t,i,s,a,l)}setFov(e){e=isNaN(e)?this.fov:parseFloat(e),e=Math.max(1,Math.min(e,179)),e!==this.fov&&(this.fov=e,this.setPosition(),this._shouldUpdate=!0),this.setCSSPerspective()}setNear(e){e=isNaN(e)?this.near:parseFloat(e),e=Math.max(e,.01),e!==this.near&&(this.near=e,this._shouldUpdate=!0)}setFar(e){e=isNaN(e)?this.far:parseFloat(e),e=Math.max(e,50),e!==this.far&&(this.far=e,this._shouldUpdate=!0)}setPixelRatio(e){e!==this.pixelRatio&&(this._shouldUpdate=!0),this.pixelRatio=e}setSize(e,t){(e!==this.width||t!==this.height)&&(this._shouldUpdate=!0),this.width=e,this.height=t}setPerspective(e,t,i,s,a,l){this.setPixelRatio(l),this.setSize(s,a),this.setFov(e),this.setNear(t),this.setFar(i),this._shouldUpdate&&this.updateProjectionMatrix()}setPosition(){this.position.set(0,0,1),this.worldMatrix.setFromArray([1,0,0,0,0,1,0,0,0,0,1,0,this.position.x,this.position.y,this.position.z,1]),this.viewMatrix=this.viewMatrix.copy(this.worldMatrix).getInverse()}setCSSPerspective(){this.CSSPerspective=Math.pow(Math.pow(this.width/(2*this.pixelRatio),2)+Math.pow(this.height/(2*this.pixelRatio),2),.5)/Math.tan(this.fov*.5*Math.PI/180)}getScreenRatiosFromFov(e=0){const t=this.position.z;e<t?e-=t:e+=t;const i=this.fov*Math.PI/180,s=2*Math.tan(i/2)*Math.abs(e);return{width:s*this.width/this.height,height:s}}updateProjectionMatrix(){const e=this.width/this.height,t=this.near*Math.tan(Math.PI/180*.5*this.fov),i=2*t,s=e*i,a=-.5*s,l=a+s,u=t-i,p=2*this.near/(l-a),m=2*this.near/(t-u),x=(l+a)/(l-a),w=(t+u)/(t-u),E=-(this.far+this.near)/(this.far-this.near),T=-2*this.far*this.near/(this.far-this.near);this.projectionMatrix.setFromArray([p,0,0,0,0,m,0,0,x,w,E,-1,0,0,T,0])}forceUpdate(){this._shouldUpdate=!0}cancelUpdate(){this._shouldUpdate=!1}}class Ze{constructor(e=new Float32Array([0,0,0,1]),t="XYZ"){this.type="Quat",this.elements=e,this.axisOrder=t}setFromArray(e){return this.elements[0]=e[0],this.elements[1]=e[1],this.elements[2]=e[2],this.elements[3]=e[3],this}setAxisOrder(e){switch(e=e.toUpperCase(),e){case"XYZ":case"YXZ":case"ZXY":case"ZYX":case"YZX":case"XZY":this.axisOrder=e;break;default:this.axisOrder="XYZ"}return this}copy(e){return this.elements=e.elements,this.axisOrder=e.axisOrder,this}clone(){return new Ze().copy(this)}equals(e){return this.elements[0]===e.elements[0]&&this.elements[1]===e.elements[1]&&this.elements[2]===e.elements[2]&&this.elements[3]===e.elements[3]&&this.axisOrder===e.axisOrder}setFromVec3(e){const t=e.x*.5,i=e.y*.5,s=e.z*.5,a=Math.cos(t),l=Math.cos(i),u=Math.cos(s),p=Math.sin(t),m=Math.sin(i),x=Math.sin(s);return this.axisOrder==="XYZ"?(this.elements[0]=p*l*u+a*m*x,this.elements[1]=a*m*u-p*l*x,this.elements[2]=a*l*x+p*m*u,this.elements[3]=a*l*u-p*m*x):this.axisOrder==="YXZ"?(this.elements[0]=p*l*u+a*m*x,this.elements[1]=a*m*u-p*l*x,this.elements[2]=a*l*x-p*m*u,this.elements[3]=a*l*u+p*m*x):this.axisOrder==="ZXY"?(this.elements[0]=p*l*u-a*m*x,this.elements[1]=a*m*u+p*l*x,this.elements[2]=a*l*x+p*m*u,this.elements[3]=a*l*u-p*m*x):this.axisOrder==="ZYX"?(this.elements[0]=p*l*u-a*m*x,this.elements[1]=a*m*u+p*l*x,this.elements[2]=a*l*x-p*m*u,this.elements[3]=a*l*u+p*m*x):this.axisOrder==="YZX"?(this.elements[0]=p*l*u+a*m*x,this.elements[1]=a*m*u+p*l*x,this.elements[2]=a*l*x-p*m*u,this.elements[3]=a*l*u-p*m*x):this.axisOrder==="XZY"&&(this.elements[0]=p*l*u-a*m*x,this.elements[1]=a*m*u-p*l*x,this.elements[2]=a*l*x+p*m*u,this.elements[3]=a*l*u+p*m*x),this}}const Ci=new ae,Ii=new q,Fi=new q,zi=new q,Li=new q,Oi=new q,Di=new q,ge=new q,pe=new q,zt=new Ze,ki=new q(.5,.5,0),Ui=new q,Vi=new q,Bi=new q,Ni=new q,Wi=new ae;class Lt extends Ei{constructor(e,t,{widthSegments:i,heightSegments:s,renderOrder:a,depthTest:l,cullFace:u,uniforms:p,vertexShaderID:m,fragmentShaderID:x,vertexShader:w,fragmentShader:E,texturesOptions:T,crossOrigin:F,alwaysDraw:L=!1,visible:V=!0,transparent:U=!1,drawCheckMargins:O={top:0,right:0,bottom:0,left:0},autoloadSources:D=!0,watchScroll:N=!0,fov:B=50}={}){super(e,t,"Plane",{widthSegments:i,heightSegments:s,renderOrder:a,depthTest:l,cullFace:u,uniforms:p,vertexShaderID:m,fragmentShaderID:x,vertexShader:w,fragmentShader:E,texturesOptions:T,crossOrigin:F}),this.gl&&(this.index=this.renderer.planes.length,this.target=null,this.alwaysDraw=L,this._shouldDraw=!0,this.visible=V,this._transparent=U,this.drawCheckMargins=O,this.autoloadSources=D,this.watchScroll=N,this._updateMVMatrix=!1,this.camera=new Ai({fov:B,width:this.renderer._boundingRect.width,height:this.renderer._boundingRect.height,pixelRatio:this.renderer.pixelRatio}),this._program.compiled&&(this._initPlane(),this.renderer.scene.addPlane(this),this.renderer.planes.push(this)))}_programRestored(){this.target&&this.setRenderTarget(this.renderer.renderTargets[this.target.index]),this._initMatrices(),this.setPerspective(this.camera.fov,this.camera.near,this.camera.far),this._setWorldSizes(),this._applyWorldPositions(),this.renderer.scene.addPlane(this);for(let e=0;e<this.textures.length;e++)this.textures[e]._parent=this,this.textures[e]._restoreContext();this._canDraw=!0}_initPlane(){this._initTransformValues(),this._initPositions(),this.setPerspective(this.camera.fov,this.camera.near,this.camera.far),this._initSources()}_initTransformValues(){this.rotation=new q,this.rotation.onChange(()=>this._applyRotation()),this.quaternion=new Ze,this.relativeTranslation=new q,this.relativeTranslation.onChange(()=>this._setTranslation()),this._translation=new q,this.scale=new q(1),this.scale.onChange(()=>{this.scale.z=1,this._applyScale()}),this.transformOrigin=new q(.5,.5,0),this.transformOrigin.onChange(()=>{this._setWorldTransformOrigin(),this._updateMVMatrix=!0})}resetPlane(e){this._initTransformValues(),this._setWorldTransformOrigin(),e!==null&&e?(this.htmlElement=e,this.resize()):!e&&!this.renderer.production&&z(this.type+": You are trying to reset a plane with a HTML element that does not exist. The old HTML element will be kept instead.")}removeRenderTarget(){this.target&&(this.renderer.scene.removePlane(this),this.target=null,this.renderer.scene.addPlane(this))}_initPositions(){this._initMatrices(),this._setWorldSizes(),this._applyWorldPositions()}_initMatrices(){const e=new we;this._matrices={world:{matrix:e},modelView:{name:"uMVMatrix",matrix:e,location:this.gl.getUniformLocation(this._program.program,"uMVMatrix")},projection:{name:"uPMatrix",matrix:e,location:this.gl.getUniformLocation(this._program.program,"uPMatrix")},modelViewProjection:{matrix:e}}}_setPerspectiveMatrix(){this.camera._shouldUpdate&&(this.renderer.useProgram(this._program),this.gl.uniformMatrix4fv(this._matrices.projection.location,!1,this._matrices.projection.matrix.elements)),this.camera.cancelUpdate()}setPerspective(e,t,i){this.camera.setPerspective(e,t,i,this.renderer._boundingRect.width,this.renderer._boundingRect.height,this.renderer.pixelRatio),this.renderer.state.isContextLost&&this.camera.forceUpdate(),this._matrices.projection.matrix=this.camera.projectionMatrix,this.camera._shouldUpdate&&(this._setWorldSizes(),this._applyWorldPositions(),this._translation.z=this.relativeTranslation.z/this.camera.CSSPerspective),this._updateMVMatrix=this.camera._shouldUpdate}_setMVMatrix(){this._updateMVMatrix&&(this._matrices.world.matrix=this._matrices.world.matrix.composeFromOrigin(this._translation,this.quaternion,this.scale,this._boundingRect.world.transformOrigin),this._matrices.world.matrix.scale({x:this._boundingRect.world.width,y:this._boundingRect.world.height,z:1}),this._matrices.modelView.matrix.copy(this._matrices.world.matrix),this._matrices.modelView.matrix.elements[14]-=this.camera.position.z,this._matrices.modelViewProjection.matrix=this._matrices.projection.matrix.multiply(this._matrices.modelView.matrix),this.alwaysDraw||this._shouldDrawCheck(),this.renderer.useProgram(this._program),this.gl.uniformMatrix4fv(this._matrices.modelView.location,!1,this._matrices.modelView.matrix.elements)),this._updateMVMatrix=!1}_setWorldTransformOrigin(){this._boundingRect.world.transformOrigin=new q((this.transformOrigin.x*2-1)*this._boundingRect.world.width,-(this.transformOrigin.y*2-1)*this._boundingRect.world.height,this.transformOrigin.z)}_documentToWorldSpace(e){return Fi.set(e.x*this.renderer.pixelRatio/this.renderer._boundingRect.width*this._boundingRect.world.ratios.width,-(e.y*this.renderer.pixelRatio/this.renderer._boundingRect.height)*this._boundingRect.world.ratios.height,e.z)}_setWorldSizes(){const e=this.camera.getScreenRatiosFromFov();this._boundingRect.world={width:this._boundingRect.document.width/this.renderer._boundingRect.width*e.width/2,height:this._boundingRect.document.height/this.renderer._boundingRect.height*e.height/2,ratios:e},this._setWorldTransformOrigin()}_setWorldPosition(){const e={x:this._boundingRect.document.width/2+this._boundingRect.document.left,y:this._boundingRect.document.height/2+this._boundingRect.document.top},t={x:this.renderer._boundingRect.width/2+this.renderer._boundingRect.left,y:this.renderer._boundingRect.height/2+this.renderer._boundingRect.top};this._boundingRect.world.top=(t.y-e.y)/this.renderer._boundingRect.height*this._boundingRect.world.ratios.height,this._boundingRect.world.left=(e.x-t.x)/this.renderer._boundingRect.width*this._boundingRect.world.ratios.width}setScale(e){if(!e.type||e.type!=="Vec2"){this.renderer.production||z(this.type+": Cannot set scale because the parameter passed is not of Vec2 type:",e);return}e.sanitizeNaNValuesWith(this.scale).max(Ci.set(.001,.001)),(e.x!==this.scale.x||e.y!==this.scale.y)&&(this.scale.set(e.x,e.y,1),this._applyScale())}_applyScale(){for(let e=0;e<this.textures.length;e++)this.textures[e].resize();this._updateMVMatrix=!0}setRotation(e){if(!e.type||e.type!=="Vec3"){this.renderer.production||z(this.type+": Cannot set rotation because the parameter passed is not of Vec3 type:",e);return}e.sanitizeNaNValuesWith(this.rotation),e.equals(this.rotation)||(this.rotation.copy(e),this._applyRotation())}_applyRotation(){this.quaternion.setFromVec3(this.rotation),this._updateMVMatrix=!0}setTransformOrigin(e){if(!e.type||e.type!=="Vec3"){this.renderer.production||z(this.type+": Cannot set transform origin because the parameter passed is not of Vec3 type:",e);return}e.sanitizeNaNValuesWith(this.transformOrigin),e.equals(this.transformOrigin)||(this.transformOrigin.copy(e),this._setWorldTransformOrigin(),this._updateMVMatrix=!0)}_setTranslation(){let e=Ii.set(0,0,0);this.relativeTranslation.equals(e)||(e=this._documentToWorldSpace(this.relativeTranslation)),this._translation.set(this._boundingRect.world.left+e.x,this._boundingRect.world.top+e.y,this.relativeTranslation.z/this.camera.CSSPerspective),this._updateMVMatrix=!0}setRelativeTranslation(e){if(!e.type||e.type!=="Vec3"){this.renderer.production||z(this.type+": Cannot set translation because the parameter passed is not of Vec3 type:",e);return}e.sanitizeNaNValuesWith(this.relativeTranslation),e.equals(this.relativeTranslation)||(this.relativeTranslation.copy(e),this._setTranslation())}_applyWorldPositions(){this._setWorldPosition(),this._setTranslation()}updatePosition(){this._setDocumentSizes(),this._applyWorldPositions()}updateScrollPosition(e,t){(e||t)&&(this._boundingRect.document.top+=t*this.renderer.pixelRatio,this._boundingRect.document.left+=e*this.renderer.pixelRatio,this._applyWorldPositions())}_getIntersection(e,t){let i=t.clone().sub(e),s=e.clone();for(;s.z>-1;)s.add(i);return s}_getNearPlaneIntersections(e,t,i){const s=this._matrices.modelViewProjection.matrix;if(i.length===1)i[0]===0?(t[0]=this._getIntersection(t[1],ge.set(.95,1,0).applyMat4(s)),t.push(this._getIntersection(t[3],pe.set(-1,-.95,0).applyMat4(s)))):i[0]===1?(t[1]=this._getIntersection(t[0],ge.set(-.95,1,0).applyMat4(s)),t.push(this._getIntersection(t[2],pe.set(1,-.95,0).applyMat4(s)))):i[0]===2?(t[2]=this._getIntersection(t[3],ge.set(-.95,-1,0).applyMat4(s)),t.push(this._getIntersection(t[1],pe.set(1,.95,0).applyMat4(s)))):i[0]===3&&(t[3]=this._getIntersection(t[2],ge.set(.95,-1,0).applyMat4(s)),t.push(this._getIntersection(t[0],pe.set(-1,.95,0).applyMat4(s))));else if(i.length===2)i[0]===0&&i[1]===1?(t[0]=this._getIntersection(t[3],ge.set(-1,-.95,0).applyMat4(s)),t[1]=this._getIntersection(t[2],pe.set(1,-.95,0).applyMat4(s))):i[0]===1&&i[1]===2?(t[1]=this._getIntersection(t[0],ge.set(-.95,1,0).applyMat4(s)),t[2]=this._getIntersection(t[3],pe.set(-.95,-1,0).applyMat4(s))):i[0]===2&&i[1]===3?(t[2]=this._getIntersection(t[1],ge.set(1,.95,0).applyMat4(s)),t[3]=this._getIntersection(t[0],pe.set(-1,.95,0).applyMat4(s))):i[0]===0&&i[1]===3&&(t[0]=this._getIntersection(t[1],ge.set(.95,1,0).applyMat4(s)),t[3]=this._getIntersection(t[2],pe.set(.95,-1,0).applyMat4(s)));else if(i.length===3){let a=0;for(let l=0;l<e.length;l++)i.includes(l)||(a=l);t=[t[a]],a===0?(t.push(this._getIntersection(t[0],ge.set(-.95,1,0).applyMat4(s))),t.push(this._getIntersection(t[0],pe.set(-1,.95,0).applyMat4(s)))):a===1?(t.push(this._getIntersection(t[0],ge.set(.95,1,0).applyMat4(s))),t.push(this._getIntersection(t[0],pe.set(1,.95,0).applyMat4(s)))):a===2?(t.push(this._getIntersection(t[0],ge.set(.95,-1,0).applyMat4(s))),t.push(this._getIntersection(t[0],pe.set(1,-.95,0).applyMat4(s)))):a===3&&(t.push(this._getIntersection(t[0],ge.set(-.95,-1,0).applyMat4(s))),t.push(this._getIntersection(t[0],pe.set(-1-.95,0).applyMat4(s))))}else for(let a=0;a<e.length;a++)t[a][0]=1e4,t[a][1]=1e4;return t}_getWorldCoords(){const e=[zi.set(-1,1,0),Li.set(1,1,0),Oi.set(1,-1,0),Di.set(-1,-1,0)];let t=[],i=[];for(let p=0;p<e.length;p++){const m=e[p].applyMat4(this._matrices.modelViewProjection.matrix);t.push(m),Math.abs(m.z)>1&&i.push(p)}i.length&&(t=this._getNearPlaneIntersections(e,t,i));let s=1/0,a=-1/0,l=1/0,u=-1/0;for(let p=0;p<t.length;p++){const m=t[p];m.x<s&&(s=m.x),m.x>a&&(a=m.x),m.y<l&&(l=m.y),m.y>u&&(u=m.y)}return{top:u,right:a,bottom:l,left:s}}_computeWebGLBoundingRect(){const e=this._getWorldCoords();let t={top:1-(e.top+1)/2,right:(e.right+1)/2,bottom:1-(e.bottom+1)/2,left:(e.left+1)/2};t.width=t.right-t.left,t.height=t.bottom-t.top,this._boundingRect.worldToDocument={width:t.width*this.renderer._boundingRect.width,height:t.height*this.renderer._boundingRect.height,top:t.top*this.renderer._boundingRect.height+this.renderer._boundingRect.top,left:t.left*this.renderer._boundingRect.width+this.renderer._boundingRect.left,right:t.left*this.renderer._boundingRect.width+this.renderer._boundingRect.left+t.width*this.renderer._boundingRect.width,bottom:t.top*this.renderer._boundingRect.height+this.renderer._boundingRect.top+t.height*this.renderer._boundingRect.height}}getWebGLBoundingRect(){if(this._matrices.modelViewProjection)(!this._boundingRect.worldToDocument||this.alwaysDraw)&&this._computeWebGLBoundingRect();else return this._boundingRect.document;return this._boundingRect.worldToDocument}_getWebGLDrawRect(){return this._computeWebGLBoundingRect(),{top:this._boundingRect.worldToDocument.top-this.drawCheckMargins.top,right:this._boundingRect.worldToDocument.right+this.drawCheckMargins.right,bottom:this._boundingRect.worldToDocument.bottom+this.drawCheckMargins.bottom,left:this._boundingRect.worldToDocument.left-this.drawCheckMargins.left}}_shouldDrawCheck(){const e=this._getWebGLDrawRect();Math.round(e.right)<=this.renderer._boundingRect.left||Math.round(e.left)>=this.renderer._boundingRect.left+this.renderer._boundingRect.width||Math.round(e.bottom)<=this.renderer._boundingRect.top||Math.round(e.top)>=this.renderer._boundingRect.top+this.renderer._boundingRect.height?this._shouldDraw&&(this._shouldDraw=!1,this.renderer.nextRender.add(()=>this._onLeaveViewCallback&&this._onLeaveViewCallback())):(this._shouldDraw||this.renderer.nextRender.add(()=>this._onReEnterViewCallback&&this._onReEnterViewCallback()),this._shouldDraw=!0)}isDrawn(){return this._canDraw&&this.visible&&(this._shouldDraw||this.alwaysDraw)}enableDepthTest(e){this._depthTest=e}_initSources(){let e=0;if(this.autoloadSources){const t=this.htmlElement.getElementsByTagName("img"),i=this.htmlElement.getElementsByTagName("video"),s=this.htmlElement.getElementsByTagName("canvas");t.length&&this.loadImages(t),i.length&&this.loadVideos(i),s.length&&this.loadCanvases(s),e=t.length+i.length+s.length}this.loader._setLoaderSize(e),this._canDraw=!0}_startDrawing(){this._canDraw&&(this._onRenderCallback&&this._onRenderCallback(),this.target?this.renderer.bindFrameBuffer(this.target):this.renderer.state.scenePassIndex===null&&this.renderer.bindFrameBuffer(null),this._setPerspectiveMatrix(),this._setMVMatrix(),(this.alwaysDraw||this._shouldDraw)&&this.visible&&this._draw())}mouseToPlaneCoords(e){if(zt.setAxisOrder(this.quaternion.axisOrder),zt.equals(this.quaternion)&&ki.equals(this.transformOrigin))return super.mouseToPlaneCoords(e);{const t={x:2*(e.x/(this.renderer._boundingRect.width/this.renderer.pixelRatio))-1,y:2*(1-e.y/(this.renderer._boundingRect.height/this.renderer.pixelRatio))-1},i=this.camera.position.clone(),s=Ui.set(t.x,t.y,-.5);s.unproject(this.camera),s.sub(i).normalize();const a=Vi.set(0,0,-1);a.applyQuat(this.quaternion).normalize();const l=Ni.set(0,0,0),u=a.dot(s);if(Math.abs(u)>=1e-4){const p=this._matrices.world.matrix.getInverse().multiply(this.camera.viewMatrix),m=this._boundingRect.world.transformOrigin.clone().add(this._translation),x=Bi.set(this._translation.x-m.x,this._translation.y-m.y,this._translation.z-m.z);x.applyQuat(this.quaternion),m.add(x);const w=a.dot(m.clone().sub(i))/u;l.copy(i.add(s.multiplyScalar(w))),l.applyMat4(p)}else l.set(1/0,1/0,1/0);return Wi.set(l.x,l.y)}}onReEnterView(e){return e&&(this._onReEnterViewCallback=e),this}onLeaveView(e){return e&&(this._onLeaveViewCallback=e),this}}class ut{constructor(e,{shaderPass:t,depth:i=!1,clear:s=!0,maxWidth:a,maxHeight:l,minWidth:u=1024,minHeight:p=1024,texturesOptions:m={}}={}){if(this.type="RenderTarget",e=e&&e.renderer||e,!e||e.type!=="Renderer")ne(this.type+": Renderer not passed as first argument",e);else if(!e.gl){e.production||ne(this.type+": Unable to create a "+this.type+" because the Renderer WebGL context is not defined");return}this.renderer=e,this.gl=this.renderer.gl,this.index=this.renderer.renderTargets.length,this._shaderPass=t,this._depth=i,this._shouldClear=s,this._maxSize={width:a?Math.min(this.renderer.state.maxTextureSize/4,a):this.renderer.state.maxTextureSize/4,height:l?Math.min(this.renderer.state.maxTextureSize/4,l):this.renderer.state.maxTextureSize/4},this._minSize={width:u*this.renderer.pixelRatio,height:p*this.renderer.pixelRatio},m=Object.assign({sampler:"uRenderTexture",isFBOTexture:!0,premultiplyAlpha:!1,anisotropy:1,generateMipmap:!1,floatingPoint:"none",wrapS:this.gl.CLAMP_TO_EDGE,wrapT:this.gl.CLAMP_TO_EDGE,minFilter:this.gl.LINEAR,magFilter:this.gl.LINEAR},m),this._texturesOptions=m,this.userData={},this.uuid=ot(),this.renderer.renderTargets.push(this),this.renderer.onSceneChange(),this._initRenderTarget()}_initRenderTarget(){this._setSize(),this.textures=[],this._createFrameBuffer()}_restoreContext(){this._setSize(),this._createFrameBuffer()}_setSize(){this._shaderPass&&this._shaderPass._isScenePass?this._size={width:this.renderer._boundingRect.width,height:this.renderer._boundingRect.height}:this._size={width:Math.min(this._maxSize.width,Math.max(this._minSize.width,this.renderer._boundingRect.width)),height:Math.min(this._maxSize.height,Math.max(this._minSize.height,this.renderer._boundingRect.height))}}resize(){this._shaderPass&&(this._setSize(),this.textures[0].resize(),this.renderer.bindFrameBuffer(this,!0),this._depth&&this._bindDepthBuffer(),this.renderer.bindFrameBuffer(null))}_bindDepthBuffer(){this._depthBuffer&&(this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this._depthBuffer),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,this._size.width,this._size.height),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this._depthBuffer))}_createFrameBuffer(){this._frameBuffer=this.gl.createFramebuffer(),this.renderer.bindFrameBuffer(this,!0),this.textures.length?(this.textures[0]._parent=this,this.textures[0]._restoreContext()):new Oe(this.renderer,this._texturesOptions).addParent(this),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.textures[0]._sampler.texture,0),this._depth&&(this._depthBuffer=this.gl.createRenderbuffer(),this._bindDepthBuffer()),this.renderer.bindFrameBuffer(null)}getTexture(){return this.textures[0]}remove(){if(this._shaderPass){this.renderer.production||z(this.type+": You're trying to remove a RenderTarget attached to a ShaderPass. You should remove that ShaderPass instead:",this._shaderPass);return}this._dispose(),this.renderer.removeRenderTarget(this)}_dispose(){this._frameBuffer&&(this.gl.deleteFramebuffer(this._frameBuffer),this._frameBuffer=null),this._depthBuffer&&(this.gl.deleteRenderbuffer(this._depthBuffer),this._depthBuffer=null),this.textures[0]._dispose(),this.textures=[]}}class Hi extends Lt{constructor(e,t,{sampler:i="uPingPongTexture",widthSegments:s,heightSegments:a,renderOrder:l,depthTest:u,cullFace:p,uniforms:m,vertexShaderID:x,fragmentShaderID:w,vertexShader:E,fragmentShader:T,texturesOptions:F,crossOrigin:L,alwaysDraw:V,visible:U,transparent:O,drawCheckMargins:D,autoloadSources:N,watchScroll:B,fov:W}={}){if(u=!1,N=!1,super(e,t,{widthSegments:s,heightSegments:a,renderOrder:l,depthTest:u,cullFace:p,uniforms:m,vertexShaderID:x,fragmentShaderID:w,vertexShader:E,fragmentShader:T,texturesOptions:F,crossOrigin:L,alwaysDraw:V,visible:U,transparent:O,drawCheckMargins:D,autoloadSources:N,watchScroll:B,fov:W}),!this.gl)return;this.renderer.scene.removePlane(this),this.type="PingPongPlane",this.renderer.scene.addPlane(this),this.readPass=new ut(e,{depth:!1,clear:!1,texturesOptions:F}),this.writePass=new ut(e,{depth:!1,clear:!1,texturesOptions:F}),this.createTexture({sampler:i});let C=0;this.readPass.getTexture().onSourceUploaded(()=>{C++,this._checkIfReady(C)}),this.writePass.getTexture().onSourceUploaded(()=>{C++,this._checkIfReady(C)}),this.setRenderTarget(this.readPass),this._onRenderCallback=()=>{this.readPass&&this.writePass&&this.textures[0]&&this.textures[0]._uploaded&&this.setRenderTarget(this.writePass),this._onPingPongRenderCallback&&this._onPingPongRenderCallback()},this._onAfterRenderCallback=()=>{this.readPass&&this.writePass&&this.textures[0]&&this.textures[0]._uploaded&&this._swapPasses(),this._onPingPongAfterRenderCallback&&this._onPingPongAfterRenderCallback()}}_checkIfReady(e){e===2&&this.renderer.nextRender.add(()=>{this.textures[0].copy(this.target.getTexture())})}_swapPasses(){const e=this.readPass;this.readPass=this.writePass,this.writePass=e,this.textures[0].copy(this.readPass.getTexture())}getTexture(){return this.textures[0]}onRender(e){return e&&(this._onPingPongRenderCallback=e),this}onAfterRender(e){return e&&(this._onPingPongAfterRenderCallback=e),this}remove(){this.target=null,this.renderer.bindFrameBuffer(null),this.writePass&&(this.writePass.remove(),this.writePass=null),this.readPass&&(this.readPass.remove(),this.readPass=null),super.remove()}}(function(f){var e={};function t(i){if(e[i])return e[i].exports;var s=e[i]={i,l:!1,exports:{}};return f[i].call(s.exports,s,s.exports,t),s.l=!0,s.exports}t.m=f,t.c=e,t.d=function(i,s,a){t.o(i,s)||Object.defineProperty(i,s,{enumerable:!0,get:a})},t.r=function(i){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(i,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(i,"__esModule",{value:!0})},t.t=function(i,s){if(1&s&&(i=t(i)),8&s||4&s&&typeof i=="object"&&i&&i.__esModule)return i;var a=Object.create(null);if(t.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:i}),2&s&&typeof i!="string")for(var l in i)t.d(a,l,function(u){return i[u]}.bind(null,l));return a},t.n=function(i){var s=i&&i.__esModule?function(){return i.default}:function(){return i};return t.d(s,"a",s),s},t.o=function(i,s){return Object.prototype.hasOwnProperty.call(i,s)},t.p="",t(t.s=0)})([function(f,e,t){var i=this&&this.__spreadArray||function(u,p){for(var m=0,x=p.length,w=u.length;m<x;m++,w++)u[w]=p[m];return u};Object.defineProperty(e,"__esModule",{value:!0}),e.ConicalGradient=void 0;var s=t(1);function a(u,p,m,x,w,E,T){p===void 0&&(p=[[0,"#fff"],[1,"#fff"]]),m===void 0&&(m=0),x===void 0&&(x=0),w===void 0&&(w=0),E===void 0&&(E=2*Math.PI),T===void 0&&(T=!1);var F=Math.floor(180*w/Math.PI),L=Math.ceil(180*E/Math.PI),V=document.createElement("canvas");V.width=u.canvas.width,V.height=u.canvas.height;var U=V.getContext("2d"),O=[[0,0],[u.canvas.width,0],[u.canvas.width,u.canvas.height],[0,u.canvas.height]],D=Math.max.apply(Math,O.map(function(J){var X=J[0],G=J[1];return Math.sqrt(Math.pow(X-m,2)+Math.pow(G-x,2))}))+10;U.translate(m,x);for(var N=2*Math.PI*(D+20)/360,B=new s.default(p,L-F+1),W=F;W<=L;W++)U.save(),U.rotate((T?-1:1)*(Math.PI*W)/180),U.beginPath(),U.moveTo(0,0),U.lineTo(D,-2*N),U.lineTo(D,0),U.fillStyle=B.getColor(W-F),U.fill(),U.closePath(),U.restore();var C=document.createElement("canvas");C.width=u.canvas.width,C.height=u.canvas.height;var Q=C.getContext("2d");return Q.beginPath(),Q.arc(m,x,D,w,E,T),Q.lineTo(m,x),Q.closePath(),Q.fillStyle=Q.createPattern(V,"no-repeat"),Q.fill(),u.createPattern(C,"no-repeat")}e.default=a,CanvasRenderingContext2D.prototype.createConicalGradient=function(){for(var u=[],p=0;p<arguments.length;p++)u[p]=arguments[p];var m=this,x={stops:[],addColorStop:function(w,E){this.stops.push([w,E])},get pattern(){return a.apply(void 0,i([m,this.stops],u))}};return x};var l=t(2);Object.defineProperty(e,"ConicalGradient",{enumerable:!0,get:function(){return l.ConicalGradient}})},function(f,e,t){Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function s(a,l){a===void 0&&(a=[]),l===void 0&&(l=100);var u=document.createElement("canvas");u.width=l,u.height=1,this.ctx=u.getContext("2d");for(var p=this.ctx.createLinearGradient(0,0,l,0),m=0,x=a;m<x.length;m++){var w=x[m];p.addColorStop.apply(p,w)}this.ctx.fillStyle=p,this.ctx.fillRect(0,0,l,1),this.rgbaSet=this.ctx.getImageData(0,0,l,1).data}return s.prototype.getColor=function(a){var l=this.rgbaSet.slice(4*a,4*a+4);return"rgba("+l[0]+", "+l[1]+", "+l[2]+", "+l[3]/255+")"},s}();e.default=i},function(f,e,t){Object.defineProperty(e,"__esModule",{value:!0})}]);const Gi=(f,e,t,i,s)=>{var a=Math.PI/180*s,l=Math.cos(a),u=Math.sin(a),p=l*(t-f)+u*(i-e)+f,m=l*(i-e)-u*(t-f)+e;return[+p.toFixed(1),+m.toFixed(1)]},Ce=(f,e)=>{const t=e||1,i=Math.min(...f.map(m=>m[0])),s=Math.max(...f.map(m=>m[0])),a=Math.min(...f.map(m=>m[1])),l=Math.max(...f.map(m=>m[1])),u=Math.abs(s-i),p=Math.abs(l-a);return{width:Math.round(u/t),height:Math.round(p/t),aspectRatio:u/t/(p/t),center:{x:Math.round((u/2+i)/t),y:Math.round((p/2+a)/t)},corners:[[i,a],[s,a],[s,l],[i,l]]}},Ot=(f,e,t)=>{let i;const s=Ce(t);if(e.fill.length>1){let a=e.gradientAngle?+e.gradientAngle*2*Math.PI:0,l=s.center.x,u=s.center.y;if(e.gradientType==="radial"&&(i=f.createRadialGradient(l,u,Math.max(s.width,s.height)*.7,l,u,0)),e.gradientType==="linear"&&(i=f.createLinearGradient(l-Math.cos(a)*s.width/2,u-Math.sin(a)*s.height/2,l+Math.cos(a)*s.width/2,u+Math.sin(a)*s.height/2)),e.gradientType==="conic"){i=f.createConicalGradient(l,u,-Math.PI+a,Math.PI+a);const p=[...e.fill,...e.fill.slice().reverse()];p.forEach((x,w)=>{i.addColorStop(w*(1/(p.length-1)),x)}),document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGMatrix(),i=i.pattern}else e.fill.forEach((p,m)=>{i.addColorStop(m*(1/(e.fill.length-1)),p)})}else i=e.fill[0];return i};let Qe,$e,Dt;typeof document.hidden<"u"?(Qe="hidden",$e="visibilitychange"):typeof document.msHidden<"u"?(Qe="msHidden",$e="msvisibilitychange"):typeof document.webkitHidden<"u"&&(Qe="webkitHidden",$e="webkitvisibilitychange");const ji={NORMAL:"Normal",ADD:"Add",SUBTRACT:"Subtract",MULTIPLY:"Multiply",SCREEN:"Screen",OVERLAY:"Overlay",DARKEN:"Darken",LIGHTEN:"Lighten",COLOR_DODGE:"Color dodge",COLOR_BURN:"Color burn",LINEAR_BURN:"Linear burn",HARD_LIGHT:"Hard light",SOFT_LIGHT:"Soft light",DIFFERENCE:"Difference",EXCLUSION:"Exclusion",LINEAR_LIGHT:"Linear light",PIN_LIGHT:"Pin light",VIVID_LIGHT:"Vivid light"};function Xi(f,e){let t;return function(...i){clearTimeout(t),t=setTimeout(()=>{f.apply(this,i)},e)}}const kt=()=>{var f=new Date().getTime(),e=typeof performance<"u"&&performance.now&&performance.now()*1e3||0;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var i=Math.random()*16;return f>0?(i=(f+i)%16|0,f=Math.floor(f/16)):(i=(e+i)%16|0,e=Math.floor(e/16)),(t==="x"?i:i&3|8).toString(16)})};function Me(f){return f&&typeof f=="string"&&(f=JSON.parse(f)),Object.values(f)}function Ge(f,e,t){for(let i=0;i<t;i++)f=(f+e)/2;return+((f+e)/2).toFixed(4)}function Yi(f){const e=Ce(f.coords),t=f.getPositionOffset();let i=f.coords.map(([s,a])=>Gi(e.center.x,e.center.y,s,a,-f.rotation*360));return i=i.map(([s,a])=>[Math.round(s+t.x),Math.round(a+t.y)]),i}function De(f,e){const t=f[0]/f[1],i=Math.sqrt(t*(3e5*(e||1)));return[i,i/t]}function ft(){return/Android|iPhone/i.test(navigator.userAgent)}function ke(f){const e="trackMouse"in f&&f.trackMouse>0||"axisTilt"in f&&f.axisTilt>0||"trackMouseMove"in f&&f.trackMouseMove>0;let t=f.states&&f.states.scroll.length,i=f.states&&f.states.appear.length,s=f.layerType==="effect"&&f.animating;return e||s||t||i}function qi(f,e,t){const i=[];return f.forEach(s=>{switch(s.layerType){case"text":i.push(new as(s,e,null,t).unpackage());break;case"image":i.push(new rs(s,e,t).unpackage());break;case"fill":i.push(new Vt(s,e,t).unpackage());break;case"shape":i.push(new ss(s,e,t).unpackage());break;case"effect":i.push(new Vt(s,e,t).unpackage());break}}),i}function Zi(f,e){if(f.length){const t=document.createElement("style");for(let i=0;i<f.length;i++){let s=["normal","regular"].includes(f[i].fontStyle)?"":`:wght@${f[i].fontStyle}`;f[i].fontStyle==="italic"&&(s=""),f[i].fontCSS?t.innerHTML+=`
        @font-face {
          font-family: '${f[i].fontCSS.family}';
          src: url('${f[i].fontCSS.src}');
          font-display: swap;
        }`:t.innerHTML+=`@import url(https://fonts.googleapis.com/css2?family=${f[i].fontFamily.split(" ").join("+")}${s});`}document.head.appendChild(t)}}function Qi(f,e){const t=document.createElement("a");t.href="https://unicorn.studio?utm_source=public-url",t.style="position: absolute; display: flex; bottom: 30px; left: 0; width: 190px; margin: 0 auto; right: 0rem; padding: 10px; border-radius: 6px; background-color: rgba(255, 255, 255, 1); box-shadow: 0 3px 9px 0 rgba(0, 0, 0, .2); z-index: 99999999; box-sizing: border-box;",t.target="_blank";const i=document.createElement("img");i.src="https://assets.unicorn.studio/media/made_in_us_small_web.svg",i.alt="Made in unicorn.studio",i.style="width: 170px; height: auto;",t.appendChild(i),e.appendChild(t)}function $i(f,e){const i=De([e.offsetWidth||f.width,e.offsetHeight||f.height])[0]/e.offsetWidth,s=f.getPositionOffset(),a=document.createElement("div");a.setAttribute("data-us-text","loading"),a.setAttribute("data-us-project",f.local.sceneId),a.style.width=f.width/i+"px",a.style.height=f.height/i+"px",a.style.top=s.y/i+e.offsetTop+"px",a.style.left=s.x/i+e.offsetLeft+"px",a.style.fontSize=f.fontSize/i+"px",a.style.lineHeight=f.lineHeight/i+"px",a.style.letterSpacing=f.letterSpacing/i+"px",a.style.fontFamily=f.fontFamily,a.style.fontWeight=f.fontWeight,a.style.textAlign=f.textAlign,a.style.wordBreak="break-word",a.style.transform=`rotateZ(${Math.round(f.rotation*360)}deg)`,a.style.color="transparent",a.style.zIndex=2,a.innerText=f.textContent,e.appendChild(a)}let je;function Ji(){de.forEach((f,e)=>{document.body.contains(f.element)||(f.curtain.dispose(),de.splice(e,1))})}function gt(){cancelAnimationFrame(je);const f=de.filter(t=>t.getAnimatingEffects().length),e=t=>{const i=f.filter(s=>s.isInView&&s.initialized);de.forEach(s=>{s.rendering=i.includes(s)}),i.length?(os(),i.forEach(s=>{t-s.lastTime>=s.frameDuration&&(s.updateMouseTrail(),s.curtain.render(),s.lastTime=t)}),je=requestAnimationFrame(e)):cancelAnimationFrame(je)};f.length&&(je=requestAnimationFrame(e))}function Ki(f,e){return new Promise(t=>{const i=setInterval(()=>{f.local[e]&&(clearInterval(i),t())},20)})}function Pe(f,e,t){return f+(e-f)*t}function es(f){switch(f){case"linear":return e=>e;case"easeInQuad":return e=>e*e;case"easeOutQuad":return e=>1-(1-e)*(1-e);case"easeInOutQuad":return e=>e<.5?2*e*e:1-Math.pow(-2*e+2,2)/2;case"easeInCubic":return e=>e*e*e;case"easeInOutCubic":return e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2;case"easeOutCubic":return e=>1-Math.pow(1-e,3);case"easeInQuart":return e=>e*e*e*e;case"easeOutQuart":return e=>1-Math.pow(1-e,4);case"easeInOutQuart":return e=>e<.5?8*e*e*e*e:1-Math.pow(-2*e+2,4)/2;case"easeInQuint":return e=>e*e*e*e*e;case"easeOutQuint":return e=>1-Math.pow(1-e,5);case"easeInOutQuint":return e=>e<.5?16*e*e*e*e*e:1-Math.pow(-2*e+2,5)/2;case"easeOutElastic":return e=>{const t=2*Math.PI/3;return e===0?0:e===1?1:Math.pow(2,-10*e)*Math.sin((e*10-.75)*t)+1};case"easeInElastic":return e=>{const t=2*Math.PI/3;return e===0?0:e===1?1:-Math.pow(2,10*e-10)*Math.sin((e*10-10.75)*t)};case"easeInOutElastic":return e=>{const t=2*Math.PI/4.5;return e===0?0:e===1?1:e<.5?-(Math.pow(2,20*e-10)*Math.sin((20*e-11.125)*t))/2:Math.pow(2,-20*e+10)*Math.sin((20*e-11.125)*t)/2+1};case"easeInSine":return e=>1-Math.cos(e*Math.PI/2);case"easeOutSine":return e=>Math.sin(e*Math.PI/2);case"easeInOutSine":return e=>-(Math.cos(Math.PI*e)-1)/2;case"easeInCirc":return e=>1-Math.sqrt(1-Math.pow(e,2));case"easeOutCirc":return e=>Math.sqrt(1-Math.pow(e-1,2));case"easeInOutCirc":return e=>e<.5?(1-Math.sqrt(1-Math.pow(2*e,2)))/2:(Math.sqrt(1-Math.pow(-2*e+2,2))+1)/2;case"easeInExpo":return e=>e===0?0:Math.pow(2,10*e-10);case"easeOutExpo":return e=>e===1?1:1-Math.pow(2,-10*e);case"easeInOutExpo":return e=>e===0?0:e===1?1:e<.5?Math.pow(2,20*e-10)/2:(2-Math.pow(2,-20*e+10))/2;default:return e=>e}}class ts{constructor({prop:e,value:t,transition:i,uniformData:s}){this.prop=e,this.value=t,this.transition=i,this.complete=!1,this.progress=0,this.initialStateSet=!1,this.uniformData=s,typeof this.value=="object"&&(this.value.type==="Vec2"?this.value=new ae(this.value._x,this.value._y):this.value.type==="Vec3"&&(this.value=new q(this.value._x,this.value._y,this.value._z)))}cloneVector(e){let t;return e.type==="Vec2"?(t=new ae(e._x,e._y),this.prop==="pos"&&(t.y=1-t.y)):e.type==="Vec3"&&(t=new q(e._x,e._y,e._z)),t}initializeState(e,t){if(t!==void 0&&(typeof t=="object"?(this.endVal=this.cloneVector(t),this.startVal=this.cloneVector(this.value)):this.endVal=t),e){if(typeof this.value=="object"){let a;this.value.type==="Vec2"?a=new ae(this.value._x,this.value._y):this.value.type==="Vec3"&&(a=new q(this.value._x,this.value._y,this.value._z)),e.value=a}else e.value=this.value;this.initialStateSet=!0}}updateEffect(e){const t=typeof this.value=="object";if(this.complete||!e.userData.createdAt||!this.initialStateSet)return!1;const i=performance.now(),s=e.uniforms[this.prop],a=es(this.transition.ease),l=e.userData.createdAt+this.transition.delay,u=Math.max(0,Math.min(1,(i-l)/this.transition.duration));let p=this.value;if(u>0&&u<=1){let m=a(u);t?(s.value.x=Pe(p.x,this.endVal.x,m),this.prop==="pos"?s.value.y=Pe(1-p.y,this.endVal.y,m):s.value.y=Pe(p.y,this.endVal.y,m),p.type==="Vec3"&&(s.value.z=Pe(p.z,this.endVal.z,m))):s.value=Pe(p,this.endVal,m)}else t?s.value=this.cloneVector(this.value):s.value=this.value;return u>=1&&(this.complete=!0,this.progress=0),this.lastTick=i,!0}resetState(){this.progress=0,this.complete=!1,this.initialStateSet=!1}}class is{constructor({prop:e,value:t,range:i,offset:s,momentum:a,uniformData:l}){fe(this,"type","scroll");this.prop=e,this.value=t,this.progress=0,this.momentum=a,this.range=i,this.offset=s,this.uniformData=l,typeof this.value=="object"&&(this.value.type==="Vec2"?this.value=new ae(this.value._x,this.value._y):this.value.type==="Vec3"&&(this.value=new q(this.value._x,this.value._y,this.value._z)))}package(){let e={id:this.id,prop:this.prop,value:this.value,range:this.range,offset:this.offset,momentum:this.momentum};return typeof this.value=="object"&&(this.value.type==="Vec2"?e.value={type:this.value.type,_x:this.value._x,_y:this.value._y}:this.value.type==="Vec3"&&(e.value={type:"Vec3",_x:this.value._x,_y:this.value._y,_z:this.value._z})),e}cloneVector(e){let t;return e.type==="Vec2"?(t=new ae(e._x,e._y),this.prop==="pos"&&(t.y=1-t.y)):e.type==="Vec3"&&(t=new q(e._x,e._y,e._z)),t}updateEffect(e,t,{top:i,height:s}){if(t===void 0)return!1;this.startVal||(typeof this.value=="object"?this.startVal=this.cloneVector(t):this.startVal=t);const a=typeof this.value=="object",l=e.uniforms[this.prop],u=window.innerHeight,p=window.scrollY||window.pageYOffset,m=i+p-u*this.offset,x=m+(u+s)*this.range;let w=(p-m)/(x-m),E=this.value;if(!l)return!1;let T=Math.max(0,Math.min(1,w));return this.lastTick!==void 0&&(T=Ge(T,this.lastTick,this.momentum*2)),Math.abs(this.lastTick-T)<.001?!1:(a?(l.value.x=Pe(this.startVal.x,E.x,T),this.prop==="pos"?l.value.y=Pe(1-this.startVal.y,E.y,T):l.value.y=Pe(this.startVal.y,E.y,T),this.startVal.type==="Vec3"&&(l.value.z=Pe(this.startVal.z,E.z,T))):l.value=Pe(this.startVal,E,T),this.lastTick=T,!0)}}class Ut{constructor(e,t){fe(this,"local",{id:"",projectId:""});this.visible=e.visible!==void 0?e.visible:!e.hidden||!0,this.locked=e.locked||!1,this.aspectRatio=e.aspectRatio||1,this.local.sceneId=t,this.local.id=kt()}state(){return de.find(e=>e.id===this.local.sceneId)||this.initOptions}getIndex(){return this.state().layers.map(e=>e.local.id).indexOf(this.local.id)}getPlane(){return this.state().curtain.planes.find(e=>e.userData.id===this.local.id)}getPlanes(){return this.state().curtain.planes.filter(e=>e.userData.id===this.local.id)}getMaskedItem(){return this.mask?this.state().layers.filter(e=>e.visible&&!e.parentLayer)[this.getIndex()-1]:!1}getChildEffectItems(){if(this.effects&&this.effects.length){const e=this.state().layers.filter(i=>this.effects.includes(i.parentLayer));return this.effects.map(i=>e.find(s=>s.parentLayer===i)).filter(i=>i!==void 0)}else return[]}}let pt=class extends Ut{constructor(t,i,s){super(t,i);fe(this,"isElement",!0);this.initOptions=s,this.opacity=t.opacity||1,this.displace=t.displace||0,this.trackMouse=t.trackMouse||0,this.axisTilt=t.axisTilt||0,this.bgDisplace=t.bgDisplace||0,this.dispersion=t.dispersion||0,this.mouseMomentum=t.mouseMomentum||0,this.blendMode=t.blendMode||"NORMAL",this.compiledFragmentShaders=t.compiledFragmentShaders||[],this.compiledVertexShaders=t.compiledVertexShaders||[]}createLocalCanvas(){const t=this.state(),i=document.createElement("canvas"),s=t.dpi*t.scale;i.width=t.element.offsetWidth*s,i.height=t.element.offsetHeight*s;const l=De([t.element.offsetWidth,t.element.offsetHeight])[0]/t.element.offsetWidth,u=i.getContext("2d");u.scale(s/l,s/l),this.local.canvas=i,this.local.ctx=u}resize(){const t=this.state();if(this.local.canvas){const i=+t.dpi*t.scale,a=De([t.element.offsetWidth,t.element.offsetHeight])[0]/t.element.offsetWidth;this.local.canvas.width=t.canvasWidth,this.local.canvas.height=t.canvasHeight,this.local.ctx.scale(i/a,i/a)}}getPositionOffset(){const t=this.state(),i=t.canvasWidth/t.canvasHeight,s=this.aspectRatio/i,a=t.canvasWidth*Math.sqrt(s),l=t.canvasHeight/Math.sqrt(s),p=De([t.element.offsetWidth,t.element.offsetHeight])[0]/t.element.offsetWidth;let m=(t.canvasWidth*p-a*p)/(t.dpi*2),x=(t.canvasHeight*p-l*p)/(t.dpi*2);this.layerType==="image"&&(m+=a*p/(t.dpi*2),x+=l*p/(t.dpi*2));let w=this.translateX+m,E=this.translateY+x;return{x:w,y:E,offX:m,offY:x}}};class ss extends pt{constructor(t,i,s){super(t,i);fe(this,"layerType","shape");fe(this,"isElement",!0);this.initOptions=s;let a=this.default(t||{});for(let l in a)this[l]=a[l];Object.keys(t).length&&(this.createLocalCanvas(),this.render())}default(t){return{blendMode:t.blendMode||"NORMAL",borderRadius:t.borderRadius||0,coords:t.coords||[],displace:t.displace||0,dispersion:t.dispersion||0,bgDisplace:t.bgDisplace||0,effects:t.effects||[],fill:t.fill||["#777777"],gradientAngle:t.gradientAngle||t.gradAngle||0,gradientType:t.gradientType||t.gradType||"linear",mask:t.mask||0,numSides:t.numSides||3,opacity:t.opacity||1,rotation:t.rotation||0,translateX:t.translateX||0,translateY:t.translateY||0,type:t.type||"rectangle"}}unpackage(){return this.fill=Me(this.fill),this.coords=Me(this.coords),this.effects=Me(this.effects),this}render(){let t=Yi(this);if(this.local.ctx.beginPath(),this.type==="rectangle"){const i=Ce(this.coords);let s=this.borderRadius*Math.min(i.width,i.height)/2;const a=(u,p,m)=>{const x=Math.cos(m),w=Math.sin(m);return[u*x-p*w,u*w+p*x]},l=this.rotation*2*Math.PI;if(t.length){this.local.ctx.beginPath();let u=this.coords[0][0]<this.coords[1][0],p=this.coords[0][1]>this.coords[2][1],m=[-1,1,-1,1];u&&(m=[-1,-1,-1,-1]),p&&(m=[1,1,1,1]),u&&p&&(m=[1,-1,1,-1]);for(let x=0;x<t.length;x++){const[w,E]=t[x],[T,F]=t[(x+1)%t.length],L=(x+1)*Math.PI/2+l,[V,U]=a(s,0,L);let O=m[x];this.local.ctx.lineTo(w-V*O,E-U*O),this.local.ctx.arcTo(w,E,T,F,s)}this.local.ctx.closePath(),this.local.ctx.stroke()}}else if(this.type==="circle"){let i=Ce(t);const s=Ce(this.coords);this.local.ctx.ellipse(i.center.x,i.center.y,s.width/2,s.height/2,this.rotation*Math.PI*2,0,2*Math.PI)}else if(this.type==="polygon"){const i=this.numSides;if(t.length>=2){const s=Ce(t),a=Ce(this.coords),l=this.coords[0][1]>this.coords[2][1],u=s.center.y,p=s.center.x,m=(T,F,L,V,U)=>{const O=Math.cos(L),D=Math.sin(L);T-=V,F-=U;const N=T*O-F*D,B=T*D+F*O;return T=N+V,F=B+U,[T,F]},x=(this.rotation+(l?.5:0))*2*Math.PI,w=a.width/Math.sqrt(3)*.86,E=a.height/Math.sqrt(3)*.86;this.local.ctx.beginPath();for(let T=0;T<i;T++){const L=-Math.PI/2+2*Math.PI*T/i;let V=p+w*Math.cos(L),U=u+E*Math.sin(L);[V,U]=m(V,U,x,p,u),T===0?this.local.ctx.moveTo(V,U):this.local.ctx.lineTo(V,U)}this.local.ctx.closePath()}}this.local.ctx.fillStyle=Ot(this.local.ctx,this,t),this.local.ctx.clearRect(0,0,this.state().canvasWidth,this.state().canvasHeight),this.local.ctx.fill()}}class Vt extends Ut{constructor(t,i,s){super(t,i);fe(this,"layerType","effect");this.initOptions=s,this.type=t.type||"sine",this.speed=t.speed||.5,this.data=t.data||{},this.parentLayer=t.parentLayer||!1,this.animating=t.animating||!1,this.isMask=t.isMask||0,this.texture=t.texture||null,this.mouseMomentum=t.mouseMomentum||0,this.compiledFragmentShaders=t.compiledFragmentShaders||[],this.compiledVertexShaders=t.compiledVertexShaders||[],this.states={appear:t.states&&t.states.appear?t.states.appear.map(a=>new ts(a)):[],scroll:t.states&&t.states.scroll?t.states.scroll.map(a=>new is(a)):[]};for(let a in t)this[a]||(this[a]=t[a])}unpackage(){this.type==="blur"&&this.type,this.type==="smoothBlur"&&(this.type="blur"),this.type==="ungulate"&&(this.type="noise");for(let t in this)this[t]&&this[t].type&&(this[t].type==="Vec2"?this[t]=new ae(this[t]._x,this[t]._y):this[t].type==="Vec3"&&(this[t]=new q(this[t]._x,this[t]._y,this[t]._z)));return this}getParent(){return this.state().layers.filter(t=>t.effects&&t.effects.length).find(t=>t.effects.includes(this.parentLayer))}}class rs extends pt{constructor(t,i,s){super(t,i);fe(this,"layerType","image");fe(this,"isElement",!0);this.initOptions=s;let a=this.default(t||{});for(let l in a)this[l]=a[l];Object.keys(t).length&&(this.createLocalCanvas(),this.loadImage())}default(t){return{bgDisplace:t.bgDisplace||0,dispersion:t.dispersion||0,effects:t.effects||[],size:t.size||.25,rotation:t.rotation||t.angle||0,height:t.height||50,fitToCanvas:t.fitToCanvas||!1,displace:t.displace||0,repeat:t.repeat||0,mask:t.mask||0,rotation:t.rotation||0,scaleX:t.scaleX||1,scaleY:t.scaleY||1,src:t.src||"",speed:t.speed||.5,thumb:t.thumb||"",translateX:t.translateX||0,translateY:t.translateY||0,width:t.width||50}}unpackage(){return this.effects=Me(this.effects),this}loadImage(){const t=new Image,i=new Image;t.crossOrigin="Anonymous",i.crossOrigin="Anonymous",t.addEventListener("load",()=>{this.local.loaded=!0,this.local.fullyLoaded=!0,this.local.img=t,this.width=t.width,this.height=t.height,this.render=this.renderImage,this.render(),this.getPlane()?this.getPlane().textures.filter(s=>s.sourceType==="canvas").forEach(s=>{s.needUpdate(),s.shouldUpdate=!1,this.rendering||this.state().curtain.render()}):this.rendering||this.state().curtain.render()},!1),i.addEventListener("load",()=>{this.local.loaded||(this.local.loaded=!0,this.local.img=i,this.width=i.width,this.height=i.height,this.render=this.renderImage,this.render())},!1),t.src=this.src,i.src=this.thumb}getRelativeScale(){return Math.min(1080/this.width,1080/this.height)}renderImage(){const t=this.getPositionOffset(),i=this.state();let s=t.x,a=t.y;const l=this.rotation*360*(Math.PI/180),u=this.getRelativeScale();let p=this.width*u*this.scaleX,m=this.height*u*this.scaleY;const x=i.dpi*i.scale;if(this.local.ctx.clearRect(0,0,i.canvasWidth,i.canvasHeight),this.fitToCanvas){const E=De([i.element.offsetWidth,i.element.offsetHeight])[0]/i.element.offsetWidth;let T=this.width/this.height,F=i.canvasWidth*E/x,L=i.canvasHeight*E/x;F/L<T?(m=L,p=L*T):(p=F,m=F/T),s=F/2,a=L/2,this.local.ctx.save(),this.local.ctx.translate(s,a),this.local.ctx.drawImage(this.local.img,-p/2,-m/2,p,m),this.local.ctx.restore()}else this.local.ctx.save(),this.local.ctx.translate(s,a),this.local.ctx.rotate(l),this.local.ctx.scale(this.size,this.size),this.local.ctx.drawImage(this.local.img,-p/2,-m/2,p,m),this.local.ctx.restore()}render(){}}class as extends pt{constructor(t,i,s,a){super(t,i);fe(this,"layerType","text");fe(this,"isElement",!0);fe(this,"justCreated",!1);this.initOptions=a;let l=this.default(t||{});for(let u in l)this[u]=l[u];if(this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),$i(this,a.element),Object.keys(t).length&&(this.createLocalCanvas(),requestAnimationFrame(()=>{this.coords=[[-2,0],[-2+this.width,0],[-2+this.width,0+this.height],[-2,0+this.height]]})),s)this.local.loaded=!0,this.render(),this.state().renderNFrames(2),this.getPlane()&&this.getPlane().textures.filter(u=>u.sourceType==="canvas").forEach(u=>{u.needUpdate()});else{const u=new FontFace(this.fontFamily,`url(${this.fontCSS.src})`,{style:this.fontStyle.includes("italic")?"italic":"normal",weight:isNaN(parseInt(this.fontStyle))?400:parseInt(this.fontStyle)});document.fonts.add(u),u.load().then(()=>{this.render(),this.state().renderNFrames(2),this.local.loaded=!0,this.getPlane()&&this.getPlane().textures.filter(p=>p.sourceType==="canvas").forEach(p=>{p.needUpdate()})})}}default(t){return{bgDisplace:t.bgDisplace||0,dispersion:t.dispersion||0,effects:t.effects||[],fill:t.fill||["#ffffff"],highlight:t.highlight||["transparent"],fontSize:t.fontSize||24,fontCSS:t.fontCSS||null,lineHeight:t.lineHeight||25,letterSpacing:t.letterSpacing||0,mask:t.mask||0,fontFamily:t.fontFamily||"arial",fontStyle:t.fontStyle||"normal",fontWeight:t.fontWeight||"normal",textAlign:t.textAlign||"left",textContent:t.textContent||"",gradientAngle:t.gradientAngle||t.gradAngle||0,gradientType:t.gradientType||t.gradType||"linear",coords:t.coords||[],rotation:t.rotation||0,translateX:t.translateX||0,translateY:t.translateY||0,width:t.width||200,height:t.height||50}}unpackage(){return this.fill=Me(this.fill),this.highlight=Me(this.highlight),this.coords=Me(this.coords),this.effects=Me(this.effects),this}render(){const t=this.getPositionOffset();let i=t.x,s=t.y,a=0,l=this.width,u=this.height,p=this.fontSize>0?this.fontSize:0,m=this.lineHeight>0?this.lineHeight:0,x=this.fontStyle.includes("italic")?"italic":"normal",w="400";this.local.textBoxPos={x:i,y:s},this.local.ctx.clearRect(0,0,this.state().canvasWidth,this.state().canvasHeight),this.local.ctx.font=`${x} ${w} ${p}px/${m}px ${this.fontFamily}, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial`,this.isSafari||(this.local.ctx.textAlign=this.textAlign,this.local.ctx.letterSpacing=this.letterSpacing+"px");const E=this.local.ctx.measureText("m").width;l=Math.max(l,E),this.local.ctx.save(),this.local.ctx.translate(i+l/2,s+u/2),this.local.ctx.rotate(this.rotation*360*Math.PI/180),this.local.ctx.translate(-(i+l/2),-(s+u/2)),this.textAlign==="center"&&(i+=l/2),this.textAlign==="right"&&(i+=l),this.local.ctx.fillStyle=Ot(this.local.ctx,this,this.coords);const T=(O,D,N,B,W,C,Q)=>{let J=D.split("").reduce((G,ie,he)=>G+O.measureText(ie).width+(he<D.length-1?W:0),0),X;if(C==="center"?X=N+(Q-J)/2-Q/2:X=N,C==="right")for(let G=D.length-1;G>=0;G--){const ie=D[G];X-=O.measureText(ie).width,O.fillText(ie,X,B),G>0&&(X-=W)}else for(let G=0;G<D.length;G++)O.fillText(D[G],X,B),X+=O.measureText(D[G]).width+W},F=(O,D)=>{let N=s+m*D+m/2+p/3;this.isSafari?T(this.local.ctx,O,i,N,this.letterSpacing,this.textAlign,l):this.local.ctx.fillText(O,i,N)},L=this.textContent?this.textContent.split(`
`):[""];let V=L.length;const U=(O,D,N)=>D.split("").reduce((W,C,Q)=>(W+=O.measureText(C).width,Q<D.length-1&&(W+=N),W),0);for(let O=0;O<V;O++){let D="",N=L[O].split(/(\s|\n)/);for(let B=0;B<N.length;B++){const W=N[B],C=D+W;if((this.isSafari&&this.letterSpacing?U(this.local.ctx,C,this.letterSpacing):this.local.ctx.measureText(C).width)>l||W===`
`){if(D!=="")L[O]=D.trim(),B!==N.length-1?(L.splice(O+1,0,N.slice(B).join("")),V++):W!==`
`&&L.push(W);else{let J=W,X=O;for(;J.length>0;){let G="";for(let ie=0;ie<J.length&&(this.local.ctx.measureText(G+J[ie]).width<=l||ie==0);ie++)G+=J[ie];J=J.slice(G.length),L[X]=G.trim(),J.length>0&&(L.splice(X+1,0,J),X++,V++)}N.slice(B+1).length>0&&(L[X]+=N.slice(B+1).join(""))}break}else D=C;B===N.length-1&&(L[O]=D.trim())}}L.forEach((O,D)=>{F(O,a),D<L.length-1&&a++}),this.local.ctx.translate(-(i+l/2),-(s+u/2)),this.local.ctx.restore(),this.height=this.lineHeight*a+this.lineHeight}}function ns(){document[Qe]?cancelAnimationFrame(je):gt()}function hs(){de.forEach(f=>{f.refresh()})}let Bt=window.scrollY;function ls(f){const e=de.filter(i=>i.getAnimatingEffects().length),t=de.filter(i=>i.rendering);e.length&&!t.length&&gt(),t.length&&t.forEach(i=>{i.mouse.movePos.y+=(window.scrollY-Bt)/2}),Bt=window.scrollY}function os(){de.forEach(f=>{f.isInView&&f.curtain.planes.find(e=>e.uniforms.mousePos)&&(ft()&&f.interactivity&&f.interactivity.mouse&&f.interactivity.mouse.disableMobile||(f.mouse.pos.y=f.mouse.movePos.y,f.mouse.pos.x=f.mouse.movePos.x,f.mouse.lastPos.x=f.mouse.pos.x,f.mouse.lastPos.y=f.mouse.pos.y))})}function Nt(f){de.filter(e=>e.isInView).forEach(e=>{let t=e.bbox,i,s;f.targetTouches?(i=f.targetTouches[0].pageX,s=f.targetTouches[0].pageY):(i=f.pageX,s=f.pageY);const a={x:t.left/2,y:(t.top+e.scrollY)/2},l=i/2-a.x,u=s/2-a.y;e.mouse.movePos.x=l,e.mouse.movePos.y=u}),Dt=!0}const de=[];class ds{constructor(e){fe(this,"scrollY",0);this.id=e.id,this.projectId=e.projectId,this.canvasWidth=e.width||e.element.offsetWidth||window.innerWidth,this.canvasHeight=e.height||e.element.offsetHeight||window.innerHeight,this.curtain=void 0,this.curtainRafId=void 0,this.dpi=+e.dpi||Math.min(1.5,window.devicePixelRatio),this.element=e.element,this.fps=e.fps||60,this.name=e.name,this.frameDuration=Math.floor(1e3/(e.fps||60)),this.layers=e.layers,this.lazyLoad=e.lazyLoad,this.initialized=!1,this.lasTick=null,this.isInView=!1,this.lastTime=0,this.rendering=!1,this.bbox={},this.interactivity={mouse:{disableMobile:!1}},this.mouse={downPos:{x:0,y:0},movePos:{x:window.innerWidth/4,y:window.innerHeight/4},lastPos:{x:window.innerWidth/4,y:window.innerHeight/4},delta:{x:0,y:0},dragging:!1,trail:[],recordTrail:!1,pos:{x:window.innerWidth/4,y:window.innerHeight/4}},this.renderingScale=e.renderingScale||1,this.scale=e.scale||1,this.size="Square",this.split=!1,this.versionId="",e.width&&e.height&&(this.element.style.width=e.width+"px",this.element.style.height=e.height+"px"),this.bbox=this.element.getBoundingClientRect(),this.createCurtains(),this.setCanvasScale(),this.textureLoader=new It(this.curtain),this.preloadedTextures={}}preloadTextures(){this.layers.forEach(e=>{e.local&&e.local.canvas&&this.preloadCanvasTexture(e,e.local.canvas)})}preloadCanvasTexture(e,t){this.textureLoader.loadCanvas(t,{sampler:"uTexture",premultiplyAlpha:!0},i=>{e.preloadedTexture=i},(i,s)=>{console.error("Error loading canvas texture:",s)})}setCanvasScale(){this.canvasWidth=this.element.offsetWidth*this.dpi*this.scale,this.canvasHeight=this.element.offsetHeight*this.dpi*this.scale}destroy(){this.element&&this.element.setAttribute("data-us-initialized",""),this.curtain.dispose()}resize(){this.setCanvasScale(),this.layers.filter(e=>e.isElement).forEach(e=>{e.resize(),e.getPlane()&&e.getPlane().textures.filter(t=>t.sourceType==="canvas").forEach(t=>{t.needUpdate()})}),this.layers.filter(e=>e.render).forEach(e=>{e.render()}),this.curtain.resize(),this.bbox=this.element.getBoundingClientRect()}refresh(){this.initialized=!1,this.curtain.planes.forEach(e=>{e.remove()}),this.lazyLoad=!0,this.resize(),this.preloadTextures(),this.isInView&&(this.scrollY=window.scrollY||window.pageYOffset,requestAnimationFrame(()=>{this.initializePlanes()}))}updateMouseTrail(){Dt&&(this.mouse.trail.unshift([this.mouse.pos.x/(this.bbox.width*.5),1-this.mouse.pos.y/(this.bbox.height*.5)]),this.mouse.trail.length>4&&this.mouse.trail.pop())}getScaleFactor(e){return{x:Math.sqrt(this.canvasWidth/this.canvasHeight/e),y:Math.sqrt(this.canvasHeight/this.canvasWidth*e)}}getAnimatingEffects(){return this.layers.filter(e=>ke(e)&&e.visible)}createCurtains(){const e=new gi({container:this.element,premultipliedAlpha:!0,antialias:!1,autoRender:!1,autoResize:!1,watchScroll:!1,renderingScale:Math.min(Math.max(.25,this.renderingScale),1),production:!0,pixelRatio:this.dpi});this.scrollY=window.scrollY||window.pageYOffset,document.querySelectorAll(`[data-us-text="loading"][data-us-project="${this.id}"]`).forEach(t=>{t.style.position="absolute"}),this.curtain=e}fullRedraw(){this.fullRedrawEnabled=!0,this.curtain.render(),this.fullRedrawEnabled=!1}renderNFrames(e,t){let i=0;const s=()=>{this.curtain.render(),i<e?(i++,requestAnimationFrame(s)):t&&t()};this.rendering||s()}setInteractiveParams(e,t){let i={mouse:{disableMobile:!1}};t&&t.mouse&&"disableMobile"in t.mouse&&(i.mouse.disableMobile=t.mouse.disableMobile),e&&e.interactivity&&e.interactivity.mouse&&"disableMobile"in e.interactivity.mouse&&(i.mouse.disableMobile=e.interactivity.mouse.disableMobile),this.interactivity=i}getSplitOrderedItems(){let e=this.getOrderedItems(),t=0,i=e[t];if(i){let s=i.parentLayer?i.getParent():null,a=s&&ke(s),l=s&&s.effects&&s.effects.length&&s.getChildEffectItems().filter(u=>ke(u)).length;for(;i&&!ke(i)&&!a&&!l;)t++,i=e[t],i&&(s=i.parentLayer?i.getParent():null,a=s&&ke(s),l=s&&s.effects&&s.effects.length&&s.getChildEffectItems().filter(u=>ke(u)).length);return{static:this.getOrderedItems().splice(0,t),dynamic:this.getOrderedItems().splice(t)}}else return{static:[],dynamic:[]}}initializePlanes(e){this.initializing=!0,this.handleItemPlanes(()=>{document.querySelectorAll(`[data-us-text="loading"][data-us-project="${this.id}"]`).forEach(t=>{t.style.color="transparent"}),this.handlePlaneCreation(),e&&e(this)})}getPassPlane(e,t){return this.curtain.planes.find(i=>i.userData.id===e.local.id&&i.userData.passIndex===t)}getRenderTargets(){return this.curtain.renderTargets.filter(e=>e.userData.id)}getPlanes(){return this.curtain.planes.filter(e=>e.type!=="PingPongPlane")}removeUnusedPlanes(){this.curtain.planes.forEach(e=>{e.remove()}),this.curtain.renderTargets.forEach(e=>{e.remove()})}getPlaneParams(e,t){let i=["noise","noiseField","sine","ripple","bulge"].includes(e.type)?500:1;const s={resolution:{name:"uResolution",type:"2f",value:new ae(this.canvasWidth,this.canvasHeight)},mousePos:{name:"uMousePos",type:"2f",value:new ae(.5)},time:{name:"uTime",type:"1f",value:0},dpi:{name:"uDpi",type:"1f",value:this.dpi*+this.renderingScale}};e.isElement&&(s.sampleBg={name:"uSampleBg",type:"1i",value:1}),e.type==="mouse"&&(s.previousMousePos={name:"uPreviousMousePos",type:"2f",value:new ae(.5)}),e.states&&[...e.states.appear,...e.states.scroll].forEach(u=>{s[u.prop]||(s[u.prop]=u.uniformData,s[u.prop].value=u.value)});let a=e.compiledFragmentShaders[t]||e.compiledFragmentShaders[0],l=e.compiledVertexShaders[t]||e.compiledVertexShaders[0];return{crossOrigin:"",fragmentShader:a,vertexShader:l,widthSegments:i,heightSegments:i,texturesOptions:{floatingPoint:"half-float",premultiplyAlpha:!0},uniforms:s}}createPlane(e,t,i){var l;let s;e.isElement?s=this.getPlaneParams(e):s=this.getPlaneParams(e,i?i.index:null),s.watchScroll=!1,(l=e.data)!=null&&l.downSample&&!i||i!=null&&i.downSample?(this.curtain.renderer._renderingScale=this.scale*.5,this.curtain.renderer.setSize()):(this.curtain.renderer._renderingScale=this.scale,this.curtain.renderer.setSize());const a=new Lt(this.curtain,this.curtain.container,s);return a.textures.length=0,a.userData.id=e.local.id,a.userData.layerType=e.layerType,a.userData.type=e.type,a.setRenderOrder(t),a}createPingPongPlane(e,t,i){let s=this.getPlaneParams(e,1);const a=new Hi(this.curtain,this.curtain.container,s),l=e.getParent();if(a)return a.userData.id=e.local.id,a.userData.pingpong=!0,a.setRenderOrder(t),this.setInitialEffectPlaneUniforms(a,e,l,i),a.onReady(()=>{a.userData.isReady=!0}).onRender(()=>{this.setEffectPlaneUniforms(a,e)}),a}createEffectPlane(e,t,i){const s=this.createPlane(e,t,i),a=e.getParent();s&&(i?(s.userData.passIndex=i.index,s.userData.downSample=i.downSample,s.userData.includeBg=i.includeBg,s.userData.length=e.data.passes.length,Object.entries(i).forEach(([l,u])=>{s.uniforms[l]&&(s.uniforms[l].value=u)})):s.userData.downSample=e.data.downSample,this.setInitialEffectPlaneUniforms(s,e,a,i),s.onReady(()=>{s.userData.isReady=!0}).onRender(()=>this.setEffectPlaneUniforms(s,e)))}createElementPlane(e,t){const i=this.createPlane(e,t);i&&i.onReady(()=>{i.userData.isReady=!0}).onRender(()=>this.setElementPlaneUniforms(i,e))}handleEffectPlane(e,t,i){const s="passIndex"in i?this.getPassPlane(e,i.passIndex):e.getPlane();let a=this.getRenderTargets()[t-1],l=this.curtain.planes.find(p=>p.type==="PingPongPlane"&&p.userData.id===e.local.id);l&&s&&s.createTexture({sampler:"uPingPongTexture",fromTexture:l.getTexture()}),a&&s&&s.createTexture({sampler:"uTexture",fromTexture:a.getTexture()}),i.passIndex>0&&s&&this.getRenderTargets()[t-(1+i.passIndex)]&&s.createTexture({sampler:"uBgTexture",fromTexture:this.getRenderTargets()[t-(1+i.passIndex)].getTexture()});const u=e.texture||e.data.texture;u&&(s.userData.textureLoaded=!1,s.loadImage(u.src,{sampler:u.sampler},p=>{s.userData.textureLoaded=!0,this.curtain.render()}))}handleElementPlane(e,t){const i=e.getPlane(),s=e.getChildEffectItems();let a=this.getRenderTargets()[t-1];if(s.length||(i.textures.length=0),a&&s.length&&i?i.createTexture({sampler:"uTexture",premultipliedAlpha:!0,fromTexture:a.getTexture()}):i&&i.addTexture(e.preloadedTexture),a){if(s.length){let l=s.reduce((p,m)=>p+m.getPlanes().length,0);const u=s.filter(p=>p.type==="mouse").length;a=this.getRenderTargets()[t-(1+l-u)]}a&&i.createTexture({sampler:"uBgTexture",premultipliedAlpha:!0,fromTexture:a.getTexture()})}}handleChildEffectPlane(e,t,i){const s="passIndex"in i?this.getPassPlane(e,i.passIndex):e.getPlane(),a=e.getParent();let l=this.getRenderTargets()[t-1],u=this.curtain.planes.find(T=>T.type==="PingPongPlane"&&T.userData.id===e.local.id),p=a.effects.filter(T=>{if(this.layers.find(F=>F.parentLayer===T))return this.layers.find(F=>F.parentLayer===T).visible}),m=p.indexOf(e.parentLayer),x=p.at(-1)===p[m],w=i.passIndex===i.length;u&&e.type==="mouse"&&s.createTexture({sampler:"uPingPongTexture",fromTexture:u.getTexture()}),s.userData.includeBg&&s.addTexture(a.preloadedTexture),s&&l&&(m||i.passIndex>0)?(e.isMask&&(!i.length||x&&w)&&s.addTexture(a.preloadedTexture),s.createTexture({sampler:"uTexture",premultipliedAlpha:!0,fromTexture:l.getTexture()})):s&&e.isMask?(x&&w&&s.addTexture(a.preloadedTexture),l&&s.createTexture({sampler:"uTexture",premultipliedAlpha:!0,fromTexture:l.getTexture()})):s&&s.addTexture(a.preloadedTexture),e.type==="custom"&&s.createTexture({sampler:"uCustomTexture",premultipliedAlpha:!0,fromTexture:this.getRenderTargets()[t]});const E=e.texture||e.data.texture;E&&(s.userData.textureLoaded=!1,s.loadImage(E.src,{sampler:E.sampler},T=>{s.userData.textureLoaded=!0,this.curtain.render()}))}createPlanes(){this.getOrderedItems().forEach((e,t)=>{e.getPlanes().length?e.getPlanes().forEach(i=>i.setRenderOrder(t)):e.isElement?this.createElementPlane(e,t):this.createEffectPlanes(e,t)})}createEffectPlanes(e,t){const i=e.data;i.passes&&i.passes.length?(this.createEffectPlane(e,t,{index:0,length:i.passes.length+1,downSample:i.downSample}),i.passes.forEach((s,a)=>{this.createEffectPlane(e,t,{index:a+1,length:i.passes.length+1,downSample:s.downSample,[s.prop]:s.value,includeBg:s.includeBg})})):(this.createEffectPlane(e,t),e.type==="mouse"&&this.createPingPongPlane(e,t))}createTextures(){const e=this.getPlanes().filter(i=>i.visible).sort((i,s)=>i.renderOrder-s.renderOrder),t=e.length;for(let i=0;i<t;i++){const s=e[i];let a=this.layers.find(l=>l.local.id===s.userData.id);i<t-1&&this.assignRenderTargetToPlane(e,i,a,s),this.handleTextures(a,i,s.userData)}}assignRenderTargetToPlane(e,t,i,s){let a=this.getTextureParams(e,t,i),l=this.getRenderTargets()[t]||new ut(this.curtain,a);l.userData.id=s.userData.id,s.setRenderTarget(l)}handleTextures(e,t,i){e.isElement?this.handleElementPlane(e,t):e.parentLayer?this.handleChildEffectPlane(e,t,i):this.handleEffectPlane(e,t,i)}handleItemPlanes(e){this.createPlanes(),this.createTextures(),this.checkIfReady(e)}isNotReady(e){const t=this.layers.find(u=>u.local.id===e.userData.id),i=t.layerType==="image"&&!t.local.loaded,s=t.layerType==="text"&&!t.local.loaded,a="textureLoaded"in e.userData&&!e.userData.textureLoaded;return(this.split?i||s||a:!1)||!e.userData.isReady}checkIfReady(e){const t=()=>{this.curtain.planes.filter(i=>this.isNotReady(i)).length?(this.curtain.render(),requestAnimationFrame(t)):e()};t()}setInitialEffectPlaneUniforms(e,t,i,s){if(!e.userData.initialUniformsSet||!e.userData.isReady){for(let a in e.uniforms)a in t&&(e.uniforms[a].value=t[a]);i&&s&&s.index<s.length-1&&e.uniforms.isMask&&(e.uniforms.isMask.value=0),t.states&&t.states.appear.length&&t.states.appear.forEach(a=>{e.uniforms[a.prop]&&a.initializeState(e.uniforms[a.prop],t[a.prop])}),i&&t.isMask&&(t.mouseMomentum=i.mouseMomentum),e.userData.initialUniformsSet=!0}}handleStateEffects(e,t){if(this.isInView&&!e.userData.createdAt&&(e.userData.createdAt=performance.now()),!t.states||![...t.states.appear,...t.states.scroll].length)return!1;t.states.appear.forEach(i=>{i.updateEffect(e)}),t.states.scroll.forEach(i=>{let s=this.element.getBoundingClientRect();i.updateEffect(e,t[i.prop],{top:s.top,height:s.height})})}setElementPlaneUniforms(e,t){let i=this.element.offsetWidth*.5,s=this.element.offsetHeight*.5;if(e.uniforms.mousePos){let a=this.mouse.pos.x,l=this.mouse.pos.y,u=a/i,p=1-l/s;if(t.mouseMomentum&&t.type!=="mouse"){t.local.lastMousePos||(t.local.lastMousePos={x:u,y:p});let m=t.local.lastMousePos.x*i,x=(1-t.local.lastMousePos.y)*s;a=Ge(a,m,t.mouseMomentum*2),l=Ge(l,x,t.mouseMomentum*2),t.local.lastMousePos.x=a/i,t.local.lastMousePos.y=1-l/s}e.uniforms.mousePos.value.x=a/i,e.uniforms.mousePos.value.y=1-l/s}e.uniforms.resolution.value.x=this.curtain.canvas.width,e.uniforms.resolution.value.y=this.curtain.canvas.height,e.uniforms.sampleBg&&(e.renderOrder===0?e.uniforms.sampleBg.value=0:e.uniforms.sampleBg.value=1),!e.userData.isReady&&!t.compiledFragmentShaders.length&&(e.uniforms.opacity.value=t.visible?t.opacity:0,e.uniforms.trackMouse.value=t.trackMouse||0,e.uniforms.displace&&(e.uniforms.displace.value=t.displace,e.uniforms.bgDisplace.value=t.bgDisplace,e.uniforms.dispersion.value=t.dispersion),e.uniforms.blendMode&&(e.uniforms.blendMode.value=Object.keys(ji).indexOf(t.blendMode)),e.uniforms.mask&&"mask"in t&&(e.uniforms.mask.value=t.mask,e.uniforms.maskAlpha.value=t.maskAlpha||0,e.uniforms.maskBackground.value.x=t.maskBackground.x,e.uniforms.maskBackground.value.y=t.maskBackground.y,e.uniforms.maskBackground.value.z=t.maskBackground.z))}setEffectPlaneUniforms(e,t){t.animating&&e.uniforms.time&&(e.uniforms.time.value+=(t.speed||1)*60/this.fps),this.handleStateEffects(e,t);let i=this.bbox.width/2,s=this.bbox.height/2;if(e.uniforms.mousePos){let a=this.mouse.pos.x,l=this.mouse.pos.y;if(t.mouseMomentum&&t.type!=="mouse"){t.local.lastMousePos||(t.local.lastMousePos={x:a/i,y:1-l/s});let u=t.local.lastMousePos.x*i,p=(1-t.local.lastMousePos.y)*s;a=Ge(a,u,t.mouseMomentum*2),l=Ge(l,p,t.mouseMomentum*2),t.local.lastMousePos.x=a/i,t.local.lastMousePos.y=1-l/s}e.uniforms.mousePos.value.x=a/i,e.uniforms.mousePos.value.y=1-l/s}e.uniforms.previousMousePos&&(this.mouse.trail.length>2?(e.uniforms.previousMousePos.value.x=this.mouse.trail.at(2)[0],e.uniforms.previousMousePos.value.y=this.mouse.trail.at(2)[1]):(e.uniforms.previousMousePos.value.x=e.uniforms.mousePos.value.x,e.uniforms.previousMousePos.value.y=e.uniforms.mousePos.value.y)),e.uniforms.resolution.value.x=this.curtain.canvas.width,e.uniforms.resolution.value.y=this.curtain.canvas.height}getOrderedItems(){let e=[];return this.layers.filter(t=>!t.parentLayer&&t.visible).forEach(t=>{t.effects&&t.effects.length&&e.push(...t.getChildEffectItems()),e.push(t)}),e}getTextureParams(e,t,i){var u;const a=e[t].userData.downSample?.5:1,l={maxWidth:this.curtain.canvas.width,maxHeight:this.curtain.canvas.height,depth:((u=i==null?void 0:i.data)==null?void 0:u.depth)||(i==null?void 0:i.type)==="bulge"};return a&&(l.maxWidth=this.canvasWidth*a,l.maxHeight=this.canvasHeight*a),l}cloneCanvas(e){const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const i=t.getContext("2d"),s=this.scale;return i.scale(s,s),i.drawImage(e,0,0),t}handlePlaneCreation(){this.layers.filter(e=>e.isElement).forEach(e=>{e.render(),e.getPlane()&&e.getPlane().textures.filter(t=>t.sourceType==="canvas").forEach(t=>{t.needUpdate(),t.shouldUpdate=!1})}),this.initialized=!0,this.initializing=!1,this.rendering||(this.fullRedraw(),this.renderNFrames(2)),this.removePlanes(),this.curtain.setPixelRatio(Math.min(Math.min(this.dpi||1.5,2),this.dpi)),gt()}async removePlanes(){const e=this.getSplitOrderedItems();e.dynamic.length||e.static.pop();for(const t of e.static){const i=t.layerType==="text"&&!t.local.loaded,s=t.layerType==="image"&&!t.local.fullyLoaded;(i||s)&&await Ki(t,i?"loaded":"fullyLoaded");const a=t.getPlanes();for(const l of a)l.remove(),l.uuid,a.at(-1).uuid}}}function cs(f){return typeof HTMLElement=="object"?f instanceof HTMLElement:f&&typeof f=="object"&&f!==null&&f.nodeType===1&&typeof f.nodeName=="string"}function us(){window.addEventListener("mousemove",Nt),window.addEventListener("touchmove",Nt),window.addEventListener("scroll",ls),window.addEventListener("routeChange",Ji),ft()||window.addEventListener("resize",Xi(hs,100)),document.addEventListener($e,ns,!1)}function fs(f,e,t){return De([f.offsetWidth,f.offsetHeight]),{canvasWidth:f.offsetWidth*t,canvasHeight:f.offsetHeight*t,scale:e,dpi:t,element:f}}function gs(){de.forEach(f=>{f.destroy()}),de.length=0}function ps(f,e,t,i,s){let a;if(t){if(a=t,document.getElementById(t)){let l=JSON.parse(document.getElementById(t).innerText);if(l.options&&l.history)return l;i(new Error(`Did not find valid JSON inside ${t}`))}}else{let l="https://storage.googleapis.com/unicornstudio-production";(s||e!=null&&e.includes("production=true"))&&(l="https://assets.unicorn.studio",e=`v=${Date.now()}`),a=`${l}/embeds/${f}${e?"?"+e:""}`}return fetch(a).then(l=>l.json()).then(l=>l).catch(l=>console.error("Error fetching data:",l))}let mt;function ms(){mt||(mt=new IntersectionObserver(f=>{f.forEach(e=>{const t=e.target.getAttribute("data-scene-id"),i=de.find(s=>s.id===t);i&&(e.isIntersecting?(i.isInView=!0,i.lazyLoad&&!i.initialized&&!i.initializing&&i.initializePlanes()):i.isInView=!1)})},{threshold:.001}))}function Wt(f){ms();let e=f.projectId?f.projectId.split("?")[0]:null,t=f.projectId?f.projectId.split("?")[1]:null;return new Promise((i,s)=>{ps(e,t,f.filePath,s,f.production).then(a=>{const l=a.options||{},u=cs(f.element)?f.element:document.getElementById(f.elementId);if(!u){s(new Error(`Couldn't find an element with id '${f.elementId}' on the page.`));return}const p=kt();u.setAttribute("data-scene-id",p);const m=qi(a.history,p,fs(u,f.scale||l.scale||1,f.dpi||Math.min(1.5,window.devicePixelRatio)));Zi(m.filter(w=>w.layerType==="text"));const x=new ds({id:p,fps:f.fps||l.fps||60,dpi:f.dpi,name:l.name,projectId:e||f.filePath.split(".")[0],renderingScale:f.scale||l.scale||1,element:u,lazyLoad:f.lazyLoad,width:f.width,height:f.height});f.altText&&(x.curtain.canvas.innerText=f.altText),f.ariaLabel&&x.curtain.canvas.setAttribute("aria-label",f.ariaLabel),x.curtain.canvas.setAttribute("role","image"),(l.freePlan||l.includeLogo)&&Qi(p,u),de.push(x),x.layers=m,x.preloadTextures(),x.mouse.recordTrail=!!x.layers.find(w=>w.type=="mouse"),x.setInteractiveParams(f,l),(ft()||!x.lazyLoad)&&x.initializePlanes(),mt.observe(x.element),i(x)}).catch(a=>{console.log(a),s(a)})})}function xs(){return new Promise((f,e)=>{const t=[...document.querySelectorAll("[data-us-project]"),...document.querySelectorAll("[data-us-project-src]")];[...t].filter(i=>!i.getAttribute("data-us-initialized")).forEach((i,s)=>{const a=i.getAttribute("data-us-project"),l=i.getAttribute("data-us-project-src"),u=i.getAttribute("data-us-dpi"),p=i.getAttribute("data-us-scale"),m=i.getAttribute("data-us-lazyload"),x=i.getAttribute("data-us-production"),w=i.getAttribute("data-us-fps"),E=i.getAttribute("data-us-altText")||i.getAttribute("data-us-alttext"),T=i.getAttribute("data-us-ariaLabel")||i.getAttribute("data-us-arialabel"),F=i.getAttribute("data-us-disableMobile")||i.getAttribute("data-us-disablemobile");i.setAttribute("data-us-initialized",!0),Wt({projectId:a,filePath:l,element:i,dpi:+u,scale:+p,production:x,fps:+w,lazyLoad:m,altText:E,ariaLabel:T,interactivity:F?{mouse:{disableMobile:!0}}:null}).then(L=>{s===t.length-1&&f(de)})})})}us(),ce.addScene=Wt,ce.destroy=gs,ce.init=xs,Object.defineProperty(ce,Symbol.toStringTag,{value:"Module"})});
